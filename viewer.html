<!DOCTYPE html>
<html>
    <head>
        <title>$3Dmol</title>
        <script src="build/3Dmol.js"></script>
        <style>
        	* {margin:0; padding:0}
        </style>
        <script>
            var glviewer = null;
            //http://localhost/$3Dmol/viewer.html?pdb=1ycr&style=cartoon&addstyle=line&select=chain~A&colorbyelement=whiteCarbon&style=surface,opacity~.8&select=chain~B&addstyle=stick&select=chain~B,resn~TRP&style=sphere
            
            
            //Process commands, in order, and run on viewer (array of strings split on '&')
            var runcmds = function(cmds, viewer) {
                
                var currentsel = {};
                
                for (var i = 0; i < cmds.length; i++) {
                	var kv = cmds[i].split('=');
                	var cmdname = kv[0];
                	var cmdobj = $3Dmol.specStringToObject(kv[1]);
                    
                    if (cmdname == 'select')
                        currentsel = cmdobj;
                    else if(cmdname == 'surface') {
                    	viewer.addSurface($3Dmol.SurfaceType.VDW, cmdobj, currentsel, currentsel);
                    }
                    else if(cmdname == 'style') {
                    	viewer.setStyle(currentsel,cmdobj);
                    }
                    else if(cmdname == 'addstyle') {
                    	viewer.addStyle(currentsel, cmdobj);
                    }
                    else if(cmdname == 'colorbyelement')
                    {
                    	if(typeof($3Dmol.elementColors[cmdobj]) != "undefined")
                    	    viewer.setColorByElement(currentsel, $3Dmol.elementColors[cmdobj]);	
                    }
                    
                }
                
            };

            $(document).ready(function() {
                
                try {
                    var url = window.location.search.substr(1);
                    var cmds = url.split("&");
                    var first = cmds.splice(0,1)[0];
                    var pos = first.indexOf('=');
                    var src = first.substring(0,pos), data = first.substring(pos+1);
                    var type = "pdb";
                    
                    glviewer = $3Dmol.createViewer("gldiv", {defaultcolors: $3Dmol.rasmolElementColors});                    
                    glviewer.setBackgroundColor(0xffffff);
                    
                    if (src == 'pdb') {
                        data = data.toUpperCase();
                        if (!data.match(/^[1-9][A-Za-z0-9]{3}$/)) {
                           alert("Wrong PDB ID"); return;
                        }
                        data = "http://www.pdb.org/pdb/files/" + data + ".pdb";  
                        type = "pdb";
                    }  
                    else if(src == 'cid') {
                    	type = "sdf";
                        data = "http://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/" + data + 
                        "/SDF?record_type=3d";
                    }
                    else { //url
                    	//try to extract 3 character extension
                    	type = data.substr(data.lastIndexOf('.')+1).substring(0,3);
                    }
                    if(cmds[0] && cmds[0].indexOf('type=') == 0) {
                    	type = cmds[0].split('=')[1];
                    }
                        
                    $.post("echo.cgi", {'url': data}, function(ret, txt, response) {
                    	
                        glviewer.addModel(ret, type);     
                        runcmds(cmds, glviewer);
                        glviewer.render();
                        glviewer.zoomTo();
                    });
                                
                }
                
                catch (e) {
                    console.error("Could not instantiate viewer from supplied url: '" + e + "'");
                }

                
            });
        </script>
    </head>    
    <body>
         <div id='gldiv' style="width: 100%; height: 100vh;"></div>       
    </body>    
</html>
