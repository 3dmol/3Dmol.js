<!DOCTYPE html>
<html>
    <head>
        <title>WebMol</title>
        <script src="build/webmol.js"></script>
        
        <script>
            var glviewer = null;
            
            //Return a selection specification from an array of 'key~val' string pairs (split on ',')
            var extractselectors = function(cmdarr) {
                
                if (typeof(cmdarr) === "string") {
                    if (!!parseInt(cmdarr))
                        return parseInt(cmdarr);
                    
                    if (cmdarr == "true" || cmdarr == "false")
                        return (cmdarr == "true");
                    
                    return cmdarr;
                }
                    
                
                var selectionspec = {};
                
                for (var i = 0; i < cmdarr.length; i++) {
                    var k = cmdarr[i].split('~')[0], v = cmdarr[i].split('~')[1];
                    
                    if (!v) 
                        console.error("error parsing " + cmdarr[i] + "; no value specified");
                    
                    selectionspec[k] = extractselectors(v);
                }
                
                return selectionspec;
            };
            
            //Process commands, in order, and run on viewer (array of strings split on '&')
            var runcmds = function(cmds, viewer) {
                
                var currentsel = {};
                
                for (var i = 0; i < cmds.length; i++) {
                    var cmdname = cmds[i].split('=')[0], cmdarr = cmds[i].split('=')[1].split(',');
                    
                    if (cmdname == 'select')
                        currentsel = extractselectors(cmdarr);
                    
                    else if (cmdname == 'style') {
                        
                        var styletype;
                        
                        if (!(cmdarr[0] == 'line' || cmdarr[0] == 'stick' || cmdarr[0] == 'cross' || cmdarr[0] == 'sphere' || cmdarr[0] == 'cartoon'))
                            styletype = 'line'; //Default to line style
                        else
                            styletype = cmdarr.splice(0,1)[0];
                            
                        var stylespec = extractselectors(cmdarr);
                        var styleobj = {}; 
                        styleobj[styletype] = stylespec;
                        viewer.setStyle(currentsel, styleobj);
                    }
                    
                }
                
            };

            $(document).ready(function() {
                
                try {
                    var url = window.location.search.substr(1);
                    var cmds = url.split("&");
                    var loc = cmds.splice(0,1)[0].split("=");
                    var src = loc[0], data = loc[1];
                    
                    glviewer = WebMol.createViewer("gldiv", {defaultcolors: WebMol.rasmolElementColors});                    
                    glviewer.setBackgroundColor(0xffffff);
                    
                    if (src == 'pdb') {
                        data = data.toUpperCase();
                        if (!data.match(/^[1-9][A-Za-z0-9]{3}$/)) {
                           alert("Wrong PDB ID"); return;
                        }
                        data = "http://www.pdb.org/pdb/files/" + data + ".pdb";                       
                    }  
                        
                    $.get(data, function(ret) {
                        var type = data.substr(-5).split('.')[1];
                        glviewer.addModel(ret, type);     
                        runcmds(cmds, glviewer);
                        glviewer.render();
                        glviewer.zoomTo();
                    });
                                
                }
                
                catch (e) {
                    console.error("Could not instantiate viewer from supplied url: '" + e + "'");
                }

                
            });
        </script>
    </head>    
    <body>
         <div id='gldiv' style="width: 100%; height: 800px; border: 2px solid black; "></div>       
    </body>    
</html>
