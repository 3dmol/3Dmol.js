var WebMol={createViewer:function(element,config){if("string"===$.type(element)&&(element=$("#"+element)),element){config=config||{},config.order||(config.order=["glmol","jmol"]),config.defaultcolors||(config.defaultcolors=WebMol.defaultElementColors);for(var i=0;i<config.order.length;i++){var kind=config.order[i],fname=kind+"Viewer";if("function"==typeof this[fname])try{return new this[fname](element,config.callback,config.defaultcolors)}catch(e){console.log("error with "+kind+":"+e)}}return alert("Unable to instantiate webmol viewer: "+config.order),null}},download:function(query,viewer){var type="",m=null;if("pdb:"===query.substr(0,4)){if(type="pdb",query=query.substr(4).toUpperCase(),!query.match(/^[1-9][A-Za-z0-9]{3}$/))return void alert("Wrong PDB ID");uri="http://www.pdb.org/pdb/files/"+query+".pdb"}else if("cid:"==query.substr(0,4)){if(type="sdf",query=query.substr(4),!query.match(/^[1-9]+$/))return void alert("Wrong Compound ID");uri="http://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/"+query+"/SDF?record_type=3d"}return $.get(uri,function(ret){viewer.addModel(ret,type),viewer.zoomTo(),viewer.render()}),m}};WebMol.SurfaceType={VDW:1,MS:2,SAS:3,SES:4},WebMol.CC={cache:{},color:function(hex){if("undefined"!=typeof this.cache[hex])return this.cache[hex];var c=new WebMol.Color(hex);return this.cache[hex]=c,c}},WebMol.Color=function(color){return arguments.length>1?(this.r=arguments[0]||0,this.g=arguments[1]||0,this.b=arguments[2]||0,this):this.set(color)},WebMol.Color.prototype={constructor:WebMol.Color,r:0,g:0,b:0,set:function(val){return val instanceof WebMol.Color?val.clone():void("number"==typeof val&&this.setHex(val))},setHex:function(hex){return hex=Math.floor(hex),this.r=(hex>>16&255)/255,this.g=(hex>>8&255)/255,this.b=(255&hex)/255,this},clone:function(){return new WebMol.Color(this.r,this.g,this.b)},copy:function(color){return this.r=color.r,this.g=color.g,this.b=color.b,this}},WebMol.mergeGeos=function(geometry,mesh){var meshGeo=mesh.geometry;void 0!==meshGeo&&geometry.geometryGroups.push(meshGeo.geometryGroups[0])},WebMol.multiLineString=function(f){return f.toString().replace(/^[^\/]+\/\*!?/,"").replace(/\*\/[^\/]+$/,"")},WebMol.FrontSide=0,WebMol.BackSide=1,WebMol.DoubleSide=2,WebMol.NoBlending=0,WebMol.NormalBlending=1,WebMol.AdditiveBlending=2,WebMol.SubtractiveBlending=3,WebMol.MultiplyBlending=4,WebMol.CustomBlending=5,WebMol.NoShading=0,WebMol.FlatShading=1,WebMol.SmoothShading=2,WebMol.NoColors=0,WebMol.FaceColors=1,WebMol.VertexColors=2,WebMol.MultiplyOperation=0,WebMol.MixOperation=1,WebMol.AddOperation=2,WebMol.UVMapping=function(){},WebMol.ClampToEdgeWrapping=1001,WebMol.LinearFilter=1006,WebMol.LinearMipMapLinearFilter=1008,WebMol.UnsignedByteType=1009,WebMol.RGBAFormat=1021;var WebMol=WebMol||{};WebMol.Math={clamp:function(x,min,max){return Math.min(Math.max(x,min),max)},degToRad:function(){var degreeToRadiansFactor=Math.PI/180;return function(deg){return deg*degreeToRadiansFactor}}()},WebMol.Quaternion=function(x,y,z,w){this.x=x||0,this.y=y||0,this.z=z||0,this.w=void 0!==w?w:1},WebMol.Quaternion.prototype={constructor:WebMol.Quaternion,set:function(x,y,z,w){return this.x=x,this.y=y,this.z=z,this.w=w,this},copy:function(q){return this.x=q.x,this.y=q.y,this.z=q.z,this.w=q.w,this},conjugate:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},inverse:function(){return this.conjugate().normalize()},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var l=this.length();return 0===l?(this.x=0,this.y=0,this.z=0,this.w=1):(l=1/l,this.x*=l,this.y*=l,this.z*=l,this.w*=l),this},multiply:function(q){return this.multiplyQuaternions(this,q)},multiplyQuaternions:function(a,b){var qax=a.x,qay=a.y,qaz=a.z,qaw=a.w,qbx=b.x,qby=b.y,qbz=b.z,qbw=b.w;this.x=qax*qbw+qaw*qbx+qay*qbz-qaz*qby,this.y=qay*qbw+qaw*qby+qaz*qbx-qax*qbz,this.z=qaz*qbw+qaw*qbz+qax*qby-qay*qbx,this.w=qaw*qbw-qax*qbx-qay*qby-qaz*qbz}},WebMol.Vector2=function(x,y){this.x=x||0,this.y=y||0},WebMol.Vector2.prototype={constructor:WebMol.Vector2,set:function(x,y){return this.x=x,this.y=y,this},subVectors:function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this},copy:function(v){return this.x=v.x,this.y=v.y,this},clone:function(){return new WebMol.Vector2(this.x,this.y)}},WebMol.Vector3=function(x,y,z){this.x=x||0,this.y=y||0,this.z=z||0},WebMol.Vector3.prototype={constructor:WebMol.Vector3,set:function(x,y,z){return this.x=x,this.y=y,this.z=z,this},copy:function(v){return this.x=v.x,this.y=v.y,this.z=v.z,this},add:function(v){return this.x+=v.x,this.y+=v.y,this.z+=v.z,this},addVectors:function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this},sub:function(v){return this.x-=v.x,this.y-=v.y,this.z-=v.z,this},subVectors:function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this},multiplyScalar:function(s){return this.x*=s,this.y*=s,this.z*=s,this},divideScalar:function(s){return 0!==s?(this.x/=s,this.y/=s,this.z/=s):(this.x=0,this.y=0,this.z=0),this},distanceTo:function(v){return Math.sqrt(this.distanceToSquared(v))},distanceToSquared:function(v){var dx=this.x-v.x,dy=this.y-v.y,dz=this.z-v.z;return dx*dx+dy*dy+dz*dz},applyMatrix4:function(m){var x=this.x,y=this.y,z=this.z,e=m.elements;return this.x=e[0]*x+e[4]*y+e[8]*z+e[12],this.y=e[1]*x+e[5]*y+e[9]*z+e[13],this.z=e[2]*x+e[6]*y+e[10]*z+e[14],this},applyProjection:function(m){var x=this.x,y=this.y,z=this.z,e=m.elements,d=e[3]*x+e[7]*y+e[11]*z+e[15];return this.x=(e[0]*x+e[4]*y+e[8]*z+e[12])/d,this.y=(e[1]*x+e[5]*y+e[9]*z+e[13])/d,this.z=(e[2]*x+e[6]*y+e[10]*z+e[14])/d,this},applyQuaternion:function(q){var x=this.x,y=this.y,z=this.z,qx=q.x,qy=q.y,qz=q.z,qw=q.w,ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qw*x-qy*y-qz*z;return this.x=ix*qw+iw*-qx+iy*-qz-iz*-qy,this.y=iy*qw+iw*-qy+iz*-qx-ix*-qz,this.z=iz*qw+iw*-qz+ix*-qy-iy*-qx,this},negate:function(){return this.multiplyScalar(-1)},dot:function(v){return this.x*v.x+this.y*v.y+this.z*v.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},normalize:function(){return this.divideScalar(this.length())},cross:function(v){var x=this.x,y=this.y,z=this.z;return this.x=y*v.z-z*v.y,this.y=z*v.x-x*v.z,this.z=x*v.y-y*v.x,this},crossVectors:function(a,b){return this.x=a.y*b.z-a.z*b.y,this.y=a.z*b.x-a.x*b.z,this.z=a.x*b.y-a.y*b.x,this},getPositionFromMatrix:function(m){return this.x=m.elements[12],this.y=m.elements[13],this.z=m.elements[14],this},setEulerFromRotationMatrix:function(m,order){var te=m.elements,m11=te[0],m12=te[4],m13=te[8],m22=(te[1],te[5]),m23=te[9],m32=(te[2],te[6]),m33=te[10];return void 0===order||"XYZ"===order?(this.y=Math.asin(WebMol.Math.clamp(m13,-1,1)),Math.abs(m13)<.99999?(this.x=Math.atan2(-m23,m33),this.z=Math.atan2(-m12,m11)):(this.x=Math.atan2(m32,m22),this.z=0)):console.error("Error with vector's setEulerFromRotationMatrix: Unknown order: "+order),this},clone:function(){return new WebMol.Vector3(this.x,this.y,this.z)}},WebMol.Matrix3=function(n11,n12,n13,n21,n22,n23,n31,n32,n33){this.elements=new Float32Array(9),this.set(void 0!==n11?n11:1,n12||0,n13||0,n21||0,void 0!==n22?n22:1,n23||0,n31||0,n32||0,void 0!==n33?n33:1)},WebMol.Matrix3.prototype={constructor:WebMol.Matrix3,set:function(n11,n12,n13,n21,n22,n23,n31,n32,n33){var te=this.elements;return te[0]=n11,te[3]=n12,te[6]=n13,te[1]=n21,te[4]=n22,te[7]=n23,te[2]=n31,te[5]=n32,te[8]=n33,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},copy:function(m){var me=m.elements;this.set(me[0],me[3],me[6],me[1],me[4],me[7],me[2],me[5],me[8])},multiplyScalar:function(s){var te=this.elements;return te[0]*=s,te[3]*=s,te[6]*=s,te[1]*=s,te[4]*=s,te[7]*=s,te[2]*=s,te[5]*=s,te[8]*=s,this},getInverse:function(matrix,throwOnInvertible){var me=matrix.elements,te=this.elements;te[0]=me[10]*me[5]-me[6]*me[9],te[1]=-me[10]*me[1]+me[2]*me[9],te[2]=me[6]*me[1]-me[2]*me[5],te[3]=-me[10]*me[4]+me[6]*me[8],te[4]=me[10]*me[0]-me[2]*me[8],te[5]=-me[6]*me[0]+me[2]*me[4],te[6]=me[9]*me[4]-me[5]*me[8],te[7]=-me[9]*me[0]+me[1]*me[8],te[8]=me[5]*me[0]-me[1]*me[4];var det=me[0]*te[0]+me[1]*te[3]+me[2]*te[6];if(0===det){var msg="Matrix3.getInverse(): can't invert matrix, determinant is 0";if(throwOnInvertible)throw new Error(msg);return console.warn(msg),this.identity(),this}return this.multiplyScalar(1/det),this},transpose:function(){var tmp,m=this.elements;return tmp=m[1],m[1]=m[3],m[3]=tmp,tmp=m[2],m[2]=m[6],m[6]=tmp,tmp=m[5],m[5]=m[7],m[7]=tmp,this},clone:function(){var te=this.elements;return new WebMol.Matrix3(te[0],te[3],te[6],te[1],te[4],te[7],te[2],te[5],te[8])}},WebMol.Matrix4=function(n11,n12,n13,n14,n21,n22,n23,n24,n31,n32,n33,n34,n41,n42,n43,n44){var te=this.elements=new Float32Array(16);te[0]=void 0!==n11?n11:1,te[4]=n12||0,te[8]=n13||0,te[12]=n14||0,te[1]=n21||0,te[5]=void 0!==n22?n22:1,te[9]=n23||0,te[13]=n24||0,te[2]=n31||0,te[6]=n32||0,te[10]=void 0!==n33?n33:1,te[14]=n34||0,te[3]=n41||0,te[7]=n42||0,te[11]=n43||0,te[15]=void 0!==n44?n44:1},WebMol.Matrix4.prototype={constructor:WebMol.Matrix4,set:function(n11,n12,n13,n14,n21,n22,n23,n24,n31,n32,n33,n34,n41,n42,n43,n44){var te=this.elements;return te[0]=n11,te[4]=n12,te[8]=n13,te[12]=n14,te[1]=n21,te[5]=n22,te[9]=n23,te[13]=n24,te[2]=n31,te[6]=n32,te[10]=n33,te[14]=n34,te[3]=n41,te[7]=n42,te[11]=n43,te[15]=n44,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},copy:function(m){var me=m.elements;return this.set(me[0],me[4],me[8],me[12],me[1],me[5],me[9],me[13],me[2],me[6],me[10],me[14],me[3],me[7],me[11],me[15]),this},setRotationFromEuler:function(v,order){var te=this.elements,x=v.x,y=v.y,z=v.z,a=Math.cos(x),b=Math.sin(x),c=Math.cos(y),d=Math.sin(y),e=Math.cos(z),f=Math.sin(z);if(void 0===order||"XYZ"===order){var ae=a*e,af=a*f,be=b*e,bf=b*f;te[0]=c*e,te[4]=-c*f,te[8]=d,te[1]=af+be*d,te[5]=ae-bf*d,te[9]=-b*c,te[2]=bf-ae*d,te[6]=be+af*d,te[10]=a*c}else console.error("Error with matrix4 setRotationFromEuler. Order: "+order);return this},setRotationFromQuaternion:function(q){var te=this.elements,x=q.x,y=q.y,z=q.z,w=q.w,x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;return te[0]=1-(yy+zz),te[4]=xy-wz,te[8]=xz+wy,te[1]=xy+wz,te[5]=1-(xx+zz),te[9]=yz-wx,te[2]=xz-wy,te[6]=yz+wx,te[10]=1-(xx+yy),this},lookAt:function(){var x=new WebMol.Vector3,y=new WebMol.Vector3,z=new WebMol.Vector3;return function(eye,target,up){var te=this.elements;return z.subVectors(eye,target).normalize(),0===z.length()&&(z.z=1),x.crossVectors(up,z).normalize(),0===x.length()&&(z.x+=1e-4,x.crossVectors(up,z).normalize()),y.crossVectors(z,x),te[0]=x.x,te[4]=y.x,te[8]=z.x,te[1]=x.y,te[5]=y.y,te[9]=z.y,te[2]=x.z,te[6]=y.z,te[10]=z.z,this}}(),multiplyMatrices:function(a,b){var ae=a.elements,be=b.elements,te=this.elements,a11=ae[0],a12=ae[4],a13=ae[8],a14=ae[12],a21=ae[1],a22=ae[5],a23=ae[9],a24=ae[13],a31=ae[2],a32=ae[6],a33=ae[10],a34=ae[14],a41=ae[3],a42=ae[7],a43=ae[11],a44=ae[15],b11=be[0],b12=be[4],b13=be[8],b14=be[12],b21=be[1],b22=be[5],b23=be[9],b24=be[13],b31=be[2],b32=be[6],b33=be[10],b34=be[14],b41=be[3],b42=be[7],b43=be[11],b44=be[15];return te[0]=a11*b11+a12*b21+a13*b31+a14*b41,te[4]=a11*b12+a12*b22+a13*b32+a14*b42,te[8]=a11*b13+a12*b23+a13*b33+a14*b43,te[12]=a11*b14+a12*b24+a13*b34+a14*b44,te[1]=a21*b11+a22*b21+a23*b31+a24*b41,te[5]=a21*b12+a22*b22+a23*b32+a24*b42,te[9]=a21*b13+a22*b23+a23*b33+a24*b43,te[13]=a21*b14+a22*b24+a23*b34+a24*b44,te[2]=a31*b11+a32*b21+a33*b31+a34*b41,te[6]=a31*b12+a32*b22+a33*b32+a34*b42,te[10]=a31*b13+a32*b23+a33*b33+a34*b43,te[14]=a31*b14+a32*b24+a33*b34+a34*b44,te[3]=a41*b11+a42*b21+a43*b31+a44*b41,te[7]=a41*b12+a42*b22+a43*b32+a44*b42,te[11]=a41*b13+a42*b23+a43*b33+a44*b43,te[15]=a41*b14+a42*b24+a43*b34+a44*b44,this},multiplyScalar:function(s){var te=this.elements;return te[0]*=s,te[4]*=s,te[8]*=s,te[12]*=s,te[1]*=s,te[5]*=s,te[9]*=s,te[13]*=s,te[2]*=s,te[6]*=s,te[10]*=s,te[14]*=s,te[3]*=s,te[7]*=s,te[11]*=s,te[15]*=s,this},transpose:function(){var tmp,te=this.elements;return tmp=te[1],te[1]=te[4],te[4]=tmp,tmp=te[2],te[2]=te[8],te[8]=tmp,tmp=te[6],te[6]=te[9],te[9]=tmp,tmp=te[3],te[3]=te[12],te[12]=tmp,tmp=te[7],te[7]=te[13],te[13]=tmp,tmp=te[11],te[11]=te[14],te[14]=tmp,this},getPosition:function(){var v1=new WebMol.Vector3;return function(){console.warn("DEPRECATED: Matrix4's .getPosition() has been removed. Use Vector3.getPositionFromMatrix( matrix ) instead.");var te=this.elements;return v1.set(te[12],te[13],te[14])}}(),setPosition:function(v){var te=this.elements;return te[12]=v.x,te[13]=v.y,te[14]=v.z,this},getInverse:function(m,throwOnInvertible){var te=this.elements,me=m.elements,n11=me[0],n12=me[4],n13=me[8],n14=me[12],n21=me[1],n22=me[5],n23=me[9],n24=me[13],n31=me[2],n32=me[6],n33=me[10],n34=me[14],n41=me[3],n42=me[7],n43=me[11],n44=me[15];te[0]=n23*n34*n42-n24*n33*n42+n24*n32*n43-n22*n34*n43-n23*n32*n44+n22*n33*n44,te[4]=n14*n33*n42-n13*n34*n42-n14*n32*n43+n12*n34*n43+n13*n32*n44-n12*n33*n44,te[8]=n13*n24*n42-n14*n23*n42+n14*n22*n43-n12*n24*n43-n13*n22*n44+n12*n23*n44,te[12]=n14*n23*n32-n13*n24*n32-n14*n22*n33+n12*n24*n33+n13*n22*n34-n12*n23*n34,te[1]=n24*n33*n41-n23*n34*n41-n24*n31*n43+n21*n34*n43+n23*n31*n44-n21*n33*n44,te[5]=n13*n34*n41-n14*n33*n41+n14*n31*n43-n11*n34*n43-n13*n31*n44+n11*n33*n44,te[9]=n14*n23*n41-n13*n24*n41-n14*n21*n43+n11*n24*n43+n13*n21*n44-n11*n23*n44,te[13]=n13*n24*n31-n14*n23*n31+n14*n21*n33-n11*n24*n33-n13*n21*n34+n11*n23*n34,te[2]=n22*n34*n41-n24*n32*n41+n24*n31*n42-n21*n34*n42-n22*n31*n44+n21*n32*n44,te[6]=n14*n32*n41-n12*n34*n41-n14*n31*n42+n11*n34*n42+n12*n31*n44-n11*n32*n44,te[10]=n12*n24*n41-n14*n22*n41+n14*n21*n42-n11*n24*n42-n12*n21*n44+n11*n22*n44,te[14]=n14*n22*n31-n12*n24*n31-n14*n21*n32+n11*n24*n32+n12*n21*n34-n11*n22*n34,te[3]=n23*n32*n41-n22*n33*n41-n23*n31*n42+n21*n33*n42+n22*n31*n43-n21*n32*n43,te[7]=n12*n33*n41-n13*n32*n41+n13*n31*n42-n11*n33*n42-n12*n31*n43+n11*n32*n43,te[11]=n13*n22*n41-n12*n23*n41-n13*n21*n42+n11*n23*n42+n12*n21*n43-n11*n22*n43,te[15]=n12*n23*n31-n13*n22*n31+n13*n21*n32-n11*n23*n32-n12*n21*n33+n11*n22*n33;var det=me[0]*te[0]+me[1]*te[4]+me[2]*te[8]+me[3]*te[12];if(0==det){var msg="Matrix4.getInverse(): can't invert matrix, determinant is 0";if(throwOnInvertible)throw new Error(msg);return console.warn(msg),this.identity(),this}return this.multiplyScalar(1/det),this},compose:function(){var mRotation=new WebMol.Matrix4,mScale=new WebMol.Matrix4;return function(translation,rotation,scale){var te=this.elements;return mRotation.identity(),mRotation.setRotationFromQuaternion(rotation),mScale.makeScale(scale.x,scale.y,scale.z),this.multiplyMatrices(mRotation,mScale),te[12]=translation.x,te[13]=translation.y,te[14]=translation.z,this}}(),decompose:function(){var x=new WebMol.Vector3,y=new WebMol.Vector3,z=new WebMol.Vector3,matrix=new WebMol.Matrix4;return function(translation,rotation,scale){var te=this.elements;return x.set(te[0],te[1],te[2]),y.set(te[4],te[5],te[6]),z.set(te[8],te[9],te[10]),translation=translation instanceof WebMol.Vector3?translation:new WebMol.Vector3,rotation=rotation instanceof WebMol.Quaternion?rotation:new WebMol.Quaternion,scale=scale instanceof Webmol.Vector3?scale:new WebMol.Vector3,scale.x=x.length(),scale.y=y.length(),scale.z=z.length(),translation.x=te[12],translation.y=te[13],translation.z=te[14],matrix.copy(this),matrix.elements[0]/=scale.x,matrix.elements[1]/=scale.x,matrix.elements[2]/=scale.x,matrix.elements[4]/=scale.y,matrix.elements[5]/=scale.y,matrix.elements[6]/=scale.y,matrix.elements[8]/=scale.z,matrix.elements[9]/=scale.z,matrix.elements[10]/=scale.z,rotation.setFromRotationMatrix(matrix),[translation,rotation,scale]}}(),scale:function(v){var te=this.elements,x=v.x,y=v.y,z=v.z;return te[0]*=x,te[4]*=y,te[8]*=z,te[1]*=x,te[5]*=y,te[9]*=z,te[2]*=x,te[6]*=y,te[10]*=z,te[3]*=x,te[7]*=y,te[11]*=z,this},getMaxScaleOnAxis:function(){var te=this.elements,scaleXSq=te[0]*te[0]+te[1]*te[1]+te[2]*te[2],scaleYSq=te[4]*te[4]+te[5]*te[5]+te[6]*te[6],scaleZSq=te[8]*te[8]+te[9]*te[9]+te[10]*te[10];return Math.sqrt(Math.max(scaleXSq,Math.max(scaleYSq,scaleZSq)))},makeFrustum:function(left,right,bottom,top,near,far){var te=this.elements,x=2*near/(right-left),y=2*near/(top-bottom),a=(right+left)/(right-left),b=(top+bottom)/(top-bottom),c=-(far+near)/(far-near),d=-2*far*near/(far-near);return te[0]=x,te[4]=0,te[8]=a,te[12]=0,te[1]=0,te[5]=y,te[9]=b,te[13]=0,te[2]=0,te[6]=0,te[10]=c,te[14]=d,te[3]=0,te[7]=0,te[11]=-1,te[15]=0,this},makePerspective:function(fov,aspect,near,far){var ymax=near*Math.tan(WebMol.Math.degToRad(.5*fov)),ymin=-ymax,xmin=ymin*aspect,xmax=ymax*aspect;return this.makeFrustum(xmin,xmax,ymin,ymax,near,far)},clone:function(){var te=this.elements;return new WebMol.Matrix4(te[0],te[4],te[8],te[12],te[1],te[5],te[9],te[13],te[2],te[6],te[10],te[14],te[3],te[7],te[11],te[15])}},WebMol.Ray=function(origin,direction){this.origin=void 0!==origin?origin:new WebMol.Vector3,this.direction=void 0!==direction?direction:new WebMol.Vector3},WebMol.Ray.prototype={constructor:WebMol.Ray,set:function(origin,direction){return this.origin.copy(origin),this.direction.copy(direction),this},copy:function(ray){return this.origin.copy(ray.origin),this.direction.copy(ray.direction),this},at:function(t,optionalTarget){var result=optionalTarget||new WebMol.Vector3;return result.copy(this.direction).multiplyScalar(t).add(this.origin)},recast:function(){var v1=new WebMol.Vector3;return function(t){return this.origin.copy(this.at(t,v1)),this}}(),closestPointToPoint:function(point,optionalTarget){var result=optionalTarget||new WebMol.Vector3;result.subVectors(point,this.origin);var directionDistance=result.dot(this.direction);return result.copy(this.direction).multiplyScalar(directionDistance).add(this.origin)},distanceToPoint:function(){var v1=new WebMol.Vector3;return function(point){var directionDistance=v1.subVectors(point,this.origin).dot(this.direction);return v1.copy(this.direction).multiplyScalar(directionDistance).add(this.origin),v1.distanceTo(point)}}(),isIntersectionCylinder:function(){},isIntersectionSphere:function(sphere){return this.distanceToPoint(sphere.center)<=sphere.radius},isIntersectionPlane:function(plane){var denominator=plane.normal.dot(this.direction);return 0!=denominator?!0:0==plane.distanceToPoint(this.origin)?!0:!1},distanceToPlane:function(plane){var denominator=plane.normal.dot(this.direction);if(0==denominator)return 0==plane.distanceToPoint(this.origin)?0:void 0;var t=-(this.origin.dot(plane.normal)+plane.constant)/denominator;return t},intersectPlane:function(plane,optionalTarget){var t=this.distanceToPlane(plane);return void 0===t?void 0:this.at(t,optionalTarget)},applyMatrix4:function(matrix4){return this.direction.add(this.origin).applyMatrix4(matrix4),this.origin.applyMatrix4(matrix4),this.direction.sub(this.origin),this},equals:function(ray){return ray.origin.equals(this.origin)&&ray.direction.equals(this.direction)},clone:function(){return(new WebMol.Ray).copy(this)}};var TV3=Vector=WebMol.Vector3;WebMol.Sphere=function(center,radius){this.center=void 0!==center?center:new WebMol.Vector3,this.radius=void 0!==radius?radius:0},WebMol.Sphere.prototype={constructor:WebMol.Sphere,set:function(center,radius){return this.center.copy(center),this.radius=radius,this},copy:function(sphere){return this.center.copy(sphere.center),this.radius=sphere.radius,this},applyMatrix4:function(matrix){return this.center.applyMatrix4(matrix),this.radius=this.radius*matrix.getMaxScaleOnAxis(),this},translate:function(offset){return this.center.add(offset),this},equals:function(sphere){return sphere.center.equals(this.center)&&sphere.radius===this.radius},clone:function(){return(new WebMol.Sphere).copy(this)}},WebMol.Cylinder=function(c1,c2,radius){this.c1=void 0!==c1?c1:new WebMol.Vector3,this.c2=void 0!==c2?c2:new WebMol.Vector3,this.direction=(new WebMol.Vector3).subVectors(this.c2,this.c1).normalize(),this.radius=void 0!==radius?radius:0},WebMol.Cylinder.prototype={constructor:WebMol.Cylinder,copy:function(cylinder){return this.c1.copy(cylinder.c1),this.c2.copy(cylinder.c2),this.direction.copy(cylinder.direction),this.radius=cylinder.radius,this},lengthSq:function(){var vector=new WebMol.Vector3;return function(){return vector.subVectors(this.c2,this.c1).lengthSq()}}(),applyMatrix4:function(matrix){return this.direction.add(this.c1).applyMatrix4(matrix),this.c1.applyMatrix4(matrix),this.c2.applyMatrix4(matrix),this.direction.sub(this.c1).normalize(),this.radius=this.radius*matrix.getMaxScaleOnAxis(),this}},WebMol.Triangle=function(a,b,c){this.a=void 0!==a?a:new WebMol.Vector3,this.b=void 0!==b?b:new WebMol.Vector3,this.c=void 0!==c?c:new WebMol.Vector3},WebMol.Triangle.prototype={constructor:WebMol.Triangle,copy:function(triangle){return this.a.copy(triangle.a),this.b.copy(triangle.b),this.c.copy(triangle.c),this},applyMatrix4:function(matrix){return this.a.applyMatrix4(matrix),this.b.applyMatrix4(matrix),this.c.applyMatrix4(matrix),this},getNormal:function(){var v1=new WebMol.Vector3;return function(){var norm=this.a.clone();return norm.sub(this.b),v1.subVectors(this.c,this.b),norm.cross(v1),norm.normalize(),norm}}()};var WebMol=WebMol||{};WebMol.EventDispatcher=function(){var listeners={};this.addEventListener=function(type,listener){void 0===listeners[type]&&(listeners[type]=[]),-1===listeners[type].indexOf(listener)&&listeners[type].push(listener)},this.removeEventListener=function(type,listener){var index=listeners[type].indexOf(listener);-1!==index&&listeners[type].splice(index,1)},this.dispatchEvent=function(event){var listenerArray=listeners[event.type];if(void 0!==listenerArray){event.target=this;for(var i=0,l=listenerArray.length;l>i;i++)listenerArray[i].call(this,event)}}},WebMol.Object3D=function(){this.id=WebMol.Object3DIDCount++,this.name="",this.parent=void 0,this.children=[],this.position=new WebMol.Vector3,this.rotation=new WebMol.Vector3,this.matrix=new WebMol.Matrix4,this.matrixWorld=new WebMol.Matrix4,this.quaternion=new WebMol.Quaternion,this.eulerOrder="XYZ",this.up=new WebMol.Vector3(0,1,0),this.scale=new WebMol.Vector3(1,1,1),this.matrixAutoUpdate=!0,this.matrixWorldNeedsUpdate=!0,this.rotationAutoUpdate=!0,this.useQuaternion=!1,this.visible=!0},WebMol.Object3D.prototype={constructor:WebMol.Object3D,lookAt:function(vector){this.matrix.lookAt(vector,this.position,this.up),this.rotationAutoUpdate&&(this.useQuaternion===!0?this.quaternion.copy(this.matrix.decompose()[1]):this.rotation.setEulerFromRotationMatrix(this.matrix,this.eulerOrder))},add:function(object){if(object===this)return void console.error("Can't add WebMol.Object3D to itself");object.parent=this,this.children.push(object);for(var scene=this;void 0!==scene.parent;)scene=scene.parent;void 0!==scene&&scene instanceof WebMol.Scene&&scene.__addObject(object)},remove:function(object){var index=this.children.indexOf(object);if(-1!==index){object.parent=void 0,this.children.splice(index,1);for(var scene=this;void 0!==scene.parent;)scene=scene.parent;void 0!==scene&&scene instanceof WebMol.Scene&&scene.__removeObject(object)}},updateMatrix:function(){this.matrix.setPosition(this.position),this.useQuaternion===!1?this.matrix.setRotationFromEuler(this.rotation,this.eulerOrder):this.matrix.setRotationFromQuaternion(this.quaternion),(1!==this.scale.x||1!==this.scale.y||1!==this.scale.z)&&this.matrix.scale(this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(force){this.matrixAutoUpdate===!0&&this.updateMatrix(),(this.matrixWorldNeedsUpdate===!0||force===!0)&&(void 0===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1;for(var i in this.children)this.children[i].updateMatrixWorld(!0)},clone:function(object){void 0===object&&(object=new WebMol.Object3D),object.name=this.name,object.up.copy(this.up),object.position.copy(this.position),object.rotation.copy(this.rotation),object.eulerOrder=this.eulerOrder,object.scale.copy(this.scale),object.rotationAutoUpdate=this.rotationAutoUpdate,object.matrix.copy(this.matrix),object.matrixWorld.copy(this.matrixWorld),object.quaternion.copy(this.quaternion),object.useQuaternion=this.useQuaternion,object.visible=this.visible;for(var i in this.children){var child=this.children[i];object.add(child.clone())}return object}},WebMol.Object3DIDCount=0,WebMol.Geometry=function(){var truncateArrayBuffer=function(arr,type,end){return null===arr||void 0===arr?0===type?new Uint16Array:new Float32Array:0===type?new Uint16Array(arr.buffer.slice(arr.byteOffset,2*end)):1===type?new Float32Array(arr.buffer.slice(arr.byteOffset,4*end)):void 0},geometryGroup=function(id){this.id=id||0,this.__vertexArray=null,this.__colorArray=null,this.__normalArray=null,this.__faceArray=null,this.__lineArray=null,this.vertices=0,this.faceidx=0,this.lineidx=0};geometryGroup.prototype.getCentroid=function(){for(var offset,x,y,z,centroid=new WebMol.Vector3,i=0;i<this.vertices;++i)offset=3*i,x=this.__vertexArray[offset],y=this.__vertexArray[offset+1],z=this.__vertexArray[offset+2],centroid.x+=x,centroid.y+=y,centroid.z+=z;return centroid.divideScalar(this.vertices),centroid},geometryGroup.prototype.setNormals=function(){var faces=this.__faceArray,verts=this.__vertexArray,norms=this.__normalArray;if(this.vertices&&this.faceidx)for(var a,b,c,vA,vB,vC,norm,i=0;i<faces.length/3;++i)a=3*faces[3*i],b=3*faces[3*i+1],c=3*faces[3*i+2],vA=new WebMol.Vector3(verts[a],verts[a+1],verts[a+2]),vB=new WebMol.Vector3(verts[b],verts[b+1],verts[b+2]),vC=new WebMol.Vector3(verts[c],verts[c+1],verts[c+2]),vA.subVectors(vA,vB),vC.subVectors(vC,vB),vC.cross(vA),norm=vC,norm.normalize(),norms[a]+=norm.x,norms[b]+=norm.x,norms[c]+=norm.x,norms[a+1]+=norm.y,norms[b+1]+=norm.y,norms[c+1]+=norm.y,norms[a+2]+=norm.z,norms[b+2]+=norm.z,norms[c+2]+=norm.z},geometryGroup.prototype.setLineIndices=function(){if(this.faceidx){var faceArr=this.__faceArray,lineArr=this.__lineArray=new Uint16Array(2*this.faceidx);this.lineidx=2*this.faceidx;for(var faceoffset,i=0;i<this.faceidx/3;++i){faceoffset=3*i,lineoffset=2*faceoffset;var a=faceArr[faceoffset],b=faceArr[faceoffset+1],c=faceArr[faceoffset+2];lineArr[lineoffset]=a,lineArr[lineoffset+1]=b,lineArr[lineoffset+2]=a,lineArr[lineoffset+3]=c,lineArr[lineoffset+4]=b,lineArr[lineoffset+5]=c}}},geometryGroup.prototype.truncateArrayBuffers=function(mesh){var mesh=mesh===!0?!0:!1,vertexArr=this.__vertexArray,colorArr=this.__colorArray,normalArr=this.__normalArray,faceArr=this.__faceArray,lineArr=this.__lineArray;this.__vertexArray=truncateArrayBuffer(vertexArr,1,3*this.vertices),this.__colorArray=truncateArrayBuffer(colorArr,1,3*this.vertices),mesh?(this.__normalArray=truncateArrayBuffer(normalArr,1,3*this.vertices),this.__faceArray=truncateArrayBuffer(faceArr,0,this.faceidx),this.__lineArray=truncateArrayBuffer(lineArr,0,this.lineidx)):(this.__normalArray=truncateArrayBuffer(normalArr,1,0),this.__faceArray=truncateArrayBuffer(faceArr,0,0),this.__lineArray=truncateArrayBuffer(lineArr,0,0)),this.__inittedArrays=!0};var addGroup=function(geo){var ret=new geometryGroup(geo.geometryGroups.length);return geo.geometryGroups.push(ret),geo.groups=geo.geometryGroups.length,ret.__vertexArray=new Float32Array(196605),ret.__colorArray=new Float32Array(196605),geo.mesh&&(ret.__normalArray=new Float32Array(196605),ret.__faceArray=new Uint16Array(393210),ret.__lineArray=new Uint16Array(393210)),ret};return Geometry=function(mesh){WebMol.EventDispatcher.call(this),this.id=WebMol.GeometryIDCount++,this.name="",this.hasTangents=!1,this.dynamic=!0,this.mesh=mesh===!0?!0:!1,this.verticesNeedUpdate=!1,this.elementsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.buffersNeedUpdate=!1,this.geometryGroups=[],this.groups=0},Geometry.prototype={constructor:Geometry,updateGeoGroup:function(addVertices){addVertices=addVertices||0;var retGroup=this.groups>0?this.geometryGroups[this.groups-1]:null;return(!retGroup||retGroup.vertices+addVertices>65535)&&(retGroup=addGroup(this)),retGroup},addGeoGroup:function(){return addGroup(this)},setUpNormals:function(three){var three=three||!1;for(var g in this.geometryGroups){var geoGroup=this.geometryGroups[g];geoGroup.setNormals(three)}},setUpWireframe:function(){for(var g in this.geometryGroups){var geoGroup=this.geometryGroups[g];geoGroup.setLineIndices()}},initTypedArrays:function(){for(var g in this.geometryGroups){var group=this.geometryGroups[g];group.__inittedArrays!==!0&&group.truncateArrayBuffers(this.mesh)}},dispose:function(){this.dispatchEvent({type:"dispose"})}},Geometry}(),Object.defineProperty(WebMol.Geometry.prototype,"vertices",{get:function(){var vertices=0;for(g in this.geometryGroups)vertices+=this.geometryGroups[g].vertices;return vertices}}),WebMol.GeometryIDCount=0,WebMol.Raycaster=function(){function Raycaster(origin,direction,far,near){this.ray=new WebMol.Ray(origin,direction),this.ray.direction.lengthSq()>0&&this.ray.direction.normalize(),this.near=near||0,this.far=far||1/0}var sphere=new WebMol.Sphere,cylinder=new WebMol.Cylinder,triangle=new WebMol.Triangle,w_0=new WebMol.Vector3,v1=new WebMol.Vector3,v2=new WebMol.Vector3,v3=new WebMol.Vector3,matrixPosition=(new WebMol.Ray,new WebMol.Vector3,new WebMol.Vector3),descSort=(new WebMol.Matrix4,function(a,b){return a.distance-b.distance}),clamp=function(x){return Math.min(Math.max(x,-1),1)},intersectObject=function(group,clickable,raycaster,intersects){if(matrixPosition.getPositionFromMatrix(group.matrixWorld),clickable.clickable!==!0||void 0===clickable.intersectionShape)return intersects;var intersectionShape=clickable.intersectionShape,precision=raycaster.linePrecision;precision*=group.matrixWorld.getMaxScaleOnAxis();var precisionSq=precision*precision;if(void 0!==clickable.boundingSphere&&clickable.boundingSphere instanceof WebMol.Sphere&&(sphere.copy(clickable.boundingSphere),sphere.applyMatrix4(group.matrixWorld),!raycaster.ray.isIntersectionSphere(sphere)))return intersects;for(var i in intersectionShape.triangle)if(intersectionShape.triangle[i]instanceof WebMol.Triangle){triangle.copy(intersectionShape.triangle[i]),triangle.applyMatrix4(group.matrixWorld);var norm=triangle.getNormal(),normProj=raycaster.ray.direction.dot(norm);if(normProj>=0)continue;w_0.subVectors(triangle.a,raycaster.ray.origin);var distance=norm.dot(w_0)/normProj;if(0>distance)continue;v1.copy(raycaster.ray.direction).multiplyScalar(distance).add(raycaster.ray.origin),v1.sub(triangle.a),v2.copy(triangle.b).sub(triangle.a),v3.copy(triangle.c).sub(triangle.a);var s,t,b_dot_c=v2.dot(v3),b_sq=v2.lengthSq(),c_sq=v3.lengthSq();if(t=(b_sq*v1.dot(v3)-b_dot_c*v1.dot(v2))/(b_sq*c_sq-b_dot_c*b_dot_c),0>t||t>1)continue;if(s=(v1.dot(v2)-t*b_dot_c)/b_sq,0>s||s>1||s+t>1)continue;intersects.push({clickable:clickable,distance:distance})}for(var i in intersectionShape.cylinder)if(intersectionShape.cylinder[i]instanceof WebMol.Cylinder){cylinder.copy(intersectionShape.cylinder[i]),cylinder.applyMatrix4(group.matrixWorld),w_0.subVectors(cylinder.c1,raycaster.ray.origin);var cylProj=w_0.dot(cylinder.direction),rayProj=w_0.dot(raycaster.ray.direction),normProj=clamp(raycaster.ray.direction.dot(cylinder.direction)),denom=1-normProj*normProj;if(0===denom)continue;var s_c=(normProj*rayProj-cylProj)/denom,t_c=(rayProj-normProj*cylProj)/denom;v1.copy(cylinder.direction).multiplyScalar(s_c).add(cylinder.c1),v2.copy(raycaster.ray.direction).multiplyScalar(t_c).add(raycaster.ray.origin);var closestDistSq=v3.subVectors(v1,v2).lengthSq(),radiusSq=cylinder.radius*cylinder.radius;if(radiusSq>=closestDistSq){var distance,t,discriminant=(normProj*cylProj-rayProj)*(normProj*cylProj-rayProj)-denom*(w_0.lengthSq()-cylProj*cylProj-radiusSq);t=distance=0>=discriminant?Math.sqrt(closestDistSq):(rayProj-normProj*cylProj-Math.sqrt(discriminant))/denom;var s=normProj*t-cylProj;if(0>s||s*s>cylinder.lengthSq()||0>t)continue;intersects.push({clickable:clickable,distance:distance})}}for(var i=0,il=intersectionShape.line.length;il>i;i+=2){v1.copy(intersectionShape.line[i]),v1.applyMatrix4(group.matrixWorld),v2.copy(intersectionShape.line[i+1]),v2.applyMatrix4(group.matrixWorld),v3.subVectors(v2,v1);
var bondLengthSq=v3.lengthSq();v3.normalize(),w_0.subVectors(v1,raycaster.ray.origin);var lineProj=w_0.dot(v3),rayProj=w_0.dot(raycaster.ray.direction),normProj=clamp(raycaster.ray.direction.dot(v3)),denom=1-normProj*normProj;if(0!==denom){var s_c=(normProj*rayProj-lineProj)/denom,t_c=(rayProj-normProj*lineProj)/denom;v1.add(v3.multiplyScalar(s_c)),v2.copy(raycaster.ray.direction).multiplyScalar(t_c).add(raycaster.ray.origin);var closestDistSq=v3.subVectors(v2,v1).lengthSq();precisionSq>closestDistSq&&bondLengthSq>s_c*s_c&&intersects.push({clickable:clickable,distance:t_c})}}for(var i=0;i<intersectionShape.sphere.length;i++)if(intersectionShape.sphere[i]instanceof WebMol.Sphere&&(sphere.copy(intersectionShape.sphere[i]),sphere.applyMatrix4(group.matrixWorld),raycaster.ray.isIntersectionSphere(sphere))){var distance;v1.subVectors(sphere.center,raycaster.ray.origin);var distanceToCenter=v1.dot(raycaster.ray.direction),discriminant=distanceToCenter*distanceToCenter-(v1.lengthSq()-sphere.radius*sphere.radius);return 0>distanceToCenter?intersects:(distance=0>=discriminant?distanceToCenter:distanceToCenter-Math.sqrt(discriminant),intersects.push({clickable:clickable,distance:distance}),intersects)}};return Raycaster.prototype.precision=1e-4,Raycaster.prototype.linePrecision=.2,Raycaster.prototype.set=function(origin,direction){this.ray.set(origin,direction)},Raycaster.prototype.intersectObjects=function(group,objects){for(var intersects=[],i=0,l=objects.length;l>i;i++)intersectObject(group,objects[i],this,intersects);return intersects.sort(descSort),intersects},Raycaster}(),WebMol.Projector=function(){var _viewProjectionMatrix=(new WebMol.Matrix4,new WebMol.Matrix4);this.projectVector=function(vector,camera){return camera.matrixWorldInverse.getInverse(camera.matrixWorld),_viewProjectionMatrix.multiplyMatrices(camera.projectionMatrix,camera.matrixWorldInverse),vector.applyProjection(_viewProjectionMatrix)},this.unprojectVector=function(vector,camera){return camera.projectionMatrixInverse.getInverse(camera.projectionMatrix),_viewProjectionMatrix.multiplyMatrices(camera.matrixWorld,camera.projectionMatrixInverse),vector.applyProjection(_viewProjectionMatrix)}},WebMol.Camera=function(fov,aspect,near,far){WebMol.Object3D.call(this),this.fov=void 0!==fov?fov:50,this.aspect=void 0!==aspect?aspect:1,this.near=void 0!==near?near:.1,this.far=void 0!==far?far:2e3,this.projectionMatrix=new WebMol.Matrix4,this.projectionMatrixInverse=new WebMol.Matrix4,this.matrixWorldInverse=new WebMol.Matrix4,this.updateProjectionMatrix()},WebMol.Camera.prototype=Object.create(WebMol.Object3D.prototype),WebMol.Camera.prototype.lookAt=function(vector){this.matrix.lookAt(this.position,vector,this.up),this.rotationAutoUpdate&&(this.useQuaternion===!1?this.rotation.setEulerFromRotationMatrix(this.matrix,this.eulerOrder):this.quaternion.copy(this.matrix.decompose()[1]))},WebMol.Camera.prototype.updateProjectionMatrix=function(){this.projectionMatrix.makePerspective(this.fov,this.aspect,this.near,this.far)},WebMol.SpritePlugin=function(){function createProgram(shader,precision){var program=_gl.createProgram(),fragmentShader=_gl.createShader(_gl.FRAGMENT_SHADER),vertexShader=_gl.createShader(_gl.VERTEX_SHADER),prefix="precision "+precision+" float;\n";return _gl.shaderSource(fragmentShader,prefix+shader.fragmentShader),_gl.shaderSource(vertexShader,prefix+shader.vertexShader),_gl.compileShader(fragmentShader),_gl.compileShader(vertexShader),_gl.getShaderParameter(fragmentShader,_gl.COMPILE_STATUS)&&_gl.getShaderParameter(vertexShader,_gl.COMPILE_STATUS)?(_gl.attachShader(program,fragmentShader),_gl.attachShader(program,vertexShader),_gl.linkProgram(program),_gl.getProgramParameter(program,_gl.LINK_STATUS)||console.error("Could not initialize shader"),program):(console.error(_gl.getShaderInfoLog(fragmentShader)),console.error("could not initialize shader"),null)}function painterSortStable(a,b){return a.z!==b.z?b.z-a.z:b.id-a.id}var _gl,_renderer,_precision,_sprite={};this.init=function(renderer){_gl=renderer.context,_renderer=renderer,_precision=renderer.getPrecision(),_sprite.vertices=new Float32Array(16),_sprite.faces=new Uint16Array(6);var i=0;_sprite.vertices[i++]=-1,_sprite.vertices[i++]=-1,_sprite.vertices[i++]=0,_sprite.vertices[i++]=0,_sprite.vertices[i++]=1,_sprite.vertices[i++]=-1,_sprite.vertices[i++]=1,_sprite.vertices[i++]=0,_sprite.vertices[i++]=1,_sprite.vertices[i++]=1,_sprite.vertices[i++]=1,_sprite.vertices[i++]=1,_sprite.vertices[i++]=-1,_sprite.vertices[i++]=1,_sprite.vertices[i++]=0,_sprite.vertices[i++]=1,i=0,_sprite.faces[i++]=0,_sprite.faces[i++]=1,_sprite.faces[i++]=2,_sprite.faces[i++]=0,_sprite.faces[i++]=2,_sprite.faces[i++]=3,_sprite.vertexBuffer=_gl.createBuffer(),_sprite.elementBuffer=_gl.createBuffer(),_gl.bindBuffer(_gl.ARRAY_BUFFER,_sprite.vertexBuffer),_gl.bufferData(_gl.ARRAY_BUFFER,_sprite.vertices,_gl.STATIC_DRAW),_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,_sprite.elementBuffer),_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,_sprite.faces,_gl.STATIC_DRAW),_sprite.program=createProgram(WebMol.ShaderLib.sprite,_precision),_sprite.attributes={},_sprite.uniforms={},_sprite.attributes.position=_gl.getAttribLocation(_sprite.program,"position"),_sprite.attributes.uv=_gl.getAttribLocation(_sprite.program,"uv"),_sprite.uniforms.uvOffset=_gl.getUniformLocation(_sprite.program,"uvOffset"),_sprite.uniforms.uvScale=_gl.getUniformLocation(_sprite.program,"uvScale"),_sprite.uniforms.rotation=_gl.getUniformLocation(_sprite.program,"rotation"),_sprite.uniforms.scale=_gl.getUniformLocation(_sprite.program,"scale"),_sprite.uniforms.alignment=_gl.getUniformLocation(_sprite.program,"alignment"),_sprite.uniforms.color=_gl.getUniformLocation(_sprite.program,"color"),_sprite.uniforms.map=_gl.getUniformLocation(_sprite.program,"map"),_sprite.uniforms.opacity=_gl.getUniformLocation(_sprite.program,"opacity"),_sprite.uniforms.useScreenCoordinates=_gl.getUniformLocation(_sprite.program,"useScreenCoordinates"),_sprite.uniforms.sizeAttenuation=_gl.getUniformLocation(_sprite.program,"sizeAttenuation"),_sprite.uniforms.screenPosition=_gl.getUniformLocation(_sprite.program,"screenPosition"),_sprite.uniforms.modelViewMatrix=_gl.getUniformLocation(_sprite.program,"modelViewMatrix"),_sprite.uniforms.projectionMatrix=_gl.getUniformLocation(_sprite.program,"projectionMatrix"),_sprite.uniforms.fogType=_gl.getUniformLocation(_sprite.program,"fogType"),_sprite.uniforms.fogDensity=_gl.getUniformLocation(_sprite.program,"fogDensity"),_sprite.uniforms.fogNear=_gl.getUniformLocation(_sprite.program,"fogNear"),_sprite.uniforms.fogFar=_gl.getUniformLocation(_sprite.program,"fogFar"),_sprite.uniforms.fogColor=_gl.getUniformLocation(_sprite.program,"fogColor"),_sprite.uniforms.alphaTest=_gl.getUniformLocation(_sprite.program,"alphaTest")},this.render=function(scene,camera,viewportWidth,viewportHeight){var sprites=scene.__webglSprites,nSprites=sprites.length;if(nSprites){var attributes=_sprite.attributes,uniforms=_sprite.uniforms,invAspect=viewportHeight/viewportWidth,halfViewportWidth=.5*viewportWidth,halfViewportHeight=.5*viewportHeight;_gl.useProgram(_sprite.program),_gl.enableVertexAttribArray(attributes.position),_gl.enableVertexAttribArray(attributes.uv),_gl.disable(_gl.CULL_FACE),_gl.enable(_gl.BLEND),_gl.bindBuffer(_gl.ARRAY_BUFFER,_sprite.vertexBuffer),_gl.vertexAttribPointer(attributes.position,2,_gl.FLOAT,!1,16,0),_gl.vertexAttribPointer(attributes.uv,2,_gl.FLOAT,!1,16,8),_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,_sprite.elementBuffer),_gl.uniformMatrix4fv(uniforms.projectionMatrix,!1,camera.projectionMatrix.elements),_gl.activeTexture(_gl.TEXTURE0),_gl.uniform1i(uniforms.map,0);var oldFogType=0,sceneFogType=0,fog=scene.fog;fog?(_gl.uniform3f(uniforms.fogColor,fog.color.r,fog.color.g,fog.color.b),_gl.uniform1f(uniforms.fogNear,fog.near),_gl.uniform1f(uniforms.fogFar,fog.far),_gl.uniform1i(uniforms.fogType,1),oldFogType=1,sceneFogType=1):(_gl.uniform1i(uniforms.fogType,0),oldFogType=0,sceneFogType=0);var i,sprite,material,size,fogType,scale=[];for(i=0;nSprites>i;i++)sprite=sprites[i],material=sprite.material,sprite.visible&&0!==material.opacity&&(material.useScreenCoordinates?sprite.z=-sprite.position.z:(sprite._modelViewMatrix.multiplyMatrices(camera.matrixWorldInverse,sprite.matrixWorld),sprite.z=-sprite._modelViewMatrix.elements[14]));for(sprites.sort(painterSortStable),i=0;nSprites>i;i++)sprite=sprites[i],material=sprite.material,sprite.visible&&0!==material.opacity&&material.map&&material.map.image&&material.map.image.width&&(_gl.uniform1f(uniforms.alphaTest,material.alphaTest),material.useScreenCoordinates===!0?(_gl.uniform1i(uniforms.useScreenCoordinates,1),_gl.uniform3f(uniforms.screenPosition,(sprite.position.x*_renderer.devicePixelRatio-halfViewportWidth)/halfViewportWidth,(halfViewportHeight-sprite.position.y*_renderer.devicePixelRatio)/halfViewportHeight,Math.max(0,Math.min(1,sprite.position.z))),scale[0]=_renderer.devicePixelRatio,scale[1]=_renderer.devicePixelRatio):(_gl.uniform1i(uniforms.useScreenCoordinates,0),_gl.uniform1i(uniforms.sizeAttenuation,material.sizeAttenuation?1:0),_gl.uniformMatrix4fv(uniforms.modelViewMatrix,!1,sprite._modelViewMatrix.elements),scale[0]=1,scale[1]=1),fogType=scene.fog&&material.fog?sceneFogType:0,oldFogType!==fogType&&(_gl.uniform1i(uniforms.fogType,fogType),oldFogType=fogType),size=1/(material.scaleByViewport?viewportHeight:1),scale[0]*=size*invAspect*sprite.scale.x,scale[1]*=size*sprite.scale.y,_gl.uniform2f(uniforms.uvScale,material.uvScale.x,material.uvScale.y),_gl.uniform2f(uniforms.uvOffset,material.uvOffset.x,material.uvOffset.y),_gl.uniform2f(uniforms.alignment,material.alignment.x,material.alignment.y),_gl.uniform1f(uniforms.opacity,material.opacity),_gl.uniform3f(uniforms.color,material.color.r,material.color.g,material.color.b),_gl.uniform1f(uniforms.rotation,sprite.rotation),_gl.uniform2fv(uniforms.scale,scale),_renderer.setDepthTest(material.depthTest),_renderer.setDepthWrite(material.depthWrite),_renderer.setTexture(material.map,0),_gl.drawElements(_gl.TRIANGLES,6,_gl.UNSIGNED_SHORT,0));_gl.enable(_gl.CULL_FACE)}}},WebMol.Light=function(hex,intensity){WebMol.Object3D.call(this),this.color=new WebMol.Color(hex),this.position=new WebMol.Vector3(0,1,0),this.target=new WebMol.Object3D,this.intensity=void 0!==intensity?intensity:1,this.castShadow=!1,this.onlyShadow=!1},WebMol.Light.prototype=Object.create(WebMol.Object3D.prototype),WebMol.Material=function(){WebMol.EventDispatcher.call(this),this.id=WebMol.MaterialIdCount++,this.name="",this.side=WebMol.FrontSide,this.opacity=1,this.transparent=!1,this.blending=WebMol.NormalBlending,this.depthTest=!0,this.depthWrite=!0,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.alphaTest=0,this.visible=!0,this.needsUpdate=!0},WebMol.Material.prototype.setValues=function(values){if(void 0!==values)for(var key in values){var newValue=values[key];if(void 0!==newValue){if(key in this){var currentValue=this[key];currentValue instanceof WebMol.Color&&newValue instanceof WebMol.Color?currentValue.copy(newValue):currentValue instanceof WebMol.Color?currentValue.set(newValue):currentValue instanceof WebMol.Vector3&&newValue instanceof WebMol.Vector3?currentValue.copy(newValue):this[key]=newValue}}else console.warn("WebMol.Material: '"+key+"' parameter is undefined.")}},WebMol.Material.prototype.clone=function(material){return void 0===material&&(material=new WebMol.Material),material.name=this.name,material.side=this.side,material.opacity=this.opacity,material.transparent=this.transparent,material.blending=this.blending,material.depthTest=this.depthTest,material.depthWrite=this.depthWrite,material.polygonOffset=this.polygonOffset,material.polygonOffsetFactor=this.polygonOffsetFactor,material.polygonOffsetUnits=this.polygonOffsetUnits,material.alphaTest=this.alphaTest,material.overdraw=this.overdraw,material.visible=this.visible,material},WebMol.Material.prototype.dispose=function(){this.dispatchEvent({type:"dispose"})},WebMol.MaterialIdCount=0,WebMol.LineBasicMaterial=function(parameters){WebMol.Material.call(this),this.color=new WebMol.Color(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.vertexColors=!1,this.fog=!0,this.setValues(parameters)},WebMol.LineBasicMaterial.prototype=Object.create(WebMol.Material.prototype),WebMol.LineBasicMaterial.prototype.clone=function(){var material=new WebMol.LineBasicMaterial;WebMol.Material.prototype.clone.call(this,material),material.color.copy()},WebMol.MeshLambertMaterial=function(parameters){WebMol.Material.call(this),this.color=new WebMol.Color(16777215),this.ambient=new WebMol.Color(1048575),this.emissive=new WebMol.Color(0),this.wrapAround=!1,this.wrapRGB=new WebMol.Vector3(1,1,1),this.map=null,this.lightMap=null,this.specularMap=null,this.envMap=null,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.shading=WebMol.SmoothShading,this.vertexColors=WebMol.NoColors,this.skinning=!1,this.setValues(parameters)},WebMol.MeshLambertMaterial.prototype=Object.create(WebMol.Material.prototype),WebMol.MeshLambertMaterial.prototype.clone=function(){var material=new WebMol.MeshLambertMaterial;return WebMol.Material.prototype.clone.call(this,material),material.color.copy(this.color),material.ambient.copy(this.ambient),material.emissive.copy(this.emissive),material.wrapAround=this.wrapAround,material.wrapRGB.copy(this.wrapRGB),material.map=this.map,material.lightMap=this.lightMap,material.specularMap=this.specularMap,material.envMap=this.envMap,material.combine=this.combine,material.reflectivity=this.reflectivity,material.refractionRatio=this.refractionRatio,material.fog=this.fog,material.shading=this.shading,material.vertexColors=this.vertexColors,material.skinning=this.skinning,material.morphTargets=this.morphTargets,material.morphNormals=this.morphNormals,material},WebMol.SpriteMaterial=function(parameters){WebMol.Material.call(this),this.color=new WebMol.Color(16777215),this.map=new WebMol.Texture,this.useScreenCoordinates=!0,this.depthTest=!this.useScreenCoordinates,this.sizeAttenuation=!this.useScreenCoordinates,this.scaleByViewPort=!this.sizeAttenuation,this.alignment=WebMol.SpriteAlignment.center.clone(),this.fog=!1,this.uvOffset=new WebMol.Vector2(0,0),this.uvScale=new WebMol.Vector2(1,1),this.setValues(parameters),parameters=parameters||{},void 0===parameters.depthTest&&(this.depthTest=!this.useScreenCoordinates),void 0===parameters.sizeAttenuation&&(this.sizeAttenuation=!this.useScreenCoordinates),void 0===parameters.scaleByViewPort&&(this.scaleByViewPort=!this.sizeAttenuation)},WebMol.SpriteMaterial.prototype=Object.create(WebMol.Material.prototype),WebMol.SpriteMaterial.prototype.clone=function(){var material=new WebMol.SpriteMaterial;return WebMol.Material.prototype.clone.call(this,material),material.color.copy(this.color),material.map=this.map,material.useScreenCoordinates=useScreenCoordinates,material.sizeAttenuation=this.sizeAttenuation,material.scaleByViewport=this.scaleByViewPort,material.alignment.copy(this.alignment),material.uvOffset.copy(this.uvOffset),material},WebMol.SpriteAlignment={},WebMol.SpriteAlignment.topLeft=new WebMol.Vector2(1,-1),WebMol.SpriteAlignment.topCenter=new WebMol.Vector2(0,-1),WebMol.SpriteAlignment.topRight=new WebMol.Vector2(-1,-1),WebMol.SpriteAlignment.centerLeft=new WebMol.Vector2(1,0),WebMol.SpriteAlignment.center=new WebMol.Vector2(0,0),WebMol.SpriteAlignment.centerRight=new WebMol.Vector2(-1,0),WebMol.SpriteAlignment.bottomLeft=new WebMol.Vector2(1,1),WebMol.SpriteAlignment.bottomCenter=new WebMol.Vector2(0,1),WebMol.SpriteAlignment.bottomRight=new WebMol.Vector2(-1,1),WebMol.Texture=function(image){WebMol.EventDispatcher.call(this),this.id=WebMol.TextureIdCount++,this.name="",this.image=image,this.mipmaps=[],this.mapping=new WebMol.UVMapping,this.wrapS=WebMol.ClampToEdgeWrapping,this.wrapT=WebMol.ClampToEdgeWrapping,this.magFilter=WebMol.LinearFilter,this.minFilter=WebMol.LinearMipMapLinearFilter,this.anisotropy=1,this.format=WebMol.RGBAFormat,this.type=WebMol.UnsignedByteType,this.offset=new WebMol.Vector2(0,0),this.repeat=new WebMol.Vector2(1,1),this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.needsUpdate=!1,this.onUpdate=null},WebMol.Texture.prototype={constructor:WebMol.Texture,clone:function(texture){return void 0===texture&&(texture=new WebMol.Texture),texture.image=this.image,texture.mipmaps=this.mipmaps.slice(0),texture.mapping=this.mapping,texture.wrapS=this.wrapS,texture.wrapT=this.wrapT,texture.magFilter=this.magFilter,texture.minFilter=this.minFilter,texture.anisotropy=this.anisotropy,texture.format=this.format,texture.type=this.type,texture.offset.copy(this.offset),texture.repeat.copy(this.repeat),texture.generateMipmaps=this.generateMipmaps,texture.premultiplyAlpha=this.premultiplyAlpha,texture.flipY=this.flipY,texture.unpackAlignment=this.unpackAlignment,texture},dispose:function(){this.dispatchEvent({type:"dispose"})}},WebMol.TextureIdCount=0,WebMol.Line=function(geometry,material,type){WebMol.Object3D.call(this),this.geometry=geometry,this.material=void 0!==material?material:new WebMol.LineBasicMaterial({color:16777215*Math.random()}),this.type=void 0!==type?type:WebMol.LineStrip},WebMol.LineStrip=0,WebMol.LinePieces=1,WebMol.Line.prototype=Object.create(WebMol.Object3D.prototype),WebMol.Line.prototype.clone=function(object){return void 0===object&&(object=new WebMol.Line(this.geometry,this.material,this.type)),WebMol.Object3D.prototype.clone.call(this,object),object},WebMol.Mesh=function(geometry,material){WebMol.Object3D.call(this),this.geometry=geometry,this.material=void 0!==material?material:new WebMol.MeshBasicMaterial({color:16777215*Math.random(),wireframe:!0})},WebMol.Mesh.prototype=Object.create(WebMol.Object3D.prototype),WebMol.Mesh.prototype.clone=function(object){return void 0===object&&(object=new WebMol.Mesh(this.geometry,this.material)),WebMol.Object3D.prototype.clone.call(this,object),object},WebMol.Sprite=function(material){WebMol.Object3D.call(this),this.material=void 0!==material?material:new WebMol.SpriteMaterial,this.rotation3d=this.rotation,this.rotation=0},WebMol.Sprite.prototype=Object.create(WebMol.Object3D.prototype),WebMol.Sprite.prototype.updateMatrix=function(){this.matrix.setPosition(this.position),this.rotation3d.set(0,0,this.rotation),this.matrix.setRotationFromEuler(this.rotation3d),(1!==this.scale.x||1!==this.scale.y)&&this.matrix.scale(this.scale),this.matrixWorldNeedsUpdate=!0},WebMol.Sprite.prototype.clone=function(object){return void 0===object&&(object=new WebMol.Sprite(this.material)),WebMol.Object3D.prototype.clone.call(this,object),object},WebMol.Renderer=function(parameters){function enableAttribute(attribute){_enabledAttributes[attribute]||(_gl.enableVertexAttribArray(attribute),_enabledAttributes[attribute]=!0)}function disableAttributes(){for(var attribute in _enabledAttributes)_enabledAttributes[attribute]&&(_gl.disableVertexAttribArray(attribute),_enabledAttributes[attribute]=!1)}function setPolygonOffset(polygonOffset){_oldPolygonOffset!==polygonOffset&&(polygonOffset?_gl.enable(_gl.POLYGON_OFFSET_FILL):_gl.disable(_gl.POLYGON_OFFSET_FILL))}function setLineWidth(width){width!==_oldLineWidth&&(_gl.lineWidth(width),_oldLineWidth=width)}function getShader(type,str){var shader;return"fragment"===type?shader=_gl.createShader(_gl.FRAGMENT_SHADER):"vertex"===type&&(shader=_gl.createShader(_gl.VERTEX_SHADER)),_gl.shaderSource(shader,str),_gl.compileShader(shader),_gl.getShaderParameter(shader,_gl.COMPILE_STATUS)?shader:(console.error(_gl.getShaderInfoLog(shader)),console.error("could not initialize shader"),null)}function buildProgram(fragmentShader,vertexShader,uniforms,parameters){var p,pl,program,code,chunks=[];chunks.push(fragmentShader),chunks.push(vertexShader);for(var p in parameters)chunks.push(p),chunks.push(parameters[p]);for(code=chunks.join(),p=0,pl=_programs.length;pl>p;p++){var programInfo=_programs[p];if(programInfo.code===code)return programInfo.usedTimes++,programInfo.program}program=_gl.createProgram();var precision=_precision,prefix="precision "+precision+" float;",prefix_vertex=[prefix].join("\n"),prefix_fragment=[parameters.wireframe?"#define WIREFRAME 1":"",prefix].join("\n"),glFragmentShader=getShader("fragment",prefix_fragment+fragmentShader),glVertexShader=getShader("vertex",prefix_vertex+vertexShader);_gl.attachShader(program,glVertexShader),_gl.attachShader(program,glFragmentShader),_gl.linkProgram(program),_gl.getProgramParameter(program,_gl.LINK_STATUS)||console.error("Could not initialize shader"),program.uniforms={},program.attributes={};var identifiers,u,i;identifiers=["viewMatrix","modelViewMatrix","projectionMatrix","normalMatrix","modelMatrix","cameraPosition"];for(u in uniforms)identifiers.push(u);for(i=0;i<identifiers.length;i++){var uniformVar=identifiers[i];program.uniforms[uniformVar]=_gl.getUniformLocation(program,uniformVar)}for(identifiers=["position","normal","color","lineDistance"],i=0;i<identifiers.length;i++){var attributeVar=identifiers[i];program.attributes[attributeVar]=_gl.getAttribLocation(program,attributeVar)}return program.id=_programs_counter++,_programs.push({program:program,code:code,usedTimes:1}),_this.info.memory.programs=_programs.length,program}function setProgram(camera,lights,fog,material,object){material.needsUpdate&&(material.program&&deallocateMaterial(material),_this.initMaterial(material,lights,fog,object),material.needsUpdate=!1);var refreshMaterial=!1,program=material.program,p_uniforms=program.uniforms,m_uniforms=material.uniforms;return program!=_currentProgram&&(_gl.useProgram(program),_currentProgram=program,refreshMaterial=!0),material.id!=_currentMaterialId&&(_currentMaterialId=material.id,refreshMaterial=!0),camera!=_currentCamera&&(_currentCamera=camera,refreshMaterial=!0),refreshMaterial&&(_gl.uniformMatrix4fv(p_uniforms.projectionMatrix,!1,camera.projectionMatrix.elements),_gl.uniformMatrix4fv(p_uniforms.modelViewMatrix,!1,object._modelViewMatrix.elements),m_uniforms.fogColor.value=fog.color,m_uniforms.fogNear.value=fog.near,m_uniforms.fogFar.value=fog.far,"lambert"===material.shaderType&&(_gl.uniformMatrix4fv(p_uniforms.viewMatrix,!1,camera.matrixWorldInverse.elements),_gl.uniformMatrix3fv(p_uniforms.normalMatrix,!1,object._normalMatrix.elements),_lightsNeedUpdate&&(setupLights(program,lights),_lightsNeedUpdate=!1),m_uniforms.ambientLightColor.value=_lights.ambient,m_uniforms.directionalLightColor.value=_lights.directional.colors,m_uniforms.directionalLightDirection.value=_lights.directional.positions,m_uniforms.ambient.value=material.ambient,m_uniforms.emissive.value=material.emissive),m_uniforms.opacity.value=material.opacity,m_uniforms.diffuse.value=material.color,loadMaterialUniforms(p_uniforms,m_uniforms)),program}function loadMaterialUniforms(p_uniforms,m_uniforms){var uniformVar,type,uniformVal,uniformLoc;for(uniformVar in m_uniforms)p_uniforms[uniformVar]&&(type=m_uniforms[uniformVar].type,uniformVal=m_uniforms[uniformVar].value,uniformLoc=p_uniforms[uniformVar],"f"===type?_gl.uniform1f(uniformLoc,uniformVal):"fv"===type?_gl.uniform3fv(uniformLoc,uniformVal):"c"===type&&_gl.uniform3f(uniformLoc,uniformVal.r,uniformVal.g,uniformVal.b))}function renderObjects(renderList,reverse,materialType,camera,lights,fog,useBlending){var webglObject,object,buffer,material,start,end,delta;reverse?(start=renderList.length-1,end=-1,delta=-1):(start=0,end=renderList.length,delta=1);for(var i=start;i!==end;i+=delta)if(webglObject=renderList[i],webglObject.render){if(object=webglObject.object,buffer=webglObject.buffer,material=webglObject[materialType],!material)continue;useBlending&&_this.setBlending(material.blending),_this.setDepthTest(material.depthTest),_this.setDepthWrite(material.depthWrite),setPolygonOffset(material.polygonOffset,material.polygonOffsetFactor,material.polygonOffsetUnits),_this.setMaterialFaces(material),_this.renderBuffer(camera,lights,fog,material,buffer,object)}}function renderPlugins(plugins,scene,camera){if(_currentGeometryGroupHash=-1,_currentProgram=null,_currentCamera=null,_oldBlending=-1,_oldDepthWrite=-1,_oldDepthTest=-1,_oldDoubleSided=-1,_currentMaterialId=-1,_oldFlipSided=-1,plugins.length)for(var i=0,il=plugins.length;il>i;i++)_lightsNeedUpdate=!0,plugins[i].render(scene,camera,_currentWidth,_currentHeight),_currentGeometryGroupHash=-1,_currentProgram=null,_currentCamera=null,_oldBlending=-1,_oldDepthWrite=-1,_oldDepthTest=-1,_oldDoubleSided=-1,_currentMaterialId=-1,_oldFlipSided=-1}function addObject(object,scene){var g,geometry,material,geometryGroup;if(!object.__webglInit&&(object.__webglInit=!0,object._modelViewMatrix=new WebMol.Matrix4,object._normalMatrix=new WebMol.Matrix3,void 0!==object.geometry&&void 0===object.geometry.__webglInit&&(object.geometry.__webglInit=!0,object.geometry.addEventListener("dispose",onGeometryDispose)),object instanceof WebMol.Mesh||object instanceof WebMol.Line)){geometry=object.geometry,material=object.material;for(g in geometry.geometryGroups){var geometryGroup=geometry.geometryGroups[g];geometryGroup.id=_geometryGroupCounter++,geometryGroup.__webglVertexBuffer||(object instanceof WebMol.Mesh?(createMeshBuffers(geometryGroup),geometry.elementsNeedUpdate=!0,geometry.normalsNeedUpdate=!0):object instanceof WebMol.Line&&createLineBuffers(geometryGroup),geometry.verticesNeedUpdate=!0,geometry.colorsNeedUpdate=!0)}}if(!object.__webglActive){if(object instanceof WebMol.Mesh||object instanceof WebMol.Line){geometry=object.geometry;for(g in geometry.geometryGroups)geometryGroup=geometry.geometryGroups[g],addBuffer(scene.__webglObjects,geometryGroup,object)}else object instanceof WebMol.Sprite&&scene.__webglSprites.push(object);object.__webglActive=!0}}function updateObject(object){{var geometryGroup,geometry=object.geometry;object.material}if(object instanceof WebMol.Mesh||object instanceof WebMol.Line){for(g in geometry.geometryGroups)geometryGroup=geometry.geometryGroups[g],(geometry.verticesNeedUpdate||geometry.elementsNeedUpdate||geometry.colorsNeedUpdate||geometry.normalsNeedUpdate)&&setBuffers(geometryGroup,_gl.DYNAMIC_DRAW);geometry.verticesNeedUpdate=!1,geometry.elementsNeedUpdate=!1,geometry.normalsNeedUpdate=!1,geometry.colorsNeedUpdate=!1,geometry.buffersNeedUpdate=!1}}function removeObject(object,scene){object instanceof WebMol.Mesh||object instanceof WebMol.Line?removeInstances(scene.__webglObjects,object):object instanceof WebMol.Sprite&&removeInstancesDirect(scene.__webglSprites,object),object.__webglActive=!1}function removeInstances(objList,object){for(var o=objList.length-1;o>=0;--o)objList[o].object===object&&objList.splice(o,1)}function removeInstancesDirect(objList,object){for(var o=objList.length-1;o>=0;--o)objList[o]===object&&objList.splice(o,1)}function unrollBufferMaterial(globject){var object=globject.object,material=object.material;if(material.transparent){globject.opaque=null,globject.transparent=material;var blankMaterial=material.clone();blankMaterial.opacity=0,globject.blank=blankMaterial}else globject.opaque=material,globject.transparent=null}function setBuffers(geometryGroup,hint){var vertexArray=geometryGroup.__vertexArray,colorArray=geometryGroup.__colorArray;if(_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglVertexBuffer),_gl.bufferData(_gl.ARRAY_BUFFER,vertexArray,hint),_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglColorBuffer),_gl.bufferData(_gl.ARRAY_BUFFER,colorArray,hint),void 0!==geometryGroup.__normalArray&&void 0!==geometryGroup.__webglNormalBuffer){var normalArray=geometryGroup.__normalArray;_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglNormalBuffer),_gl.bufferData(_gl.ARRAY_BUFFER,normalArray,hint)}if(void 0!==geometryGroup.__faceArray&&void 0!==geometryGroup.__webglFaceBuffer){var faceArray=geometryGroup.__faceArray;_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geometryGroup.__webglFaceBuffer),_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,faceArray,hint)}if(void 0!==geometryGroup.__lineArray&&void 0!==geometryGroup.__webglLineBuffer){var lineArray=geometryGroup.__lineArray;_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geometryGroup.__webglLineBuffer),_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,lineArray,hint)}}function createMeshBuffers(geometryGroup){geometryGroup.__webglVertexBuffer=_gl.createBuffer(),geometryGroup.__webglNormalBuffer=_gl.createBuffer(),geometryGroup.__webglColorBuffer=_gl.createBuffer(),geometryGroup.__webglFaceBuffer=_gl.createBuffer(),geometryGroup.__webglLineBuffer=_gl.createBuffer(),_this.info.memory.geometries++}function createLineBuffers(geometry){geometry.__webglVertexBuffer=_gl.createBuffer(),geometry.__webglColorBuffer=_gl.createBuffer(),_this.info.memory.geometries++}function addBuffer(objlist,buffer,object){objlist.push({buffer:buffer,object:object,opaque:null,transparent:null})}function setupMatrices(object,camera){object._modelViewMatrix.multiplyMatrices(camera.matrixWorldInverse,object.matrixWorld),object._normalMatrix.getInverse(object._modelViewMatrix),object._normalMatrix.transpose()}function isPowerOfTwo(value){return 0===(value&value-1)}function filterFallback(){return _gl.LINEAR}function setTextureParameters(textureType,texture,isImagePowerOfTwo){isImagePowerOfTwo?(_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_S,paramToGL(texture.wrapS)),_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_T,paramToGL(texture.wrapT)),_gl.texParameteri(textureType,_gl.TEXTURE_MAG_FILTER,paramToGL(texture.magFilter)),_gl.texParameteri(textureType,_gl.TEXTURE_MIN_FILTER,paramToGL(texture.minFilter))):(_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_S,_gl.CLAMP_TO_EDGE),_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_T,_gl.CLAMP_TO_EDGE),_gl.texParameteri(textureType,_gl.TEXTURE_MAG_FILTER,filterFallback(texture.magFilter)),_gl.texParameteri(textureType,_gl.TEXTURE_MIN_FILTER,filterFallback(texture.minFilter)))}function paramToGL(p){return p===WebMol.UnsignedByteType?_gl.UNSIGNED_BYTE:p===WebMol.RGBAFormat?_gl.RGBA:0}function setupLights(program,lights){var l,ll,light,color,intensity,distance,r=0,g=0,b=0,zlights=_lights,dirColors=zlights.directional.colors,dirPositions=zlights.directional.positions,dirCount=0,dirLength=0,dirOffset=0;for(l=0,ll=lights.length;ll>l;l++)if(light=lights[l],color=light.color,intensity=light.intensity,distance=light.distance,light instanceof WebMol.Light){if(dirCount++,_direction.getPositionFromMatrix(light.matrixWorld),_vector3.getPositionFromMatrix(light.target.matrixWorld),_direction.sub(_vector3),_direction.normalize(),0===_direction.x&&0===_direction.y&&0===_direction.z)continue;dirPositions[dirOffset]=_direction.x,dirPositions[dirOffset+1]=_direction.y,dirPositions[dirOffset+2]=_direction.z,dirColors[dirOffset]=color.r*intensity,dirColors[dirOffset+1]=color.g*intensity,dirColors[dirOffset+2]=color.b*intensity,dirOffset+=3,dirLength++}zlights.ambient[0]=r,zlights.ambient[1]=g,zlights.ambient[2]=b,zlights.directional.length=dirLength}function initGL(){try{if(!(_gl=_canvas.getContext("experimental-webgl",{alpha:_alpha,premultipliedAlpha:_premultipliedAlpha,antialias:_antialias,stencil:_stencil,preserveDrawingBuffer:_preserveDrawingBuffer})))throw"Error creating WebGL context."}catch(error){console.error(error)}}function setDefaultGLState(){_gl.clearColor(0,0,0,1),_gl.clearDepth(1),_gl.clearStencil(0),_gl.enable(_gl.DEPTH_TEST),_gl.depthFunc(_gl.LEQUAL),_gl.frontFace(_gl.CCW),_gl.cullFace(_gl.BACK),_gl.enable(_gl.CULL_FACE),_gl.enable(_gl.BLEND),_gl.blendEquation(_gl.FUNC_ADD),_gl.blendFunc(_gl.SRC_ALPHA,_gl.ONE_MINUS_SRC_ALPHA),_gl.clearColor(_clearColor.r,_clearColor.g,_clearColor.b,_clearAlpha)}parameters=parameters||{};var _canvas=void 0!==parameters.canvas?parameters.canvas:document.createElement("canvas"),_precision=void 0!==parameters.precision?parameters.precision:"highp",_alpha=void 0!==parameters.alpha?parameters.alpha:!0,_premultipliedAlpha=void 0!==parameters.premultipliedAlpha?parameters.premultipliedAlpha:!0,_antialias=void 0!==parameters.antialias?parameters.antialias:!1,_stencil=void 0!==parameters.stencil?parameters.stencil:!0,_preserveDrawingBuffer=void 0!==parameters.preserveDrawingBuffer?parameters.preserveDrawingBuffer:!1,_clearColor=new WebMol.Color(void 0!==parameters.clearColor?parameters.clearColor:0),_clearAlpha=void 0!==parameters.clearAlpha?parameters.clearAlpha:0;
this.domElement=_canvas,this.context=null,this.devicePixelRatio=void 0!==parameters.devicePixelRatio?parameters.devicePixelRatio:void 0!==self.devicePixelRatio?self.devicePixelRatio:1,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.autoUpdateObjects=!0,this.autoUpdateScene=!0,this.renderPluginsPost=[],this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0}};var _gl,_this=this,_programs=[],_programs_counter=0,_currentProgram=null,_currentMaterialId=-1,_currentGeometryGroupHash=null,_currentCamera=null,_geometryGroupCounter=0,_oldDoubleSided=-1,_oldFlipSided=-1,_oldBlending=-1,_oldDepthTest=-1,_oldDepthWrite=-1,_oldPolygonOffset=null,_oldLineWidth=null,_viewportX=0,_viewportY=0,_viewportWidth=0,_viewportHeight=0,_currentWidth=0,_currentHeight=0,_enabledAttributes={},_projScreenMatrix=new WebMol.Matrix4,_vector3=new WebMol.Vector3,_direction=new WebMol.Vector3,_lightsNeedUpdate=!0,_lights={ambient:[0,0,0],directional:{length:0,colors:new Array,positions:new Array},point:{length:0,colors:new Array,positions:new Array,distances:new Array},spot:{length:0,colors:new Array,positions:new Array,distances:new Array,directions:new Array,anglesCos:new Array,exponents:new Array},hemi:{length:0,skyColors:new Array,groundColors:new Array,positions:new Array}};initGL(),setDefaultGLState(),this.context=_gl,this.getContext=function(){return _gl},this.getPrecision=function(){return _precision},this.setClearColorHex=function(hex,alpha){_clearColor.setHex(hex),_clearAlpha=alpha,_gl.clearColor(_clearColor.r,_clearColor.g,_clearColor.b,_clearAlpha)},this.setSize=function(width,height){_canvas.width=width*this.devicePixelRatio,_canvas.height=height*this.devicePixelRatio,_canvas.style.width=width+"px",_canvas.style.height=height+"px",this.setViewport(0,0,_canvas.width,_canvas.height)},this.setViewport=function(x,y,width,height){_viewportX=void 0!==x?x:0,_viewportY=void 0!==y?y:0,_viewportWidth=void 0!==width?width:_canvas.width,_viewportHeight=void 0!==height?height:_canvas.height,_gl.viewport(_viewportX,_viewportY,_viewportWidth,_viewportHeight)},this.clear=function(color,depth,stencil){var bits=0;(void 0===color||color)&&(bits|=_gl.COLOR_BUFFER_BIT),(void 0===depth||depth)&&(bits|=_gl.DEPTH_BUFFER_BIT),(void 0===stencil||stencil)&&(bits|=_gl.STENCIL_BUFFER_BIT),_gl.clear(bits)},this.clearTarget=function(renderTarget,color,depth,stencil){this.setRenderTarget(renderTarget),this.clear(color,depth,stencil)},this.setMaterialFaces=function(material){var doubleSided=material.side===WebMol.DoubleSide,flipSided=material.side===WebMol.BackSide;_oldDoubleSided!==doubleSided&&(doubleSided?_gl.disable(_gl.CULL_FACE):_gl.enable(_gl.CULL_FACE),_oldDoubleSided=doubleSided),_oldFlipSided!==flipSided&&(_gl.frontFace(flipSided?_gl.CW:_gl.CCW),_oldFlipSided=flipSided)},this.setDepthTest=function(depthTest){_oldDepthTest!==depthTest&&(depthTest?_gl.enable(_gl.DEPTH_TEST):_gl.disable(_gl.DEPTH_TEST),_oldDepthTest=depthTest)},this.setDepthWrite=function(depthWrite){_oldDepthWrite!==depthWrite&&(_gl.depthMask(depthWrite),_oldDepthWrite=depthWrite)},this.setBlending=function(blending){blending===WebMol.NoBlending?_gl.disable(_gl.BLEND):(_gl.enable(_gl.BLEND),_gl.blendEquationSeparate(_gl.FUNC_ADD,_gl.FUNC_ADD),_gl.blendFuncSeparate(_gl.SRC_ALPHA,_gl.ONE_MINUS_SRC_ALPHA,_gl.ONE,_gl.ONE_MINUS_SRC_ALPHA)),_oldBlending=blending},this.addPostPlugin=function(plugin){plugin.init(this),this.renderPluginsPost.push(plugin)};var onGeometryDispose=function(event){var geometry=event.target;geometry.removeEventListener("dispose",onGeometryDispose),deallocateGeometry(geometry),_this.info.memory.geometries--},onTextureDispose=function(event){var texture=event.target;texture.removeEventListener("dispose",onTextureDispose),deallocateTexture(texture),_this.info.memory.textures--},onMaterialDispose=function(event){var material=event.target;material.removeEventListener("dispose",onMaterialDispose),deallocateMaterial(material)},deallocateGeometry=function(geometry){if(geometry.__webglInit=void 0,void 0!==geometry.__webglVertexBuffer&&_gl.deleteBuffer(geometry.__webglVertexBuffer),void 0!==geometry.__webglColorBuffer&&_gl.deleteBuffer(geometry.__webglColorBuffer),void 0!==geometry.geometryGroups)for(var g in geometry.geometryGroups){var geometryGroup=geometry.geometryGroups[g];void 0!==geometryGroup.__webglVertexBuffer&&_gl.deleteBuffer(geometryGroup.__webglVertexBuffer),void 0!==geometryGroup.__webglColorBuffer&&_gl.deleteBuffer(geometryGroup.__webglColorBuffer),void 0!==geometryGroup.__webglNormalBuffer&&_gl.deleteBuffer(geometryGroup.__webglNormalBuffer),void 0!==geometryGroup.__webglFaceBuffer&&_gl.deleteBuffer(geometryGroup.__webglFaceBuffer),void 0!==geometryGroup.__webglLineBuffer&&_gl.deleteBuffer(geometryGroup.__webglLineBuffer)}},deallocateMaterial=function(material){var program=material.program;if(void 0!==program){material.program=void 0;var i,il,programInfo,deleteProgram=!1;for(i=0,il=_programs.length;il>i;i++)if(programInfo=_programs[i],programInfo.program===program){programInfo.usedTimes--,0===programInfo.usedTimes&&(deleteProgram=!0);break}if(deleteProgram===!0){var newPrograms=[];for(i=0,il=_programs.length;il>i;i++)programInfo=_programs[i],programInfo.program!==program&&newPrograms.push(programInfo);_programs=newPrograms,_gl.deleteProgram(program),_this.info.memory.programs--}}},deallocateTexture=function(texture){if(texture.image&&texture.image.__webglTextureCube)_gl.deleteTexture(texture.image.__webglTextureCube);else{if(!texture.__webglInit)return;texture.__webglInit=!1,_gl.deleteTexture(texture.__webglTexture)}};this.initMaterial=function(material){material.addEventListener("dispose",onMaterialDispose);var parameters,shaderID;if(material instanceof WebMol.LineBasicMaterial?shaderID="basic":material instanceof WebMol.MeshLambertMaterial&&(shaderID="lambert"),shaderID){var shader=WebMol.ShaderLib[shaderID];material.shaderType=shaderID,material.vertexShader=shader.vertexShader,material.fragmentShader=shader.fragmentShader,material.uniforms=WebMol.ShaderUtils.clone(shader.uniforms)}parameters={wireframe:material.wireframe},material.program=buildProgram(material.fragmentShader,material.vertexShader,material.uniforms,parameters)},this.renderBuffer=function(camera,lights,fog,material,geometryGroup,object){if(material.visible){var program,attributes;program=setProgram(camera,lights,fog,material,object),attributes=program.attributes;var updateBuffers=!1,wireframeBit=material.wireframe?1:0,geometryGroupHash=16777215*geometryGroup.id+2*program.id+wireframeBit;if(geometryGroupHash!==_currentGeometryGroupHash&&(_currentGeometryGroupHash=geometryGroupHash,updateBuffers=!0),updateBuffers&&(disableAttributes(),attributes.position>=0&&(_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglVertexBuffer),enableAttribute(attributes.position),_gl.vertexAttribPointer(attributes.position,3,_gl.FLOAT,!1,0,0)),attributes.color>=0&&(_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglColorBuffer),enableAttribute(attributes.color),_gl.vertexAttribPointer(attributes.color,3,_gl.FLOAT,!1,0,0)),attributes.normal>=0&&(_gl.bindBuffer(_gl.ARRAY_BUFFER,geometryGroup.__webglNormalBuffer),enableAttribute(attributes.normal),_gl.vertexAttribPointer(attributes.normal,3,_gl.FLOAT,!1,0,0))),object instanceof WebMol.Mesh){if(material.wireframe){var lineCount=geometryGroup.lineidx;setLineWidth(material.wireframeLinewidth),updateBuffers&&_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geometryGroup.__webglLineBuffer),_gl.drawElements(_gl.LINES,lineCount,_gl.UNSIGNED_SHORT,0)}else{var faceCount=geometryGroup.faceidx;updateBuffers&&_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geometryGroup.__webglFaceBuffer),_gl.drawElements(_gl.TRIANGLES,faceCount,_gl.UNSIGNED_SHORT,0)}_this.info.render.calls++,_this.info.render.vertices+=faceCount,_this.info.render.faces+=faceCount/3}else if(object instanceof WebMol.Line){var lineCount=geometryGroup.vertices;setLineWidth(material.linewidth),_gl.drawArrays(_gl.LINES,0,lineCount),_this.info.render.calls++}}},this.render=function(scene,camera,renderTarget,forceClear){if(camera instanceof WebMol.Camera==!1)return void console.error("WebMol.Renderer.render: camera is not an instance of WebMol.Camera.");var i,il,webglObject,object,renderList,lights=scene.__lights,fog=scene.fog;for(_currentMaterialId=-1,_lightsNeedUpdate=!0,this.autoUpdateScene&&scene.updateMatrixWorld(),void 0===camera.parent&&camera.updateMatrixWorld(),camera.matrixWorldInverse.getInverse(camera.matrixWorld),_projScreenMatrix.multiplyMatrices(camera.projectionMatrix,camera.matrixWorldInverse),this.autoUpdateObjects&&this.initWebGLObjects(scene),_this.info.render.calls=0,_this.info.render.vertices=0,_this.info.render.faces=0,_this.info.render.points=0,_currentWidth=_viewportWidth,_currentHeight=_viewportHeight,(this.autoClear||forceClear)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),renderList=scene.__webglObjects,i=0,il=renderList.length;il>i;i++)webglObject=renderList[i],object=webglObject.object,webglObject.render=!1,object.visible&&(setupMatrices(object,camera),unrollBufferMaterial(webglObject),webglObject.render=!0);var material=null;this.setBlending(WebMol.NoBlending),renderObjects(scene.__webglObjects,!0,"opaque",camera,lights,fog,!1,material),renderObjects(scene.__webglObjects,!0,"blank",camera,lights,fog,!0,material),renderObjects(scene.__webglObjects,!1,"transparent",camera,lights,fog,!0,material),renderPlugins(this.renderPluginsPost,scene,camera),this.setDepthTest(!0),this.setDepthWrite(!0)},this.initWebGLObjects=function(scene){if(scene.__webglObjects||(scene.__webglObjects=[],scene.__webglObjectsImmediate=[],scene.__webglSprites=[],scene.__webglFlares=[]),scene.__objectsAdded.length){for(;scene.__objectsAdded.length;)addObject(scene.__objectsAdded[0],scene),scene.__objectsAdded.splice(0,1);_currentGeometryGroupHash=-1}for(;scene.__objectsRemoved.length;)removeObject(scene.__objectsRemoved[0],scene),scene.__objectsRemoved.splice(0,1);for(var o=0,ol=scene.__webglObjects.length;ol>o;o++)updateObject(scene.__webglObjects[o].object)},this.setTexture=function(texture,slot){if(texture.needsUpdate){texture.__webglInit||(texture.__webglInit=!0,texture.addEventListener("dispose",onTextureDispose),texture.__webglTexture=_gl.createTexture(),_this.info.memory.textures++),_gl.activeTexture(_gl.TEXTURE0+slot),_gl.bindTexture(_gl.TEXTURE_2D,texture.__webglTexture),_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,texture.flipY),_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,texture.premultiplyAlpha),_gl.pixelStorei(_gl.UNPACK_ALIGNMENT,texture.unpackAlignment);var image=texture.image,isImagePowerOfTwo=isPowerOfTwo(image.width)&&isPowerOfTwo(image.height),glFormat=paramToGL(texture.format),glType=paramToGL(texture.type);setTextureParameters(_gl.TEXTURE_2D,texture,isImagePowerOfTwo);var mipmap,mipmaps=texture.mipmaps;if(mipmaps.length>0&&isImagePowerOfTwo){for(var i=0,il=mipmaps.length;il>i;i++)mipmap=mipmaps[i],_gl.texImage2D(_gl.TEXTURE_2D,i,glFormat,glFormat,glType,mipmap);texture.generateMipmaps=!1}else _gl.texImage2D(_gl.TEXTURE_2D,0,glFormat,glFormat,glType,texture.image);texture.generateMipmaps&&isImagePowerOfTwo&&_gl.generateMipmap(_gl.TEXTURE_2D),texture.needsUpdate=!1,texture.onUpdate&&texture.onUpdate()}else _gl.activeTexture(_gl.TEXTURE0+slot),_gl.bindTexture(_gl.TEXTURE_2D,texture.__webglTexture)},this.addPostPlugin(new WebMol.SpritePlugin)},WebMol.Scene=function(){WebMol.Object3D.call(this),this.fog=null,this.overrideMaterial=null,this.matrixAutoUpdate=!1,this.__objects=[],this.__lights=[],this.__objectsAdded=[],this.__objectsRemoved=[]},WebMol.Scene.prototype=Object.create(WebMol.Object3D.prototype),WebMol.Scene.prototype.__addObject=function(object){if(object instanceof WebMol.Light)-1===this.__lights.indexOf(object)&&this.__lights.push(object),object.target&&void 0===object.target.parent&&this.add(object.target);else if(-1===this.__objects.indexOf(object)){this.__objects.push(object),this.__objectsAdded.push(object);var i=this.__objectsRemoved.indexOf(object);-1!==i&&this.__objectsRemoved.splice(i,1)}for(var i in object.children)this.__addObject(object.children[i])},WebMol.Scene.prototype.__removeObject=function(object){if(object instanceof WebMol.Light){var i=this.__lights.indexOf(object);-1!==i&&this.__lights.splice(i,1)}else{var i=this.__objects.indexOf(object);if(-1!==i){this.__objects.splice(i,1),this.__objectsRemoved.push(object);var ai=this.__objectsAdded.indexOf(object);-1!==ai&&this.__objectsAdded.splice(i,1)}}for(var i in object.children)this.__removeObject(object.children[i])},WebMol.Fog=function(hex,near,far){this.name="",this.color=new WebMol.Color(hex),this.near=void 0!==near?near:1,this.far=void 0!==far?far:1e3},WebMol.Fog.prototype.clone=function(){return new WebMol.Fog(this.color.getHex(),this.near,this.far)},WebMol.ShaderUtils={clone:function(uniforms_src){var u,uniforms_clone={};for(u in uniforms_src){uniforms_clone[u]={},uniforms_clone[u].type=uniforms_src[u].type;var srcValue=uniforms_src[u].value;srcValue instanceof WebMol.Color?uniforms_clone[u].value=srcValue.clone():"number"==typeof srcValue?uniforms_clone[u].value=srcValue:srcValue instanceof Array?uniforms_clone[u].value=[]:console.error("Error copying shader uniforms from ShaderLib: unknown type for uniform")}return uniforms_clone}},WebMol.ShaderLib={basic:{fragmentShader:WebMol.multiLineString(function(){}),vertexShader:WebMol.multiLineString(function(){}),uniforms:{opacity:{type:"f",value:1},diffuse:{type:"c",value:new WebMol.Color(1,1,1)},fogColor:{type:"c",value:new WebMol.Color(1,1,1)},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3}}},lambert:{fragmentShader:WebMol.multiLineString(function(){}),vertexShader:WebMol.multiLineString(function(){}),uniforms:{opacity:{type:"f",value:1},diffuse:{type:"c",value:new WebMol.Color(1,1,1)},fogColor:{type:"c",value:new WebMol.Color(1,1,1)},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},ambient:{type:"c",value:new WebMol.Color(1,1,1)},diffuse:{type:"c",value:new WebMol.Color(1,1,1)},emissive:{type:"c",value:new WebMol.Color(1,1,1)},ambientLightColor:{type:"fv",value:[]},directionalLightColor:{type:"fv",value:[]},directionalLightDirection:{type:"fv",value:[]}}},sprite:{fragmentShader:WebMol.multiLineString(function(){}),vertexShader:WebMol.multiLineString(function(){}),uniforms:{}}},"undefined"==typeof console&&(console={log:function(){}});var ProteinSurface=function(){var faces,verts,origextent,INOUT=1,ISDONE=2,ISBOUND=4,ptranx=0,ptrany=0,ptranz=0,probeRadius=1.4,defaultScaleFactor=2,scaleFactor=defaultScaleFactor,pHeight=0,pWidth=0,pLength=0,cutRadius=0,vpBits=null,vpDistance=null,vpAtomID=null,pminx=0,pminy=0,pminz=0,pmaxx=0,pmaxy=0,pmaxz=0,vdwRadii={H:1.2,Li:1.82,Na:2.27,K:2.75,C:1.7,N:1.55,O:1.52,F:1.47,P:1.8,S:1.8,CL:1.75,BR:1.85,SE:1.9,ZN:1.39,CU:1.4,NI:1.63,X:2},getVDWIndex=function(atom){return atom.elem&&"undefined"!=typeof vdwRadii[atom.elem]?atom.elem:"X"},depty={},widxz={},nb=[new Int32Array([1,0,0]),new Int32Array([-1,0,0]),new Int32Array([0,1,0]),new Int32Array([0,-1,0]),new Int32Array([0,0,1]),new Int32Array([0,0,-1]),new Int32Array([1,1,0]),new Int32Array([1,-1,0]),new Int32Array([-1,1,0]),new Int32Array([-1,-1,0]),new Int32Array([1,0,1]),new Int32Array([1,0,-1]),new Int32Array([-1,0,1]),new Int32Array([-1,0,-1]),new Int32Array([0,1,1]),new Int32Array([0,1,-1]),new Int32Array([0,-1,1]),new Int32Array([0,-1,-1]),new Int32Array([1,1,1]),new Int32Array([1,1,-1]),new Int32Array([1,-1,1]),new Int32Array([-1,1,1]),new Int32Array([1,-1,-1]),new Int32Array([-1,-1,1]),new Int32Array([-1,1,-1]),new Int32Array([-1,-1,-1])];this.getFacesAndVertices=function(atomlist){for(var atomsToShow=new Object,i=0,lim=atomlist.length;lim>i;i++)atomsToShow[atomlist[i]]=!0;var vertices=verts;for(i=0;i<vertices.length;i++)vertices[i].x=vertices[i].x/scaleFactor-ptranx,vertices[i].y=vertices[i].y/scaleFactor-ptrany,vertices[i].z=vertices[i].z/scaleFactor-ptranz;for(var finalfaces=[],i=0;i<faces.length;i+=3){var fa=faces[i],fb=faces[i+1],fc=faces[i+2],a=vertices[fa].atomid,b=vertices[fb].atomid,c=vertices[fc].atomid,which=a;if(which>b&&(which=b),which>c&&(which=c),atomsToShow[which]){{vertices[faces[i]],vertices[faces[i+1]],vertices[faces[i+2]]}fa!==fb&&fb!==fc&&fa!==fc&&(finalfaces.push(fa),finalfaces.push(fb),finalfaces.push(fc))}}return vpBits=null,vpDistance=null,vpAtomID=null,{vertices:vertices,faces:finalfaces}},this.initparm=function(extent,btype,volume){volume>1e6&&(scaleFactor=defaultScaleFactor/2);var margin=1/scaleFactor*5.5;origextent=extent,pminx=extent[0][0],pmaxx=extent[1][0],pminy=extent[0][1],pmaxy=extent[1][1],pminz=extent[0][2],pmaxz=extent[1][2],btype?(pminx-=probeRadius+margin,pminy-=probeRadius+margin,pminz-=probeRadius+margin,pmaxx+=probeRadius+margin,pmaxy+=probeRadius+margin,pmaxz+=probeRadius+margin):(pminx-=margin,pminy-=margin,pminz-=margin,pmaxx+=margin,pmaxy+=margin,pmaxz+=margin),pminx=Math.floor(pminx*scaleFactor)/scaleFactor,pminy=Math.floor(pminy*scaleFactor)/scaleFactor,pminz=Math.floor(pminz*scaleFactor)/scaleFactor,pmaxx=Math.ceil(pmaxx*scaleFactor)/scaleFactor,pmaxy=Math.ceil(pmaxy*scaleFactor)/scaleFactor,pmaxz=Math.ceil(pmaxz*scaleFactor)/scaleFactor,ptranx=-pminx,ptrany=-pminy,ptranz=-pminz,pLength=Math.ceil(scaleFactor*(pmaxx-pminx))+1,pWidth=Math.ceil(scaleFactor*(pmaxy-pminy))+1,pHeight=Math.ceil(scaleFactor*(pmaxz-pminz))+1,this.boundingatom(btype),cutRadius=probeRadius*scaleFactor,vpBits=new Uint8Array(pLength*pWidth*pHeight),vpDistance=new Float64Array(pLength*pWidth*pHeight),vpAtomID=new Int32Array(pLength*pWidth*pHeight),console.log("Box size: ",pLength,pWidth,pHeight,vpBits.length)},this.boundingatom=function(btype){var txz,tdept,sradius,tradius=[];flagradius=btype;for(var i in vdwRadii)if(vdwRadii.hasOwnProperty(i)){var r=vdwRadii[i];for(tradius[i]=btype?(r+probeRadius)*scaleFactor+.5:r*scaleFactor+.5,sradius=tradius[i]*tradius[i],widxz[i]=Math.floor(tradius[i])+1,depty[i]=new Int32Array(widxz[i]*widxz[i]),indx=0,j=0;j<widxz[i];j++)for(k=0;k<widxz[i];k++)txz=j*j+k*k,txz>sradius?depty[i][indx]=-1:(tdept=Math.sqrt(sradius-txz),depty[i][indx]=Math.floor(tdept)),indx++}},this.fillvoxels=function(atoms,atomlist){for(var i,lim,i=0,lim=vpBits.length;lim>i;i++)vpBits[i]=0,vpDistance[i]=-1,vpAtomID[i]=-1;for(i in atomlist){var atom=atoms[atomlist[i]];void 0!=atom&&this.fillAtom(atom,atoms)}for(i=0,lim=vpBits.length;lim>i;i++)vpBits[i]&INOUT&&(vpBits[i]|=ISDONE)},this.fillAtom=function(atom,atoms){var cx,cy,cz,ox,oy,oz,mi,mj,mk,i,j,k,si,sj,sk,ii,jj,kk,n;cx=Math.floor(.5+scaleFactor*(atom.x+ptranx)),cy=Math.floor(.5+scaleFactor*(atom.y+ptrany)),cz=Math.floor(.5+scaleFactor*(atom.z+ptranz));var at=getVDWIndex(atom),nind=0,pWH=pWidth*pHeight;for(i=0,n=widxz[at];n>i;i++)for(j=0;n>j;j++){if(-1!=depty[at][nind])for(ii=-1;2>ii;ii++)for(jj=-1;2>jj;jj++)for(kk=-1;2>kk;kk++)if(0!=ii&&0!=jj&&0!=kk)for(mi=ii*i,mk=kk*j,k=0;k<=depty[at][nind];k++)if(mj=k*jj,si=cx+mi,sj=cy+mj,sk=cz+mk,!(0>si||0>sj||0>sk||si>=pLength||sj>=pWidth||sk>=pHeight)){var index=si*pWH+sj*pHeight+sk;if(vpBits[index]&INOUT){var atom2=atoms[vpAtomID[index]];ox=Math.floor(.5+scaleFactor*(atom2.x+ptranx)),oy=Math.floor(.5+scaleFactor*(atom2.y+ptrany)),oz=Math.floor(.5+scaleFactor*(atom2.z+ptranz)),ox*ox+oy*oy+oz*oz>mi*mi+mj*mj+mk*mk&&(vpAtomID[index]=atom.serial)}else vpBits[index]|=INOUT,vpAtomID[index]=atom.serial}nind++}},this.fillvoxelswaals=function(atoms,atomlist){for(var i=0,lim=vpBits.length;lim>i;i++)vpBits[i]&=~ISDONE;for(i in atomlist){var atom=atoms[atomlist[i]];void 0!=atom&&this.fillAtomWaals(atom,atoms)}},this.fillAtomWaals=function(atom,atoms){var cx,cy,cz,ox,oy,oz,mi,mj,mk,si,sj,sk,i,j,k,ii,jj,kk,nind=0;cx=Math.floor(.5+scaleFactor*(atom.x+ptranx)),cy=Math.floor(.5+scaleFactor*(atom.y+ptrany)),cz=Math.floor(.5+scaleFactor*(atom.z+ptranz));var i,j,n,at=getVDWIndex(atom),pWH=pWidth*pHeight;for(i=0,n=widxz[at];n>i;i++)for(j=0;n>j;j++){if(-1!=depty[at][nind])for(ii=-1;2>ii;ii++)for(jj=-1;2>jj;jj++)for(kk=-1;2>kk;kk++)if(0!=ii&&0!=jj&&0!=kk)for(mi=ii*i,mk=kk*j,k=0;k<=depty[at][nind];k++)if(mj=k*jj,si=cx+mi,sj=cy+mj,sk=cz+mk,!(0>si||0>sj||0>sk||si>=pLength||sj>=pWidth||sk>=pHeight)){var index=si*pWH+sj*pHeight+sk;if(vpBits[index]&ISDONE){var atom2=atoms[vpAtomID[index]];ox=Math.floor(.5+scaleFactor*(atom2.x+ptranx)),oy=Math.floor(.5+scaleFactor*(atom2.y+ptrany)),oz=Math.floor(.5+scaleFactor*(atom2.z+ptranz)),ox*ox+oy*oy+oz*oz>mi*mi+mj*mj+mk*mk&&(vpAtomID[index]=atom.serial)}else vpBits[index]|=ISDONE,vpAtomID[index]=atom.serial}nind++}},this.buildboundary=function(){var pWH=pWidth*pHeight;for(i=0;pLength>i;i++)for(j=0;pHeight>j;j++)for(k=0;pWidth>k;k++){var index=i*pWH+k*pHeight+j;if(vpBits[index]&INOUT)for(var ii=0;26>ii;){var ti=i+nb[ii][0],tj=j+nb[ii][2],tk=k+nb[ii][1];if(ti>-1&&pLength>ti&&tk>-1&&pWidth>tk&&tj>-1&&pHeight>tj&&!(vpBits[ti*pWH+tk*pHeight+tj]&INOUT)){vpBits[index]|=ISBOUND;break}ii++}}};var PointGrid=function(length,width,height){var data=new Int32Array(length*width*height*3);this.set=function(x,y,z,pt){var index=3*((x*width+y)*height+z);data[index]=pt.ix,data[index+1]=pt.iy,data[index+2]=pt.iz},this.get=function(x,y,z){var index=3*((x*width+y)*height+z);return{ix:data[index],iy:data[index+1],iz:data[index+2]}}};this.fastdistancemap=function(){var i,j,k,n,boundPoint=new PointGrid(pLength,pWidth,pHeight),pWH=pWidth*pHeight,cutRSq=cutRadius*cutRadius,inarray=new Array,outarray=new Array;for(i=0;pLength>i;i++)for(j=0;pWidth>j;j++)for(k=0;pHeight>k;k++){var index=i*pWH+j*pHeight+k;if(vpBits[index]&=~ISDONE,vpBits[index]&INOUT&&vpBits[index]&ISBOUND){var triple={ix:i,iy:j,iz:k};boundPoint.set(i,j,k,triple),inarray.push(triple),vpDistance[index]=0,vpBits[index]|=ISDONE,vpBits[index]&=~ISBOUND}}do for(outarray=this.fastoneshell(inarray,boundPoint),inarray=[],i=0,n=outarray.length;n>i;i++){var index=pWH*outarray[i].ix+pHeight*outarray[i].iy+outarray[i].iz;vpBits[index]&=~ISBOUND,vpDistance[index]<=1.0404*cutRSq&&inarray.push({ix:outarray[i].ix,iy:outarray[i].iy,iz:outarray[i].iz})}while(0!=inarray.length);inarray=[],outarray=[],boundPoint=null;var cutsf=scaleFactor-.5;0>cutsf&&(cutsf=0);var cutoff=cutRSq-.5/(.1+cutsf);for(i=0;pLength>i;i++)for(j=0;pWidth>j;j++)for(k=0;pHeight>k;k++){var index=i*pWH+j*pHeight+k;vpBits[index]&=~ISBOUND,vpBits[index]&INOUT&&(!(vpBits[index]&ISDONE)||vpBits[index]&ISDONE&&vpDistance[index]>=cutoff)&&(vpBits[index]|=ISBOUND)}},this.fastoneshell=function(inarray,boundPoint){var tx,ty,tz,dx,dy,dz,i,j,n,square,outarray=[];if(0==inarray.length)return outarray;tnv={ix:-1,iy:-1,iz:-1};var pWH=pWidth*pHeight;for(i=0,n=inarray.length;n>i;i++){tx=inarray[i].ix,ty=inarray[i].iy,tz=inarray[i].iz;for(var bp=boundPoint.get(tx,ty,tz),j=0;6>j;j++)if(tnv.ix=tx+nb[j][0],tnv.iy=ty+nb[j][1],tnv.iz=tz+nb[j][2],tnv.ix<pLength&&tnv.ix>-1&&tnv.iy<pWidth&&tnv.iy>-1&&tnv.iz<pHeight&&tnv.iz>-1){var index=tnv.ix*pWH+pHeight*tnv.iy+tnv.iz;if(vpBits[index]&INOUT&&!(vpBits[index]&ISDONE)){boundPoint.set(tnv.ix,tnv.iy,tz+nb[j][2],bp),dx=tnv.ix-bp.ix,dy=tnv.iy-bp.iy,dz=tnv.iz-bp.iz;var square=dx*dx+dy*dy+dz*dz;vpDistance[index]=square,vpBits[index]|=ISDONE,vpBits[index]|=ISBOUND,outarray.push({ix:tnv.ix,iy:tnv.iy,iz:tnv.iz})}else vpBits[index]&INOUT&&vpBits[index]&ISDONE&&(dx=tnv.ix-bp.ix,dy=tnv.iy-bp.iy,dz=tnv.iz-bp.iz,square=dx*dx+dy*dy+dz*dz,square<vpDistance[index]&&(boundPoint.set(tnv.ix,tnv.iy,tnv.iz,bp),vpDistance[index]=square,vpBits[index]&ISBOUND||(vpBits[index]|=ISBOUND,outarray.push({ix:tnv.ix,iy:tnv.iy,iz:tnv.iz}))))}}for(i=0,n=inarray.length;n>i;i++){tx=inarray[i].ix,ty=inarray[i].iy,tz=inarray[i].iz;var bp=boundPoint.get(tx,ty,tz);for(j=6;18>j;j++)if(tnv.ix=tx+nb[j][0],tnv.iy=ty+nb[j][1],tnv.iz=tz+nb[j][2],tnv.ix<pLength&&tnv.ix>-1&&tnv.iy<pWidth&&tnv.iy>-1&&tnv.iz<pHeight&&tnv.iz>-1){var index=tnv.ix*pWH+pHeight*tnv.iy+tnv.iz;vpBits[index]&INOUT&&!(vpBits[index]&ISDONE)?(boundPoint.set(tnv.ix,tnv.iy,tz+nb[j][2],bp),dx=tnv.ix-bp.ix,dy=tnv.iy-bp.iy,dz=tnv.iz-bp.iz,square=dx*dx+dy*dy+dz*dz,vpDistance[index]=square,vpBits[index]|=ISDONE,vpBits[index]|=ISBOUND,outarray.push({ix:tnv.ix,iy:tnv.iy,iz:tnv.iz})):vpBits[index]&INOUT&&vpBits[index]&ISDONE&&(dx=tnv.ix-bp.ix,dy=tnv.iy-bp.iy,dz=tnv.iz-bp.iz,square=dx*dx+dy*dy+dz*dz,square<vpDistance[index]&&(boundPoint.set(tnv.ix,tnv.iy,tnv.iz,bp),vpDistance[index]=square,vpBits[index]&ISBOUND||(vpBits[index]|=ISBOUND,outarray.push({ix:tnv.ix,iy:tnv.iy,iz:tnv.iz}))))}}for(i=0,n=inarray.length;n>i;i++){tx=inarray[i].ix,ty=inarray[i].iy,tz=inarray[i].iz;var bp=boundPoint.get(tx,ty,tz);for(j=18;26>j;j++)if(tnv.ix=tx+nb[j][0],tnv.iy=ty+nb[j][1],tnv.iz=tz+nb[j][2],tnv.ix<pLength&&tnv.ix>-1&&tnv.iy<pWidth&&tnv.iy>-1&&tnv.iz<pHeight&&tnv.iz>-1){var index=tnv.ix*pWH+pHeight*tnv.iy+tnv.iz;vpBits[index]&INOUT&&!(vpBits[index]&ISDONE)?(boundPoint.set(tnv.ix,tnv.iy,tz+nb[j][2],bp),dx=tnv.ix-bp.ix,dy=tnv.iy-bp.iy,dz=tnv.iz-bp.iz,square=dx*dx+dy*dy+dz*dz,vpDistance[index]=square,vpBits[index]|=ISDONE,vpBits[index]|=ISBOUND,outarray.push({ix:tnv.ix,iy:tnv.iy,iz:tnv.iz})):vpBits[index]&INOUT&&vpBits[index]&ISDONE&&(dx=tnv.ix-bp.ix,dy=tnv.iy-bp.iy,dz=tnv.iz-bp.iz,square=dx*dx+dy*dy+dz*dz,square<vpDistance[index]&&(boundPoint.set(tnv.ix,tnv.iy,tnv.iz,bp),vpDistance[index]=square,vpBits[index]&ISBOUND||(vpBits[index]|=ISBOUND,outarray.push({ix:tnv.ix,iy:tnv.iy,iz:tnv.iz}))))}}return outarray},this.marchingcubeinit=function(stype){for(var i=0,lim=vpBits.length;lim>i;i++)1==stype?vpBits[i]&=~ISBOUND:4==stype?(vpBits[i]&=~ISDONE,vpBits[i]&ISBOUND&&(vpBits[i]|=ISDONE),vpBits[i]&=~ISBOUND):2==stype?vpBits[i]&ISBOUND&&vpBits[i]&ISDONE?vpBits[i]&=~ISBOUND:vpBits[i]&ISBOUND&&!(vpBits[i]&ISDONE)&&(vpBits[i]|=ISDONE):3==stype&&(vpBits[i]&=~ISBOUND)};this.marchingcube=function(stype){this.marchingcubeinit(stype),verts=[],faces=[],WebMol.MarchingCube.march(vpBits,verts,faces,{smooth:1,nX:pLength,nY:pWidth,nZ:pHeight});for(var pWH=pWidth*pHeight,i=0,vlen=verts.length;vlen>i;i++)verts[i].atomid=vpAtomID[verts[i].x*pWH+pHeight*verts[i].y+verts[i].z];WebMol.MarchingCube.laplacianSmooth(1,verts,faces)}};WebMol.SurfaceWorker=window.URL.createObjectURL(new Blob([WebMol.multiLineString(function(){})])),$(document).ready(function(){if(void 0!==$("#webmoljs_viewer")[0]&&(WebMol.autoinit=!0),WebMol.autoinit){var viewerdiv=WebMol.viewerdiv=$("#webmoljs_viewer"),datauri=null;viewerdiv.data("pdb")?datauri="http://www.pdb.org/pdb/files/"+viewerdiv.data("pdb")+".pdb":viewerdiv.data("href")&&(datauri=viewerdiv.data("href"));var bgcolor=Number(viewerdiv.data("backgroundcolor"))||0,style=viewerdiv.data("style")||{line:{}};if(WebMol.glviewer=WebMol.createViewer("webmoljs_viewer",{defaultcolors:WebMol.rasmolElementColors,callback:function(viewer){viewer.setBackgroundColor(bgcolor)}}),datauri){var type=viewerdiv.data("datatype")||"pdb";$.get(datauri,function(ret){WebMol.glviewer.addModel(ret,type),WebMol.glviewer.setStyle({},style),WebMol.glviewer.zoomTo(),WebMol.glviewer.render()},"text")}}});var WebMol=WebMol||{};WebMol.defaultElementColor=16716947,WebMol.JmolElementColors={H:16777215,He:14286847,HE:14286847,Li:13402367,LI:13402367,B:16758197,C:9474192,N:3166456,O:16715021,F:9494608,Na:11230450,NA:11230450,Mg:9109248,MG:9109248,Al:12560038,AL:12560038,Si:1578e4,SI:1578e4,P:16744448,S:16777008,Cl:2093087,CL:2093087,Ca:4062976,CA:4062976,Ti:12567239,TI:12567239,Cr:9083335,CR:9083335,Mn:10255047,MN:10255047,Fe:14706227,FE:14706227,Ni:5296208,NI:5296208,Cu:13140019,CU:13140019,Zn:8224944,ZN:8224944,Br:10889513,BR:10889513,Ag:12632256,AG:12632256,I:9699476,Ba:51456,BA:51456,Au:16765219,AU:16765219},WebMol.rasmolElementColors={H:16777215,He:16761035,HE:16761035,Li:11674146,LI:11674146,B:65280,C:13158600,N:9408511,O:15728640,F:14329120,Na:255,NA:255,Mg:2263842,MG:2263842,Al:8421520,AL:8421520,Si:14329120,SI:14329120,P:16753920,S:16762930,Cl:65280,CL:65280,Ca:8421520,CA:8421520,Ti:8421520,TI:8421520,Cr:8421520,CR:8421520,Mn:8421520,MN:8421520,Fe:16753920,FE:16753920,Ni:10824234,NI:10824234,Cu:10824234,CU:10824234,Zn:10824234,ZN:10824234,Br:10824234,BR:10824234,Ag:8421520,AG:8421520,I:10494192,Ba:16753920,BA:16753920,Au:14329120,AU:14329120},WebMol.defaultElementColors=WebMol.JmolElementColors;var WebMol=WebMol||{};WebMol.RWB=function(min,max){this.valueToHex=function(val,range){var lo,hi;if(range?(lo=range[0],hi=range[1]):(lo=min,hi=max),void 0===val)return 16777215;lo>val&&(val=lo),val>hi&&(val=hi);var middle=(hi+lo)/2;if(middle>=val){var scale=Math.floor(255*Math.sqrt((val-lo)/(middle-lo))),color=16711680+256*scale+scale;return color}var scale=Math.floor(255*Math.sqrt(1-(val-middle)/(hi-middle))),color=65536*scale+256*scale+255;return color},this.jmolID=function(){return"rwb"},this.range=function(){return"undefined"!=typeof min&&"undefined"!=typeof max?[min,max]:null}},WebMol.ROYGB=function(min,max){this.valueToHex=function(val,range){var lo,hi;if(range?(lo=range[0],hi=range[1]):(lo=min,hi=max),"undefined"==typeof val)return 16777215;lo>val&&(val=lo),val>hi&&(val=hi);var mid=(lo+hi)/2,q1=(lo+mid)/2,q3=(mid+hi)/2;if(q1>val){var scale=Math.floor(255*Math.sqrt((val-lo)/(q1-lo))),color=16711680+256*scale+0;return color}if(mid>val){var scale=Math.floor(255*Math.sqrt(1-(val-q1)/(mid-q1))),color=65536*scale+65280+0;return color}if(q3>val){var scale=Math.floor(255*Math.sqrt((val-mid)/(q3-mid))),color=65280+1*scale;return color}var scale=Math.floor(255*Math.sqrt(1-(val-q3)/(hi-q3))),color=0+256*scale+255;return color},this.jmolID=function(){return"roygb"},this.range=function(){return"undefined"!=typeof min&&"undefined"!=typeof max?[min,max]:null}},WebMol.Sinebow=function(min,max){this.valueToHex=function(val,range){var lo,hi;if(range?(lo=range[0],hi=range[1]):(lo=min,hi=max),"undefined"==typeof val)return 16777215;lo>val&&(val=lo),val>hi&&(val=hi);var scale=(val-lo)/(hi-lo),h=5*scale/6+.5,r=Math.sin(Math.PI*h);r*=255*r;var g=Math.sin(Math.PI*(h+1/3));g*=255*g;var b=Math.sin(Math.PI*(h+2/3));return b*=255*b,65536*Math.floor(r)+256*Math.floor(b)+1*Math.floor(g)},this.jmolID=function(){return"sinebow"},this.range=function(){return"undefined"!=typeof min&&"undefined"!=typeof max?[min,max]:null}};var WebMol=WebMol||{};WebMol.drawCartoon=function(){var axisDIV=5,strandDIV=6,coilWidth=.3,helixSheetWidth=1.3,thickness=.4,subdivide=function(_points,DIV){var ret=[],points=_points;points=new Array,points.push(_points[0]);for(var i=1,lim=_points.length-1;lim>i;i++){var p1=_points[i],p2=_points[i+1];points.push(p1.smoothen?new TV3((p1.x+p2.x)/2,(p1.y+p2.y)/2,(p1.z+p2.z)/2):p1)}points.push(_points[_points.length-1]);for(var i=-1,size=points.length;size-3>=i;i++)for(var p0=points[-1===i?0:i],p1=points[i+1],p2=points[i+2],p3=points[i===size-3?size-1:i+3],v0=(new TV3).subVectors(p2,p0).multiplyScalar(.5),v1=(new TV3).subVectors(p3,p1).multiplyScalar(.5),j=0;DIV>j;j++){var t=1/DIV*j,x=p1.x+t*v0.x+t*t*(-3*p1.x+3*p2.x-2*v0.x-v1.x)+t*t*t*(2*p1.x-2*p2.x+v0.x+v1.x),y=p1.y+t*v0.y+t*t*(-3*p1.y+3*p2.y-2*v0.y-v1.y)+t*t*t*(2*p1.y-2*p2.y+v0.y+v1.y),z=p1.z+t*v0.z+t*t*(-3*p1.z+3*p2.z-2*v0.z-v1.z)+t*t*t*(2*p1.z-2*p2.z+v0.z+v1.z),pt=new TV3(x,y,z),atomIndex=Math.floor((ret.length+2)/DIV);void 0!==_points[atomIndex]&&void 0!==_points[atomIndex].atom&&(pt.atom=_points[atomIndex].atom),ret.push(pt)}return ret.push(points[points.length-1]),ret},drawThinStrip=function(group,p1,p2,colors,div){for(var offset,vertoffset,color,geo=new WebMol.Geometry(!0),i=0,lim=p1.length;lim>i;i++){color=WebMol.CC.color(colors[Math.round((i-1)/div)]),geoGroup=geo.updateGeoGroup(2),offset=geoGroup.vertices,vertoffset=3*offset,geoGroup.__vertexArray[vertoffset]=p1[i].x,geoGroup.__vertexArray[vertoffset+1]=p1[i].y,geoGroup.__vertexArray[vertoffset+2]=p1[i].z,geoGroup.__vertexArray[vertoffset+3]=p2[i].x,geoGroup.__vertexArray[vertoffset+4]=p2[i].y,geoGroup.__vertexArray[vertoffset+5]=p2[i].z;for(var j=0;6>j;++j)geoGroup.__colorArray[vertoffset+3*j]=color.r,geoGroup.__colorArray[vertoffset+1+3*j]=color.g,geoGroup.__colorArray[vertoffset+2+3*j]=color.b;if(i>0){var faces=[offset,offset+1,offset-1,offset-2],faceoffset=geoGroup.faceidx;
geoGroup.__faceArray[faceoffset]=faces[0],geoGroup.__faceArray[faceoffset+1]=faces[1],geoGroup.__faceArray[faceoffset+2]=faces[3],geoGroup.__faceArray[faceoffset+3]=faces[1],geoGroup.__faceArray[faceoffset+4]=faces[2],geoGroup.__faceArray[faceoffset+5]=faces[3],geoGroup.faceidx+=6}geoGroup.vertices+=2}geo.initTypedArrays(),geo.setUpNormals();var material=new WebMol.MeshLambertMaterial;material.vertexColors=WebMol.FaceColors,material.side=WebMol.DoubleSide;var mesh=new WebMol.Mesh(geo,material);group.add(mesh)},drawStrip=function(group,p1,p2,colors,div,thickness){if(!(p1.length<2)){if(div=div||axisDIV,p1=subdivide(p1,div),p2=subdivide(p2,div),!thickness)return drawThinStrip(group,p1,p2,colors,div);for(var axis,p1v,p2v,a1v,a2v,offset,vertoffset,faceoffset,color,currentAtom,lastAtom,geo=new WebMol.Geometry(!0),vs=[],faces=[[0,2,-6,-8],[-4,-2,6,4],[7,-1,-5,3],[-3,5,1,-7]],i=0,lim=p1.length;lim>i;i++){if(color=WebMol.CC.color(colors[Math.round((i-1)/div)]),vs.push(p1v=p1[i]),vs.push(p1v),vs.push(p2v=p2[i]),vs.push(p2v),lim-1>i){var toNext=p1[i+1].clone().sub(p1[i]),toSide=p2[i].clone().sub(p1[i]);axis=toSide.cross(toNext).normalize().multiplyScalar(thickness)}vs.push(a1v=p1[i].clone().add(axis)),vs.push(a1v),vs.push(a2v=p2[i].clone().add(axis)),vs.push(a2v),void 0!==p1v.atom&&(currentAtom=p1v.atom);var geoGroup=geo.updateGeoGroup(8);offset=geoGroup.vertices,vertoffset=3*offset,geoGroup.__vertexArray[vertoffset]=p1v.x,geoGroup.__vertexArray[vertoffset+1]=p1v.y,geoGroup.__vertexArray[vertoffset+2]=p1v.z,geoGroup.__vertexArray[vertoffset+3]=p1v.x,geoGroup.__vertexArray[vertoffset+4]=p1v.y,geoGroup.__vertexArray[vertoffset+5]=p1v.z,geoGroup.__vertexArray[vertoffset+6]=p2v.x,geoGroup.__vertexArray[vertoffset+7]=p2v.y,geoGroup.__vertexArray[vertoffset+8]=p2v.z,geoGroup.__vertexArray[vertoffset+9]=p2v.x,geoGroup.__vertexArray[vertoffset+10]=p2v.y,geoGroup.__vertexArray[vertoffset+11]=p2v.z,geoGroup.__vertexArray[vertoffset+12]=a1v.x,geoGroup.__vertexArray[vertoffset+13]=a1v.y,geoGroup.__vertexArray[vertoffset+14]=a1v.z,geoGroup.__vertexArray[vertoffset+15]=a1v.x,geoGroup.__vertexArray[vertoffset+16]=a1v.y,geoGroup.__vertexArray[vertoffset+17]=a1v.z,geoGroup.__vertexArray[vertoffset+18]=a2v.x,geoGroup.__vertexArray[vertoffset+19]=a2v.y,geoGroup.__vertexArray[vertoffset+20]=a2v.z,geoGroup.__vertexArray[vertoffset+21]=a2v.x,geoGroup.__vertexArray[vertoffset+22]=a2v.y,geoGroup.__vertexArray[vertoffset+23]=a2v.z;for(var j=0;8>j;++j)geoGroup.__colorArray[vertoffset+3*j]=color.r,geoGroup.__colorArray[vertoffset+1+3*j]=color.g,geoGroup.__colorArray[vertoffset+2+3*j]=color.b;if(i>0)for(var diffAtoms=void 0!==lastAtom&&void 0!==currentAtom&&lastAtom.serial!==currentAtom.serial,j=0;4>j;j++){var face=[offset+faces[j][0],offset+faces[j][1],offset+faces[j][2],offset+faces[j][3]];if(faceoffset=geoGroup.faceidx,geoGroup.__faceArray[faceoffset]=face[0],geoGroup.__faceArray[faceoffset+1]=face[1],geoGroup.__faceArray[faceoffset+2]=face[3],geoGroup.__faceArray[faceoffset+3]=face[1],geoGroup.__faceArray[faceoffset+4]=face[2],geoGroup.__faceArray[faceoffset+5]=face[3],geoGroup.faceidx+=6,currentAtom.clickable||lastAtom.clickable){var p1a=vs[face[3]].clone(),p1b=vs[face[0]].clone(),p2a=vs[face[2]].clone(),p2b=vs[face[1]].clone();p1a.atom=vs[face[3]].atom||null,p2a.atom=vs[face[2]].atom||null,p1b.atom=vs[face[0]].atom||null,p2b.atom=vs[face[1]].atom||null;var face1,face2,face3;if(diffAtoms){var m1=p1a.clone().add(p1b).multiplyScalar(.5),m2=p2a.clone().add(p2b).multiplyScalar(.5),m=p1a.clone().add(p2b).multiplyScalar(.5);j%2===0?(lastAtom.clickable&&(face1=new WebMol.Triangle(m1,m,p1a),face2=new WebMol.Triangle(m2,p2a,m),face3=new WebMol.Triangle(m,p2a,p1a),lastAtom.intersectionShape.triangle.push(face1),lastAtom.intersectionShape.triangle.push(face2),lastAtom.intersectionShape.triangle.push(face3)),currentAtom.clickable&&(face1=new WebMol.Triangle(p1b,p2b,m),face2=new WebMol.Triangle(p2b,m2,m),face3=new WebMol.Triangle(p1b,m,m1),currentAtom.intersectionShape.triangle.push(face1),currentAtom.intersectionShape.triangle.push(face2),currentAtom.intersectionShape.triangle.push(face3))):(currentAtom.clickable&&(face1=new WebMol.Triangle(m1,m,p1a),face2=new WebMol.Triangle(m2,p2a,m),face3=new WebMol.Triangle(m,p2a,p1a),currentAtom.intersectionShape.triangle.push(face1),currentAtom.intersectionShape.triangle.push(face2),currentAtom.intersectionShape.triangle.push(face3)),lastAtom.clickable&&(face1=new WebMol.Triangle(p1b,p2b,m),face2=new WebMol.Triangle(p2b,m2,m),face3=new WebMol.Triangle(p1b,m,m1),lastAtom.intersectionShape.triangle.push(face1),lastAtom.intersectionShape.triangle.push(face2),lastAtom.intersectionShape.triangle.push(face3)))}else currentAtom.clickable&&(face1=new WebMol.Triangle(p1b,p2b,p1a),face2=new WebMol.Triangle(p2b,p2a,p1a),currentAtom.intersectionShape.triangle.push(face1),currentAtom.intersectionShape.triangle.push(face2))}}geoGroup.vertices+=8,lastAtom=currentAtom}var vsize=vs.length-8;geoGroup=geo.updateGeoGroup(8),offset=geoGroup.vertices,vertoffset=3*offset,faceoffset=geoGroup.faceidx;for(var i=0;4>i;i++){vs.push(vs[2*i]),vs.push(vs[vsize+2*i]);var v1=vs[2*i],v2=vs[vsize+2*i];geoGroup.__vertexArray[vertoffset+6*i]=v1.x,geoGroup.__vertexArray[vertoffset+1+6*i]=v1.y,geoGroup.__vertexArray[vertoffset+2+6*i]=v1.z,geoGroup.__vertexArray[vertoffset+3+6*i]=v2.x,geoGroup.__vertexArray[vertoffset+4+6*i]=v2.y,geoGroup.__vertexArray[vertoffset+5+6*i]=v2.z,geoGroup.__colorArray[vertoffset+6*i]=color.r,geoGroup.__colorArray[vertoffset+1+6*i]=color.g,geoGroup.__colorArray[vertoffset+2+6*i]=color.b,geoGroup.__colorArray[vertoffset+3+6*i]=color.r,geoGroup.__colorArray[vertoffset+4+6*i]=color.g,geoGroup.__colorArray[vertoffset+5+6*i]=color.b}vsize+=8;var face1=[offset,offset+2,offset+6,offset+4],face2=[offset+1,offset+5,offset+7,offset+3];geoGroup.__faceArray[faceoffset]=face1[0],geoGroup.__faceArray[faceoffset+1]=face1[1],geoGroup.__faceArray[faceoffset+2]=face1[3],geoGroup.__faceArray[faceoffset+3]=face1[1],geoGroup.__faceArray[faceoffset+4]=face1[2],geoGroup.__faceArray[faceoffset+5]=face1[3],geoGroup.__faceArray[faceoffset+6]=face2[0],geoGroup.__faceArray[faceoffset+7]=face2[1],geoGroup.__faceArray[faceoffset+8]=face2[3],geoGroup.__faceArray[faceoffset+9]=face2[1],geoGroup.__faceArray[faceoffset+10]=face2[2],geoGroup.__faceArray[faceoffset+11]=face2[3],geoGroup.faceidx+=12,geoGroup.vertices+=8,geo.initTypedArrays(),geo.setUpNormals();var material=new WebMol.MeshLambertMaterial;material.vertexColors=WebMol.FaceColors,material.side=WebMol.DoubleSide;var mesh=new WebMol.Mesh(geo,material);group.add(mesh)}},drawSmoothCurve=function(group,_points,width,colors,div){if(0!=_points.length){div=void 0==div?5:div;var geo=new WebMol.Geometry,lineMaterial=(subdivide(_points,div),new WebMol.LineBasicMaterial({linewidth:width}));lineMaterial.vertexColors=!0;var line=new WebMol.Line(geo,lineMaterial);line.type=WebMol.LineStrip,group.add(line)}},drawStrand=function(group,atomlist,num,div,fill,coilWidth,helixSheetWidth,doNotSmoothen,thickness){num=num||strandDIV,div=div||axisDIV;for(var points=[],k=0;num>k;k++)points[k]=[];var currentChain,currentReschain,currentResi,currentCA,colors=[],prevCO=null,ss=null,ssborder=!1;for(var i in atomlist){var atom=atomlist[i];if(void 0!=atom&&("O"==atom.atom||"CA"==atom.atom)&&!atom.hetflag)if("CA"==atom.atom){if(currentChain!=atom.chain||currentResi+1!=atom.resi||currentReschain!=atom.reschain){for(var j=0;!thickness&&num>j;j++)drawSmoothCurve(group,points[j],1,colors,div);fill&&drawStrip(group,points[0],points[num-1],colors,div,thickness);for(var points=[],k=0;num>k;k++)points[k]=[];colors=[],prevCO=null,ss=null,ssborder=!1}currentCA=new TV3(atom.x,atom.y,atom.z),currentAtom=atom,currentChain=atom.chain,currentReschain=atom.reschain,currentResi=atom.resi,ss=atom.ss,ssborder=atom.ssbegin||atom.ssend;var atomcolor=atom.color;"undefined"!=typeof atom.style.cartoon.color&&(atomcolor=atom.style.cartoon.color),colors.push(atomcolor),atom.clickable!==!0||void 0!==atom.intersectionShape&&void 0!==atom.intersectionShape.triangle||(atom.intersectionShape={sphere:null,cylinder:[],line:[],triangle:[]})}else{var O=new TV3(atom.x,atom.y,atom.z);O.sub(currentCA),O.normalize(),O.multiplyScalar("c"==ss?coilWidth:helixSheetWidth),void 0!=prevCO&&O.dot(prevCO)<0&&O.negate(),prevCO=O;for(var j=0;num>j;j++){var delta=-1+2/(num-1)*j,v=new TV3(currentCA.x+prevCO.x*delta,currentCA.y+prevCO.y*delta,currentCA.z+prevCO.z*delta);v.atom=currentAtom,doNotSmoothen||"s"!=ss||(v.smoothen=!0),points[j].push(v)}}}for(var j=0;!thickness&&num>j;j++)drawSmoothCurve(group,points[j],1,colors,div);fill&&drawStrip(group,points[0],points[num-1],colors,div,thickness)},drawCartoon=function(group,atomlist){drawStrand(group,atomlist,2,void 0,!0,coilWidth,helixSheetWidth,!1,thickness)};return drawCartoon}();var WebMol=WebMol||{};WebMol.GLModel=function(){function GLModel(mid,defaultcolors){var atoms=[],id=mid,molObj=null,renderedMolObj=null,lastStyle=null,lastColors=null,defaultColor=WebMol.defaultElementColor;ElementColors=defaultcolors?defaultcolors:WebMol.defaultElementColors;var defaultSphereRadius=1.5,getRadiusFromStyle=function(atom,style){var r=defaultSphereRadius;return"undefined"!=typeof style.radius?r=style.radius:vdwRadii[atom.elem]&&(r=vdwRadii[atom.elem]),"undefined"!=typeof style.scale&&(r*=style.scale),r},cylVertexCache={basisVectors:function(){var nvecs=[];return nvecs[0]=new WebMol.Vector3(-1,0,0),nvecs[4]=new WebMol.Vector3(0,0,1),nvecs[8]=new WebMol.Vector3(1,0,0),nvecs[12]=new WebMol.Vector3(0,0,-1),nvecs[2]=nvecs[0].clone().add(nvecs[4]).normalize(),nvecs[6]=nvecs[4].clone().add(nvecs[8]).normalize(),nvecs[10]=nvecs[8].clone().add(nvecs[12]).normalize(),nvecs[14]=nvecs[12].clone().add(nvecs[0]).normalize(),nvecs[1]=nvecs[0].clone().add(nvecs[2]).normalize(),nvecs[3]=nvecs[2].clone().add(nvecs[4]).normalize(),nvecs[5]=nvecs[4].clone().add(nvecs[6]).normalize(),nvecs[7]=nvecs[6].clone().add(nvecs[8]).normalize(),nvecs[9]=nvecs[8].clone().add(nvecs[10]).normalize(),nvecs[11]=nvecs[10].clone().add(nvecs[12]).normalize(),nvecs[13]=nvecs[12].clone().add(nvecs[14]).normalize(),nvecs[15]=nvecs[14].clone().add(nvecs[0]).normalize(),nvecs}(),cache:{},getVerticesForRadius:function(radius){if(void 0!==this.cache[radius])return this.cache[radius];for(var w=(new WebMol.Vector3(0,1,0),this.basisVectors.length),nvecs=[],norms=[],i=0;w>i;i++){nvecs.push(this.basisVectors[i].clone().multiplyScalar(radius)),nvecs.push(this.basisVectors[i].clone().multiplyScalar(radius));var n=this.basisVectors[i].clone().normalize();norms.push(n),norms.push(n)}var verticesRows=[],heightSegments=10,widthSegments=w;if(heightSegments%2!==0||!heightSegments)return console.error("heightSegments must be even"),null;var x,y,phiStart=0,phiLength=2*Math.PI,thetaStart=0,thetaLength=Math.PI,polar=!1,equator=!1;for(y=0;heightSegments>=y;y++){polar=0===y||y===heightSegments?!0:!1,equator=y===heightSegments/2?!0:!1;var verticesRow=[],toRow=[];for(x=0;widthSegments>=x;x++)if(equator){var xi=widthSegments>x?2*x:0;toRow.push(xi+1),verticesRow.push(xi)}else{var u=x/widthSegments,v=y/heightSegments;if(polar&&0!==x)polar&&verticesRow.push(nvecs.length-1);else if(widthSegments>x){var vertex=new WebMol.Vector3;vertex.x=-radius*Math.cos(phiStart+u*phiLength)*Math.sin(thetaStart+v*thetaLength),vertex.y=radius*Math.cos(thetaStart+v*thetaLength),vertex.z=radius*Math.sin(phiStart+u*phiLength)*Math.sin(thetaStart+v*thetaLength),Math.abs(vertex.x)<1e-5&&(vertex.x=0),Math.abs(vertex.y)<1e-5&&(vertex.y=0),Math.abs(vertex.z)<1e-5&&(vertex.z=0);var n=new WebMol.Vector3(vertex.x,vertex.y,vertex.z);n.normalize(),nvecs.push(vertex),norms.push(n),verticesRow.push(nvecs.length-1)}else verticesRow.push(nvecs.length-widthSegments)}equator&&verticesRows.push(toRow),verticesRows.push(verticesRow)}var obj={vertices:nvecs,normals:norms,verticesRows:verticesRows,w:widthSegments,h:heightSegments};return this.cache[radius]=obj,obj}},sphereVertexCache={cache:{},getVerticesForRadius:function(radius){if("undefined"!=typeof this.cache[radius])return this.cache[radius];var obj={vertices:[],verticesRows:[],normals:[]},widthSegments=12,heightSegments=10;1>radius&&(widthSegments=8,heightSegments=6);var x,y,phiStart=0,phiLength=2*Math.PI,thetaStart=0,thetaLength=Math.PI;for(y=0;heightSegments>=y;y++){var verticesRow=[];for(x=0;widthSegments>=x;x++){var u=x/widthSegments,v=y/heightSegments,vertex={};vertex.x=-radius*Math.cos(phiStart+u*phiLength)*Math.sin(thetaStart+v*thetaLength),vertex.y=radius*Math.cos(thetaStart+v*thetaLength),vertex.z=radius*Math.sin(phiStart+u*phiLength)*Math.sin(thetaStart+v*thetaLength);var n=new WebMol.Vector3(vertex.x,vertex.y,vertex.z);n.normalize(),obj.vertices.push(vertex),obj.normals.push(n),verticesRow.push(obj.vertices.length-1)}obj.verticesRows.push(verticesRow)}return this.cache[radius]=obj,obj}},drawAtomCross=function(atom,geos){if(atom.style.cross){var style=atom.style.cross;if(!style.hidden){var linewidth=style.linewidth||defaultlineWidth;geos[linewidth]||(geos[linewidth]=new WebMol.Geometry);var geoGroup=geos[linewidth].updateGeoGroup(6),delta=getRadiusFromStyle(atom,style),points=[[delta,0,0],[-delta,0,0],[0,delta,0],[0,-delta,0],[0,0,delta],[0,0,-delta]],clickable=atom.clickable;clickable&&void 0===atom.intersectionShape&&(atom.intersectionShape={sphere:[],cylinder:[],line:[]});for(var c=WebMol.CC.color(atom.color),j=0;6>j;j++){var offset=3*geoGroup.vertices;if(geoGroup.vertices++,geoGroup.__vertexArray[offset]=atom.x+points[j][0],geoGroup.__vertexArray[offset+1]=atom.y+points[j][1],geoGroup.__vertexArray[offset+2]=atom.z+points[j][2],geoGroup.__colorArray[offset]=c.r,geoGroup.__colorArray[offset+1]=c.g,geoGroup.__colorArray[offset+2]=c.b,clickable){var point=new WebMol.Vector3(points[j][0],points[j][1],points[j][2]);point.multiplyScalar(.1),point.set(point.x+atom.x,point.y+atom.y,point.z+atom.z),atom.intersectionShape.line.push(point)}}}}},drawBondLines=function(atom,atoms,geos){if(atom.style.line){var style=atom.style.line;if(!style.hidden){var linewidth=style.linewidth||defaultlineWidth;geos[linewidth]||(geos[linewidth]=new WebMol.Geometry);for(var geoGroup=geos[linewidth].updateGeoGroup(2*atom.bonds.length),i=0;i<atom.bonds.length;i++){var j=atom.bonds[i],atom2=atoms[j];if(atom2.style.line){var p1=new TV3(atom.x,atom.y,atom.z),p2=new TV3(atom2.x,atom2.y,atom2.z),mp=p1.clone().add(p2).multiplyScalar(.5);atom.clickable&&(void 0===atom.intersectionShape&&(atom.intersectionShape={sphere:[],cylinder:[],line:[],triangle:[]}),atom.intersectionShape.line.push(p1),atom.intersectionShape.line.push(mp));var c1=WebMol.CC.color(atom.color),offset=3*geoGroup.vertices;geoGroup.vertices+=2,geoGroup.__vertexArray[offset]=p1.x,geoGroup.__vertexArray[offset+1]=p1.y,geoGroup.__vertexArray[offset+2]=p1.z,geoGroup.__colorArray[offset]=c1.r,geoGroup.__colorArray[offset+1]=c1.g,geoGroup.__colorArray[offset+2]=c1.b,geoGroup.__vertexArray[offset+3]=mp.x,geoGroup.__vertexArray[offset+4]=mp.y,geoGroup.__vertexArray[offset+5]=mp.z,geoGroup.__colorArray[offset+3]=c1.r,geoGroup.__colorArray[offset+4]=c1.g,geoGroup.__colorArray[offset+5]=c1.b}}}}},defaultStickRadius=.25,drawAtomSphere=function(atom,geo){if(atom.style.sphere){var style=atom.style.sphere;if(!style.hidden){var color=atom.color;"undefined"!=typeof style.color&&(color=style.color);var x,y,C=WebMol.CC.color(color),radius=getRadiusFromStyle(atom,style);if(atom.clickable===!0&&void 0!==atom.intersectionShape){var center=new WebMol.Vector3(atom.x,atom.y,atom.z);atom.intersectionShape.sphere.push(new WebMol.Sphere(center,radius))}for(var vobj=sphereVertexCache.getVerticesForRadius(radius),vertices=vobj.vertices,normals=vobj.normals,geoGroup=geo.updateGeoGroup(vertices.length),start=geoGroup.vertices,i=0,il=vertices.length;il>i;++i){var offset=3*(start+i),v=vertices[i];geoGroup.__vertexArray[offset]=v.x+atom.x,geoGroup.__vertexArray[offset+1]=v.y+atom.y,geoGroup.__vertexArray[offset+2]=v.z+atom.z,geoGroup.__colorArray[offset]=C.r,geoGroup.__colorArray[offset+1]=C.g,geoGroup.__colorArray[offset+2]=C.b}geoGroup.vertices+=vertices.length;var verticesRows=vobj.verticesRows,h=verticesRows.length-1;for(y=0;h>y;y++){var w=verticesRows[y].length-1;for(x=0;w>x;x++){var faceoffset=geoGroup.faceidx,v1=verticesRows[y][x+1]+start,v1offset=3*v1,v2=verticesRows[y][x]+start,v2offset=3*v2,v3=verticesRows[y+1][x]+start,v3offset=3*v3,v4=verticesRows[y+1][x+1]+start,v4offset=3*v4,n1=normals[v1-start],n2=normals[v2-start],n3=normals[v3-start],n4=normals[v4-start];Math.abs(vertices[v1-start].y)===radius?(geoGroup.__normalArray[v1offset]=n1.x,geoGroup.__normalArray[v3offset]=n3.x,geoGroup.__normalArray[v4offset]=n4.x,geoGroup.__normalArray[v1offset+1]=n1.y,geoGroup.__normalArray[v3offset+1]=n3.y,geoGroup.__normalArray[v4offset+1]=n4.y,geoGroup.__normalArray[v1offset+2]=n1.z,geoGroup.__normalArray[v3offset+2]=n3.z,geoGroup.__normalArray[v4offset+2]=n4.z,geoGroup.__faceArray[faceoffset]=v1,geoGroup.__faceArray[faceoffset+1]=v3,geoGroup.__faceArray[faceoffset+2]=v4,geoGroup.faceidx+=3):Math.abs(vertices[v3-start].y)===radius?(geoGroup.__normalArray[v1offset]=n1.x,geoGroup.__normalArray[v2offset]=n2.x,geoGroup.__normalArray[v3offset]=n3.x,geoGroup.__normalArray[v1offset+1]=n1.y,geoGroup.__normalArray[v2offset+1]=n2.y,geoGroup.__normalArray[v3offset+1]=n3.y,geoGroup.__normalArray[v1offset+2]=n1.z,geoGroup.__normalArray[v2offset+2]=n2.z,geoGroup.__normalArray[v3offset+2]=n3.z,geoGroup.__faceArray[faceoffset]=v1,geoGroup.__faceArray[faceoffset+1]=v2,geoGroup.__faceArray[faceoffset+2]=v3,geoGroup.faceidx+=3):(geoGroup.__normalArray[v1offset]=n1.x,geoGroup.__normalArray[v2offset]=n2.x,geoGroup.__normalArray[v4offset]=n4.x,geoGroup.__normalArray[v1offset+1]=n1.y,geoGroup.__normalArray[v2offset+1]=n2.y,geoGroup.__normalArray[v4offset+1]=n4.y,geoGroup.__normalArray[v1offset+2]=n1.z,geoGroup.__normalArray[v2offset+2]=n2.z,geoGroup.__normalArray[v4offset+2]=n4.z,geoGroup.__normalArray[v2offset]=n2.x,geoGroup.__normalArray[v3offset]=n3.x,geoGroup.__normalArray[v4offset]=n4.x,geoGroup.__normalArray[v2offset+1]=n2.y,geoGroup.__normalArray[v3offset+1]=n3.y,geoGroup.__normalArray[v4offset+1]=n4.y,geoGroup.__normalArray[v2offset+2]=n2.z,geoGroup.__normalArray[v3offset+2]=n3.z,geoGroup.__normalArray[v4offset+2]=n4.z,geoGroup.__faceArray[faceoffset]=v1,geoGroup.__faceArray[faceoffset+1]=v2,geoGroup.__faceArray[faceoffset+2]=v4,geoGroup.__faceArray[faceoffset+3]=v2,geoGroup.__faceArray[faceoffset+4]=v3,geoGroup.__faceArray[faceoffset+5]=v4,geoGroup.faceidx+=6)}}}}},getRotationMatrix=function(){var d=new WebMol.Vector3;return function(dir){d.copy(dir);var dyz,sinA,cosA,sinB,cosB,dx=d.x,dy=d.y,dz=d.z,dxy=Math.sqrt(dx*dx+dy*dy);return 1e-4>dxy?(sinA=0,cosA=1):(sinA=-dx/dxy,cosA=dy/dxy),dy=-sinA*dx+cosA*dy,dyz=Math.sqrt(dy*dy+dz*dz),1e-4>dyz?(sinB=0,cosB=1):(sinB=dz/dyz,cosB=dy/dyz),rot=new Float32Array(9),rot[0]=cosA,rot[1]=sinA,rot[2]=0,rot[3]=-sinA*cosB,rot[4]=cosA*cosB,rot[5]=sinB,rot[6]=sinA*sinB,rot[7]=-cosA*sinB,rot[8]=cosB,rot}}(),drawnC=0,drawCylinder=function(geo,from,to,radius,color,fromCap,toCap){if(from&&to){drawnC++;var drawcaps=fromCap||toCap,dir=to.clone();dir.sub(from);for(var offset,faceoffset,e=getRotationMatrix(dir),vobj=cylVertexCache.getVerticesForRadius(radius),n=vobj.w,h=vobj.h,n_verts=drawcaps?h*n+2:2*n,geoGroup=geo.updateGeoGroup(n_verts),vertices=vobj.vertices,normals=vobj.normals,verticesRows=vobj.verticesRows,toRow=verticesRows[h/2],fromRow=verticesRows[h/2+1],start=geoGroup.vertices,i=0;n>i;++i){var vi=2*i,x=e[0]*vertices[vi].x+e[3]*vertices[vi].y+e[6]*vertices[vi].z,y=e[1]*vertices[vi].x+e[4]*vertices[vi].y+e[7]*vertices[vi].z,z=e[5]*vertices[vi].y+e[8]*vertices[vi].z;offset=3*(start+vi),faceoffset=geoGroup.faceidx,geoGroup.__vertexArray[offset]=x+from.x,geoGroup.__vertexArray[offset+1]=y+from.y,geoGroup.__vertexArray[offset+2]=z+from.z,geoGroup.__vertexArray[offset+3]=x+to.x,geoGroup.__vertexArray[offset+4]=y+to.y,geoGroup.__vertexArray[offset+5]=z+to.z,geoGroup.__normalArray[offset]=x,geoGroup.__normalArray[offset+3]=x,geoGroup.__normalArray[offset+1]=y,geoGroup.__normalArray[offset+4]=y,geoGroup.__normalArray[offset+2]=z,geoGroup.__normalArray[offset+5]=z,geoGroup.__colorArray[offset]=color.r,geoGroup.__colorArray[offset+3]=color.r,geoGroup.__colorArray[offset+1]=color.g,geoGroup.__colorArray[offset+4]=color.g,geoGroup.__colorArray[offset+2]=color.b,geoGroup.__colorArray[offset+5]=color.b,geoGroup.__faceArray[faceoffset]=fromRow[i]+start,geoGroup.__faceArray[faceoffset+1]=fromRow[i+1]+start,geoGroup.__faceArray[faceoffset+2]=toRow[i]+start,geoGroup.__faceArray[faceoffset+3]=toRow[i]+start,geoGroup.__faceArray[faceoffset+4]=fromRow[i+1]+start,geoGroup.__faceArray[faceoffset+5]=toRow[i+1]+start,geoGroup.faceidx+=6}if(drawcaps)for(var v1,v2,v3,v4,x1,x2,x3,x4,y1,y2,y3,y4,z1,z2,z3,z4,nx1,nx2,nx3,nx4,ny1,ny2,ny3,ny4,nz1,nz2,nz3,nz4,ystart=toCap?0:h/2,yend=fromCap?h+1:h/2+1,y=ystart;yend>y;y++)if(y!==h/2)for(var cap=h/2>=y?to:from,x=0;n>x;x++)faceoffset=geoGroup.faceidx,v1=verticesRows[y][x+1],v1offset=3*(v1+start),v2=verticesRows[y][x],v2offset=3*(v2+start),v3=verticesRows[y+1][x],v3offset=3*(v3+start),v4=verticesRows[y+1][x+1],v4offset=3*(v4+start),x1=e[0]*vertices[v1].x+e[3]*vertices[v1].y+e[6]*vertices[v1].z,x2=e[0]*vertices[v2].x+e[3]*vertices[v2].y+e[6]*vertices[v2].z,x3=e[0]*vertices[v3].x+e[3]*vertices[v3].y+e[6]*vertices[v3].z,x4=e[0]*vertices[v4].x+e[3]*vertices[v4].y+e[6]*vertices[v4].z,y1=e[1]*vertices[v1].x+e[4]*vertices[v1].y+e[7]*vertices[v1].z,y2=e[1]*vertices[v2].x+e[4]*vertices[v2].y+e[7]*vertices[v2].z,y3=e[1]*vertices[v3].x+e[4]*vertices[v3].y+e[7]*vertices[v3].z,y4=e[1]*vertices[v4].x+e[4]*vertices[v4].y+e[7]*vertices[v4].z,z1=e[5]*vertices[v1].y+e[8]*vertices[v1].z,z2=e[5]*vertices[v2].y+e[8]*vertices[v2].z,z3=e[5]*vertices[v3].y+e[8]*vertices[v3].z,z4=e[5]*vertices[v4].y+e[8]*vertices[v4].z,geoGroup.__vertexArray[v1offset]=x1+cap.x,geoGroup.__vertexArray[v2offset]=x2+cap.x,geoGroup.__vertexArray[v3offset]=x3+cap.x,geoGroup.__vertexArray[v4offset]=x4+cap.x,geoGroup.__vertexArray[v1offset+1]=y1+cap.y,geoGroup.__vertexArray[v2offset+1]=y2+cap.y,geoGroup.__vertexArray[v3offset+1]=y3+cap.y,geoGroup.__vertexArray[v4offset+1]=y4+cap.y,geoGroup.__vertexArray[v1offset+2]=z1+cap.z,geoGroup.__vertexArray[v2offset+2]=z2+cap.z,geoGroup.__vertexArray[v3offset+2]=z3+cap.z,geoGroup.__vertexArray[v4offset+2]=z4+cap.z,geoGroup.__colorArray[v1offset]=color.r,geoGroup.__colorArray[v2offset]=color.r,geoGroup.__colorArray[v3offset]=color.r,geoGroup.__colorArray[v4offset]=color.r,geoGroup.__colorArray[v1offset+1]=color.g,geoGroup.__colorArray[v2offset+1]=color.g,geoGroup.__colorArray[v3offset+1]=color.g,geoGroup.__colorArray[v4offset+1]=color.g,geoGroup.__colorArray[v1offset+2]=color.b,geoGroup.__colorArray[v2offset+2]=color.b,geoGroup.__colorArray[v3offset+2]=color.b,geoGroup.__colorArray[v4offset+2]=color.b,nx1=e[0]*normals[v1].x+e[3]*normals[v1].y+e[6]*normals[v1].z,nx2=e[0]*normals[v2].x+e[3]*normals[v2].y+e[6]*normals[v2].z,nx3=e[0]*normals[v3].x+e[3]*normals[v3].y+e[6]*normals[v3].z,nx4=e[0]*normals[v4].x+e[3]*normals[v4].y+e[6]*normals[v4].z,ny1=e[1]*normals[v1].x+e[4]*normals[v1].y+e[7]*normals[v1].z,ny2=e[1]*normals[v2].x+e[4]*normals[v2].y+e[7]*normals[v2].z,ny3=e[1]*normals[v3].x+e[4]*normals[v3].y+e[7]*normals[v3].z,ny4=e[1]*normals[v4].x+e[4]*normals[v4].y+e[7]*normals[v4].z,nz1=e[5]*normals[v1].y+e[8]*normals[v1].z,nz2=e[5]*normals[v2].y+e[8]*normals[v2].z,nz3=e[5]*normals[v3].y+e[8]*normals[v3].z,nz4=e[5]*normals[v4].y+e[8]*normals[v4].z,0===y?(geoGroup.__normalArray[v1offset]=nx1,geoGroup.__normalArray[v3offset]=nx3,geoGroup.__normalArray[v4offset]=nx4,geoGroup.__normalArray[v1offset+1]=ny1,geoGroup.__normalArray[v3offset+1]=ny3,geoGroup.__normalArray[v4offset+1]=ny4,geoGroup.__normalArray[v1offset+2]=nz1,geoGroup.__normalArray[v3offset+2]=nz3,geoGroup.__normalArray[v4offset+2]=nz4,geoGroup.__faceArray[faceoffset]=v1+start,geoGroup.__faceArray[faceoffset+1]=v3+start,geoGroup.__faceArray[faceoffset+2]=v4+start,geoGroup.faceidx+=3):y===yend-1?(geoGroup.__normalArray[v1offset]=nx1,geoGroup.__normalArray[v2offset]=nx2,geoGroup.__normalArray[v3offset]=nx3,geoGroup.__normalArray[v1offset+1]=ny1,geoGroup.__normalArray[v2offset+1]=ny2,geoGroup.__normalArray[v3offset+1]=ny3,geoGroup.__normalArray[v1offset+2]=nz1,geoGroup.__normalArray[v2offset+2]=nz2,geoGroup.__normalArray[v3offset+2]=nz3,geoGroup.__faceArray[faceoffset]=v1+start,geoGroup.__faceArray[faceoffset+1]=v2+start,geoGroup.__faceArray[faceoffset+2]=v3+start,geoGroup.faceidx+=3):(geoGroup.__normalArray[v1offset]=nx1,geoGroup.__normalArray[v2offset]=nx2,geoGroup.__normalArray[v4offset]=nx4,geoGroup.__normalArray[v1offset+1]=ny1,geoGroup.__normalArray[v2offset+1]=ny2,geoGroup.__normalArray[v4offset+1]=ny4,geoGroup.__normalArray[v1offset+2]=nz1,geoGroup.__normalArray[v2offset+2]=nz2,geoGroup.__normalArray[v4offset+2]=nz4,geoGroup.__normalArray[v2offset]=nx2,geoGroup.__normalArray[v3offset]=nx3,geoGroup.__normalArray[v4offset]=nx4,geoGroup.__normalArray[v2offset+1]=ny2,geoGroup.__normalArray[v3offset+1]=ny3,geoGroup.__normalArray[v4offset+1]=ny4,geoGroup.__normalArray[v2offset+2]=nz2,geoGroup.__normalArray[v3offset+2]=nz3,geoGroup.__normalArray[v4offset+2]=nz4,geoGroup.__faceArray[faceoffset]=v1+start,geoGroup.__faceArray[faceoffset+1]=v2+start,geoGroup.__faceArray[faceoffset+2]=v4+start,geoGroup.__faceArray[faceoffset+3]=v2+start,geoGroup.__faceArray[faceoffset+4]=v3+start,geoGroup.__faceArray[faceoffset+5]=v4+start,geoGroup.faceidx+=6);geoGroup.vertices+=n_verts}},drawBondSticks=function(atom,atoms,geo){if(atom.style.stick){var style=atom.style.stick;if(!style.hidden){var bondR=style.radius||defaultStickRadius,fromCap=!1,toCap=!1,c1=atom.color;"undefined"!=typeof style.color&&(c1=style.color);var mp,mp2,C1=WebMol.CC.color(c1);!atom.capDrawn&&atom.bonds.length<4&&(fromCap=!0);for(var i=0;i<atom.bonds.length;i++){var j=atom.bonds[i],atom2=atoms[j];if(atom.serial<atom2.serial){if(!atom2.style.stick)continue;var p1=new TV3(atom.x,atom.y,atom.z),p2=new TV3(atom2.x,atom2.y,atom2.z),c2=atom2.color;"undefined"!=typeof style.color&&(c2=style.color);var C2=WebMol.CC.color(c2);if(1===atom.bondOrder[i]){if(!atom2.capDrawn&&atom2.bonds.length<4&&(toCap=!0),c1!=c2?(mp=(new TV3).addVectors(p1,p2).multiplyScalar(.5),drawCylinder(geo,p1,mp,bondR,C1,fromCap,!1),drawCylinder(geo,mp,p2,bondR,C2,!1,toCap)):drawCylinder(geo,p1,p2,bondR,C1,fromCap,toCap),atom.clickable||atom2.clickable){if(mp=(new TV3).addVectors(p1,p2).multiplyScalar(.5),atom.clickable){var cylinder1=new WebMol.Cylinder(p1.clone(),mp.clone(),bondR),sphere1=new WebMol.Sphere(p1.clone(),bondR);atom.intersectionShape.cylinder.push(cylinder1),atom.intersectionShape.sphere.push(sphere1)}if(atom2.clickable){var cylinder2=new WebMol.Cylinder(p2.clone(),mp.clone(),bondR),sphere2=new WebMol.Sphere(p2.clone(),bondR);atom2.intersectionShape.cylinder.push(cylinder2),atom2.intersectionShape.sphere.push(sphere2)}}}else if(atom.bondOrder[i]>1){fromCap=!1,toCap=!1;var dir=p2.clone(),v=null;if(dir.sub(p1),1===atom.bonds.length)if(1===atom2.bonds.length)v=dir.clone(),Math.abs(v.x)>1e-4?v.y+=1:v.x+=1;else{var i2=(i+1)%atom2.bonds.length,j2=atom2.bonds[i2],atom3=atoms[j2],p3=new TV3(atom3.x,atom3.y,atom3.z),dir2=p3.clone();dir2.sub(p1),v=dir2.clone(),v.cross(dir)}else{var i2=(i+1)%atom.bonds.length,j2=atom.bonds[i2],atom3=atoms[j2],p3=new TV3(atom3.x,atom3.y,atom3.z),dir2=p3.clone();dir2.sub(p1),v=dir2.clone(),v.cross(dir)}if(2==atom.bondOrder[i]){var r=bondR/2.5;v.cross(dir),v.normalize(),v.multiplyScalar(1.5*r);var p1a=p1.clone();p1a.add(v);var p1b=p1.clone();p1b.sub(v);var p2a=p1a.clone();p2a.add(dir);var p2b=p1b.clone();if(p2b.add(dir),c1!=c2?(mp=(new TV3).addVectors(p1a,p2a).multiplyScalar(.5),mp2=(new TV3).addVectors(p1b,p2b).multiplyScalar(.5),drawCylinder(geo,p1a,mp,r,C1,fromCap,!1),drawCylinder(geo,mp,p2a,r,C2,!1,toCap),drawCylinder(geo,p1b,mp2,r,C1,fromCap,!1),drawCylinder(geo,mp2,p2b,r,C2,!1,toCap)):(drawCylinder(geo,p1a,p2a,r,C1,fromCap,toCap),drawCylinder(geo,p1b,p2b,r,C1,fromCap,toCap)),atom.clickable||atom2.clickable){if(mp=(new TV3).addVectors(p1a,p2a).multiplyScalar(.5),mp2=(new TV3).addVectors(p1b,p2b).multiplyScalar(.5),atom.clickable){var cylinder1a=new WebMol.Cylinder(p1a.clone(),mp.clone(),r),cylinder1b=new WebMol.Cylinder(p1b.clone(),mp2.clone(),r);atom.intersectionShape.cylinder.push(cylinder1a),atom.intersectionShape.cylinder.push(cylinder1b)}if(atom2.clickable){var cylinder2a=new WebMol.Cylinder(p2a.clone(),mp.clone(),r),cylinder2b=new WebMol.Cylinder(p2b.clone(),mp2.clone(),r);atom2.intersectionShape.cylinder.push(cylinder2a),atom2.intersectionShape.cylinder.push(cylinder2b)}}}else if(3==atom.bondOrder[i]){var r=bondR/4;v.cross(dir),v.normalize(),v.multiplyScalar(3*r);var p1a=p1.clone();p1a.add(v);var p1b=p1.clone();p1b.sub(v);var p2a=p1a.clone();p2a.add(dir);var p2b=p1b.clone();if(p2b.add(dir),c1!=c2?(mp=(new TV3).addVectors(p1a,p2a).multiplyScalar(.5),mp2=(new TV3).addVectors(p1b,p2b).multiplyScalar(.5),mp3=(new TV3).addVectors(p1,p2).multiplyScalar(.5),drawCylinder(geo,p1a,mp,r,C1,fromCap,!1),drawCylinder(geo,mp,p2a,r,C2,!1,toCap),drawCylinder(geo,p1,mp3,r,C1,fromCap,!1),drawCylinder(geo,mp3,p2,r,C2,!1,toCap),drawCylinder(geo,p1b,mp2,r,C1,fromCap,!1),drawCylinder(geo,mp2,p2b,r,C2,!1,toCap)):(drawCylinder(geo,p1a,p2a,r,C1,fromCap,toCap),drawCylinder(geo,p1,p2,r,C1,fromCap,toCap),drawCylinder(geo,p1b,p2b,r,C1,fromCap,toCap)),atom.clickable||atom2.clickable){if(mp=(new TV3).addVectors(p1a,p2a).multiplyScalar(.5),mp2=(new TV3).addVectors(p1b,p2b).multiplyScalar(.5),mp3=(new TV3).addVectors(p1,p2).multiplyScalar(.5),atom.clickable){var cylinder1a=new WebMol.Cylinder(p1a.clone(),mp.clone(),r),cylinder1b=new WebMol.Cylinder(p1b.clone(),mp2.clone(),r),cylinder1c=new WebMol.Cylinder(p1.clone(),mp3.clone(),r);atom.intersectionShape.cylinder.push(cylinder1a),atom.intersectionShape.cylinder.push(cylinder1b),atom.intersectionShape.cylinder.push(cylinder1c)}if(atom2.clickable){var cylinder2a=new WebMol.Cylinder(p2a.clone(),mp.clone(),r),cylinder2b=new WebMol.Cylinder(p2b.clone(),mp2.clone(),r),cylinder2c=new WebMol.Cylinder(p2.clone(),mp3.clone(),r);atom2.intersectionShape.cylinder.push(cylinder2a),atom2.intersectionShape.cylinder.push(cylinder2b),atom2.intersectionShape.cylinder.push(cylinder2c)}}}}(toCap||atom2.bonds.length>3)&&(atom2.capDrawn=!0),(fromCap||atom.bonds.length>3)&&(atom.capDrawn=!0)}}var drawSphere=!atom.singleBonds&&1===atom.bonds.length||!atom.bonds.length;if(drawSphere){var savedstyle=atom.style;atom.style={sphere:{radius:bondR,color:c1}},drawAtomSphere(atom,geo),atom.style=savedstyle}}}},createMolObj=function(atoms){console.log("creating for "+id);for(var ret=new WebMol.Object3D,cartoonAtoms=[],lineGeometries={},crossGeometries={},sphereGeometry=new WebMol.Geometry(!0),stickGeometry=new WebMol.Geometry(!0),i=0;i<atoms.length;i++){var atom=atoms[i];atom&&atom.style&&(atom.clickable&&void 0===atom.intersectionShape&&(atom.intersectionShape={sphere:[],cylinder:[],line:[],triangle:[]}),drawAtomSphere(atom,sphereGeometry),drawAtomCross(atom,crossGeometries),drawBondLines(atom,atoms,lineGeometries),drawBondSticks(atom,atoms,stickGeometry),"undefined"==typeof atom.style.cartoon||atom.style.cartoon.hidden||cartoonAtoms.push(atom))}if(cartoonAtoms.length>0){WebMol.drawCartoon(ret,cartoonAtoms,!1);for(var i=0;i<ret.children.length;i++){ret.children[i].geometry}}if(sphereGeometry.vertices>0){var sphereMaterial=new WebMol.MeshLambertMaterial({ambient:0,vertexColors:!0,reflectivity:0});sphereGeometry.initTypedArrays();var sphere=new WebMol.Mesh(sphereGeometry,sphereMaterial);console.log("sphere geometry "+sphereGeometry.vertices.length),ret.add(sphere)}if(stickGeometry.vertices>0){var cylinderMaterial=new WebMol.MeshLambertMaterial({vertexColors:!0,ambient:0,reflectivity:0});stickGeometry.initTypedArrays(),cylinderMaterial.wireframe&&stickGeometry.setUpWireframe();var sticks=new WebMol.Mesh(stickGeometry,cylinderMaterial);ret.add(sticks)}for(var i in lineGeometries)if(lineGeometries.hasOwnProperty(i)){var linewidth=i,lineMaterial=new WebMol.LineBasicMaterial({linewidth:linewidth,vertexColors:!0});
lineGeometries[i].initTypedArrays();var line=new WebMol.Line(lineGeometries[i],lineMaterial,WebMol.LinePieces);ret.add(line)}for(var i in crossGeometries)if(crossGeometries.hasOwnProperty(i)){var linewidth=i,lineMaterial=new WebMol.LineBasicMaterial({linewidth:linewidth,vertexColors:!0});crossGeometries[i].initTypedArrays();var line=new WebMol.Line(crossGeometries[i],lineMaterial,WebMol.LinePieces);ret.add(line)}return ret};this.getID=function(){return id};var setAtomDefaults=function(atoms,id){for(var i=0;i<atoms.length;i++){var atom=atoms[i];atom&&(atom.style=atom.style||defaultAtomStyle,atom.color=atom.color||ElementColors[atom.elem]||defaultColor,atom.model=id,atom.clickable&&(atom.intersectionShape={sphere:[],cylinder:[],line:[],triangle:[]}))}};this.addMolData=function(data,format){switch(format){case"xyz":parseXYZ(atoms,data);break;case"pdb":parsePDB(atoms,data,!1,!0);break;case"sdf":parseSDF(atoms,data);break;case"mol2":parseMOL2(atoms,data);break;case"cube":parseCube(atoms,data)}setAtomDefaults(atoms,id)},this.atomIsSelected=function(atom,sel){if("undefined"==typeof sel)return!0;var invert=!!sel.invert,ret=!0;for(var key in sel)if(sel.hasOwnProperty(key)&&"props"!=key&&"invert"!=key&&"model"!=key){if("undefined"==typeof atom[key]){ret=!1;break}var isokay=!1;if($.isArray(sel[key])){for(var valarr=sel[key],i=0;i<valarr.length;i++)if(atom[key]==valarr[i]){isokay=!0;break}if(!isokay){ret=!1;break}}else{var val=sel[key];if(atom[key]!=val){ret=!1;break}}}return invert?!ret:ret},this.selectedAtoms=function(sel){for(var ret=[],i=0;i<atoms.length;i++){var atom=atoms[i];atom&&this.atomIsSelected(atom,sel)&&ret.push(atom)}return ret},this.addAtoms=function(newatoms){molObj=null;for(var start=atoms.length,indexmap=[],i=0;i<newatoms.length;i++)indexmap[newatoms[i].index]=start+i;for(var i=0;i<newatoms.length;i++){var olda=newatoms[i],nindex=indexmap[olda.index],a=$.extend(!1,{},olda);a.index=nindex,a.bonds=[],a.bondOrder=[];for(var j=0;j<olda.bonds.length;j++){var neigh=indexmap[olda.bonds[j]];"undefined"!=typeof neigh&&(a.bonds.push(neigh),a.bondOrder.push(olda.bondOrder[j]))}atoms.push(a)}},this.removeAtoms=function(badatoms){molObj=null;for(var baddies=[],i=0;i<badatoms.length;i++)baddies[badatoms[i].index]=!0;for(var newatoms=[],i=0;i<atoms.length;i++){var a=atoms[i];baddies[a.index]||newatoms.push(a)}atoms=[],this.addAtoms(newatoms)},this.setStyle=function(sel,style,add){if(add||null==molObj||!sameObj(style,lastStyle)){lastStyle=add?null:style;var atoms=this.selectedAtoms(sel);atoms.length>0&&(molObj=null);for(var mystyle=$.extend(!0,{},style),i=0;i<atoms.length;i++){atoms[i].clickable&&(atoms[i].intersectionShape={sphere:[],cylinder:[],line:[],triangle:[]}),atoms[i].capDrawn=!1,add||(atoms[i].style={});for(var s in mystyle)mystyle.hasOwnProperty(s)&&(atoms[i].style[s]=mystyle[s])}}},this.setColorByElement=function(sel,colors){if(null===molObj||!sameObj(colors,lastColors)){lastColors=colors;var atoms=this.selectedAtoms(sel);atoms.length>0&&(molObj=null);for(var i=0;i<atoms.length;i++){var a=atoms[i];"undefined"!=typeof colors[a.elem]&&(a.color=colors[a.elem])}}},this.setColorByProperty=function(sel,prop,scheme){var atoms=this.selectedAtoms(sel);lastColors=null,atoms.length>0&&(molObj=null);for(var min=Number.POSITIVE_INFINITY,max=Number.NEGATIVE_INFINITY,i=0;i<atoms.length;i++){var a=atoms[i];if(a.properties&&void 0!=typeof a.properties[prop]){var p=parseFloat(a.properties[prop]);min>p&&(min=p),p>max&&(max=p)}}for(var i=0;i<atoms.length;i++){var a=atoms[i];if(a.properties&&void 0!=typeof a.properties[prop]){var c=scheme.valueToHex(parseFloat(a.properties[prop]),[min,max]);a.color=c}}},this.globj=function(group){var time=new Date;if(null===molObj){molObj=createMolObj(atoms);var time2=new Date;console.log("object creation time: "+(time2-time)),renderedMolObj&&(group.remove(renderedMolObj),renderedMolObj=null),renderedMolObj=molObj.clone(),group.add(renderedMolObj)}},this.removegl=function(group){renderedMolObj&&(void 0!==renderedMolObj.geometry&&renderedMolObj.geometry.dispose(),void 0!==renderedMolObj.material&&renderedMolObj.material.dispose(),group.remove(renderedMolObj),renderedMolObj=null),molObj=null}}var defaultAtomStyle={line:{}},defaultlineWidth=1,vdwRadii={H:1.2,Li:1.82,Na:2.27,K:2.75,C:1.7,N:1.55,O:1.52,F:1.47,P:1.8,S:1.8,CL:1.75,BR:1.85,SE:1.9,ZN:1.39,CU:1.4,NI:1.63},sameObj=function(a,b){return a&&b?JSON.stringify(a)==JSON.stringify(b):a==b},areConnected=function(atom1,atom2){var maxsq=3.6,xdiff=atom1.x-atom2.x;if(xdiff*=xdiff,xdiff>maxsq)return!1;var ydiff=atom1.y-atom2.y;if(ydiff*=ydiff,ydiff>maxsq)return!1;var zdiff=atom1.z-atom2.z;if(zdiff*=zdiff,zdiff>maxsq)return!1;var distSquared=xdiff+ydiff+zdiff;return isNaN(distSquared)?!1:.5>distSquared?!1:distSquared>1.3&&("H"==atom1.elem||"H"==atom2.elem||"D"==atom1.elem||"D"==atom2.elem)?!1:3.6>distSquared&&("S"==atom1.elem||"S"==atom2.elem)?!0:distSquared>2.78?!1:!0},assignBonds=function(atomsarray){for(var atoms=atomsarray.slice(0),i=0;i<atomsarray.length;i++)atomsarray[i].index||(atomsarray[i].index=i);atoms.sort(function(a,b){return a.z-b.z});for(var i=0;i<atoms.length;i++)for(var ai=atoms[i],j=i+1;j<atoms.length;j++){var aj=atoms[j];if(aj.z-ai.z>1.9)break;areConnected(ai,aj)&&-1==ai.bonds.indexOf(aj.index)&&(ai.bonds.push(aj.index),ai.bondOrder.push(1),aj.bonds.push(ai.index),aj.bondOrder.push(1))}},assignPDBBonds=function(atomsarray){for(var protatoms=[],hetatoms=[],i=0;i<atomsarray.length;i++){var atom=atomsarray[i];atom.index=i,atom.hetflag?hetatoms.push(atom):protatoms.push(atom)}assignBonds(hetatoms),protatoms.sort(function(a,b){return a.chain!=b.chain?a.chain<b.chain?-1:1:a.resi-b.resi});for(var lastResConnected,currentResi=-1,reschain=-1,i=0;i<protatoms.length;i++){var ai=protatoms[i];ai.resi!==currentResi&&(currentResi=ai.resi,lastResConnected||reschain++,lastResConnected=!1),ai.reschain=reschain;for(var j=i+1;j<protatoms.length;j++){var aj=protatoms[j];if(aj.chain!=ai.chain)break;if(aj.resi-ai.resi>1)break;areConnected(ai,aj)&&(-1===ai.bonds.indexOf(aj.index)&&(ai.bonds.push(aj.index),ai.bondOrder.push(1),aj.bonds.push(ai.index),aj.bondOrder.push(1)),ai.resi!==aj.resi&&(lastResConnected=!0))}}},hbondDistance=function(a1,a2,maxlength){if(a1.chain==a2.chain&&Math.abs(a1.resi-a2.resi)<4)return Number.POSITIVE_INFINITY;if("O"===a1.atom&&"N"===a2.atom||"N"===a1.atom&&"O"===a2.atom){var xdiff=a1.x-a2.x;if(xdiff>maxlength)return Number.POSITIVE_INFINITY;var ydiff=a1.y-a2.y;if(ydiff>maxlength)return Number.POSITIVE_INFINITY;var zdiff=a1.z-a2.z;if(zdiff>maxlength)return Number.POSITIVE_INFINITY;var dist=Math.sqrt(xdiff*xdiff+ydiff*ydiff+zdiff*zdiff);if(maxlength>dist)return dist}return Number.POSITIVE_INFINITY},assignBackboneHBonds=function(atomsarray){for(var maxlength=3.5,atoms=[],i=0;i<atomsarray.length;i++){atomsarray[i].index=i;var atom=atomsarray[i];atom.hetflag||"N"!==atom.atom&&"O"!==atom.atom||(atoms.push(atom),atom.hbondOther=null,atom.hbondDistance=Number.POSITIVE_INFINITY)}atoms.sort(function(a,b){return a.z-b.z});for(var i=0;i<atoms.length;i++)for(var ai=atoms[i],j=i+1;j<atoms.length;j++){var aj=atoms[j];if(aj.z-ai.z>maxlength)break;var dist=hbondDistance(ai,aj,maxlength);dist<ai.hbondDistance&&(ai.hbondOther=aj,ai.hbondDistance=dist),dist<aj.hbondDistance&&(aj.hbondOther=ai,aj.hbondDistance=dist)}},computeSecondaryStructure=function(atomsarray){assignBackboneHBonds(atomsarray);for(var chres={},i=0;i<atomsarray.length;i++){var atom=atomsarray[i];if("undefined"==typeof chres[atom.chain]&&(chres[atom.chain]=[]),isFinite(atom.hbondDistance)){var other=atom.hbondOther;chres[atom.chain][atom.resi]=4===Math.abs(other.resi-atom.resi)?"h":"s"}}for(c in chres){for(var r=1;r<chres[c].length-1;r++){var valbefore=chres[c][r-1],valafter=chres[c][r+1],val=chres[c][r];valbefore==valafter&&val!=valbefore&&(chres[c][r]=valbefore)}for(var r=0;r<chres[c].length;r++){var val=chres[c][r];("h"==val||"s"==val)&&chres[c][r-1]!=val&&chres[c][r+1]!=val&&delete chres[c][r]}}for(var i=0;i<atomsarray.length;i++){var atom=atomsarray[i],val=chres[atom.chain][atom.resi];"undefined"!=typeof val&&(atom.ss=val,chres[atom.chain][atom.resi-1]!=val&&(atom.ssbegin=!0),chres[atom.chain][atom.resi+1]!=val&&(atom.ssend=!0))}},parseCube=function(atoms,str){var lines=str.replace(/^\s+/,"").split(/[\n\r]+/);if(!(lines.length<6)){var lineArr=lines[2].replace(/^\s+/,"").replace(/\s+/g," ").split(" "),natoms=Math.abs(parseFloat(lineArr[0]));lineArr=lines[3].replace(/^\s+/,"").replace(/\s+/g," ").split(" ");var convFactor=parseFloat(lineArr[0])>0?.529177:1;lines=lines.splice(6,natoms);for(var start=atoms.length,end=start+lines.length,i=start;end>i;++i){var atom={};atom.serial=i;var line=lines[i-start],tokens=line.replace(/^\s+/,"").replace(/\s+/g," ").split(" ");6==tokens[0]?atom.elem="C":1==tokens[0]?atom.elem="H":8==tokens[0]?atom.elem="O":17==tokens[0]&&(atom.elem="CL"),atom.x=parseFloat(tokens[2])*convFactor,atom.y=parseFloat(tokens[3])*convFactor,atom.z=parseFloat(tokens[4])*convFactor,atom.hetflag=!0,atom.singleBonds=!0,atom.bonds=[],atom.bondOrder=[],atom.properties={},atoms.push(atom)}return assignBonds(atoms),!0}},parseXYZ=function(atoms,str){var lines=str.split("\n");if(!(lines.length<3)){var atomCount=parseInt(lines[0].substr(0,3));if(!(isNaN(atomCount)||0>=atomCount||lines.length<atomCount+2)){for(var offset=2,start=atoms.length,end=start+atomCount,i=start;end>i;i++){var line=lines[offset++],tokens=line.replace(/^\s+/,"").replace(/\s+/g," ").split(" "),atom={};atom.serial=i,atom.atom=atom.elem=tokens[0],atom.x=parseFloat(tokens[1]),atom.y=parseFloat(tokens[2]),atom.z=parseFloat(tokens[3]),atom.hetflag=!0,atom.bonds=[],atom.bondOrder=[],atom.singleBonds=!0,atom.properties={},atoms[i]=atom}return assignBonds(atoms),!0}}},parseSDF=function(atoms,str){var lines=str.split("\n");if(!(lines.length<4)){var atomCount=parseInt(lines[3].substr(0,3));if(!(isNaN(atomCount)||0>=atomCount)){var bondCount=parseInt(lines[3].substr(3,3)),offset=4;if(!(lines.length<4+atomCount+bondCount)){for(var start=atoms.length,end=start+atomCount,i=start;end>i;i++){var line=lines[offset];offset++;var atom={};atom.serial=i,atom.x=parseFloat(line.substr(0,10)),atom.y=parseFloat(line.substr(10,10)),atom.z=parseFloat(line.substr(20,10)),atom.hetflag=!0,atom.singleBonds=!0,atom.atom=atom.elem=line.substr(31,3).replace(/ /g,""),atom.bonds=[],atom.bondOrder=[],atom.properties={},atoms[i]=atom}for(i=0;bondCount>i;i++){var line=lines[offset];offset++;var from=parseInt(line.substr(0,3))-1+start,to=parseInt(line.substr(3,3))-1+start,order=parseInt(line.substr(6,3));order>1&&(atoms[from].singleBonds=!1,atoms[to].singleBonds=!1),atoms[from].bonds.push(to),atoms[from].bondOrder.push(order),atoms[to].bonds.push(from),atoms[to].bondOrder.push(order)}return!0}}}},parseMOL2=function(atoms,str,keepH){var noH=!keepH,mol_pos=str.search(/@<TRIPOS>MOLECULE/),atom_pos=str.search(/@<TRIPOS>ATOM/);if(-1!=mol_pos&&-1!=atom_pos){var serialToIndex=[],lines=str.substr(mol_pos,str.length).split("\n"),tokens=lines[2].replace(/^\s+/,"").replace(/\s+/g," ").split(" "),natoms=parseInt(tokens[0]);if(tokens.length>1)var nbonds=parseInt(tokens[1]);else var nbonds=0;for(var offset=4,i=3;;i++)if("@<TRIPOS>ATOM"==lines[i]){offset=i+1;break}for(var start=atoms.length,end=start+natoms,i=start;end>i;i++){var line=lines[offset++],tokens=line.replace(/^\s+/,"").replace(/\s+/g," ").split(" "),atom={},index=i,serial=parseInt(tokens[0]);atom.serial=serial,atom.x=parseFloat(tokens[2]),atom.y=parseFloat(tokens[3]),atom.z=parseFloat(tokens[4]),atom.atom=atom.elem=tokens[5].split(".")[0],atom.singleBonds=!0,"H"==atom.elem&&noH||(atom.bonds=[],atom.bondOrder=[],atom.properties={},serialToIndex[serial]=index,atoms.push(atom))}for(var bonds_found=!1;offset<lines.length;)if("@<TRIPOS>BOND"==lines[offset++]){bonds_found=!0;break}if(bonds_found&&nbonds)for(var i=0;nbonds>i;i++){var line=lines[offset++],tokens=line.replace(/^\s+/,"").replace(/\s+/g," ").split(" "),from=parseInt(tokens[1]);fromAtom=atoms[serialToIndex[from]];var to=parseInt(tokens[2]);toAtom=atoms[serialToIndex[to]];var order=parseInt(tokens[3]);isNaN(order)&&(order=1),order>1&&(fromAtom.singleBonds=!1,toAtom.singleBonds=!1),void 0!=fromAtom&&void 0!=toAtom&&(fromAtom.bonds.push(serialToIndex[to]),fromAtom.bondOrder.push(order),toAtom.bonds.push(serialToIndex[from]),toAtom.bondOrder.push(order))}return!0}},parsePDB=function(atoms,str,keepH,computeStruct){var noH=!keepH,start=atoms.length,protein={sheet:[],helix:[]},hasStruct=!1,serialToIndex=[];lines=str.split("\n");for(var i=0;i<lines.length;i++){line=lines[i].replace(/^\s*/,"");var recordName=line.substr(0,6);if("ATOM  "==recordName||"HETATM"==recordName){var atom,resn,chain,resi,icode,x,y,z,hetflag,elem,serial,altLoc,b;if(altLoc=line.substr(16,1)," "!=altLoc&&"A"!=altLoc)continue;if(serial=parseInt(line.substr(6,5)),atom=line.substr(12,4).replace(/ /g,""),resn=line.substr(17,3),chain=line.substr(21,1),resi=parseInt(line.substr(22,4)),icode=line.substr(26,1),x=parseFloat(line.substr(30,8)),y=parseFloat(line.substr(38,8)),z=parseFloat(line.substr(46,8)),b=parseFloat(line.substr(60,8)),elem=line.substr(76,2).replace(/ /g,""),""==elem&&(elem=line.substr(12,2).replace(/ /g,"")),("H"==elem||"HH"==elem||"HD"==elem)&&noH)continue;hetflag="H"==line[0]?!0:!1,serialToIndex[serial]=atoms.length,atoms.push({resn:resn,x:x,y:y,z:z,elem:elem,hetflag:hetflag,chain:chain,resi:resi,icode:icode,rescode:resi+(" "!=icode?"^"+icode:""),serial:serial,atom:atom,bonds:[],ss:"c",singleBonds:!0,bonds:[],bondOrder:[],properties:{},b:b,pdbline:line})}else if("SHEET "==recordName){hasStruct=!0;var startChain=line.substr(21,1),startResi=parseInt(line.substr(22,4)),endChain=line.substr(32,1),endResi=parseInt(line.substr(33,4));protein.sheet.push([startChain,startResi,endChain,endResi])}else if("CONECT"==recordName)for(var from=parseInt(line.substr(6,5)),fromAtom=atoms[serialToIndex[from]],j=0;4>j;j++){var to=parseInt(line.substr([11,16,21,26][j],5)),toAtom=atoms[serialToIndex[to]];void 0!=fromAtom&&void 0!=toAtom&&(fromAtom.bonds.push(serialToIndex[to]),fromAtom.bondOrder.push(1))}else if("HELIX "==recordName){hasStruct=!0;var startChain=line.substr(19,1),startResi=parseInt(line.substr(21,4)),endChain=line.substr(31,1),endResi=parseInt(line.substr(33,4));protein.helix.push([startChain,startResi,endChain,endResi])}}var starttime=(new Date).getTime();if(assignPDBBonds(atoms),console.log("bond connecting "+((new Date).getTime()-starttime)),computeStruct||!hasStruct){var starttime=(new Date).getTime();computeSecondaryStructure(atoms),console.log("secondary structure "+((new Date).getTime()-starttime))}for(i=start;i<atoms.length;i++)if(atom=atoms[i],void 0!=atom){for(j=0;j<protein.sheet.length;j++)atom.chain==protein.sheet[j][0]&&(atom.resi<protein.sheet[j][1]||atom.resi>protein.sheet[j][3]||(atom.ss="s",atom.resi==protein.sheet[j][1]&&(atom.ssbegin=!0),atom.resi==protein.sheet[j][3]&&(atom.ssend=!0)));for(j=0;j<protein.helix.length;j++)atom.chain==protein.helix[j][0]&&(atom.resi<protein.helix[j][1]||atom.resi>protein.helix[j][3]||(atom.ss="h",atom.resi==protein.helix[j][1]?atom.ssbegin=!0:atom.resi==protein.helix[j][3]&&(atom.ssend=!0)))}return!0};return GLModel.prototype.testMethod=function(){},GLModel}(),WebMol.GLShape=function(){var ISDONE=2,updateColor=function(geo,color){var C=color||WebMol.CC.color(color);geo.colorsNeedUpdate=!0;for(var g in geo.geometryGroups)for(var geoGroup=geo.geometryGroups[g],colorArr=geoGroup.__colorArray,i=0,il=geoGroup.vertices;il>i;++i)colorArr[3*i]=C.r,colorArr[3*i+1]=C.g,colorArr[3*i+2]=C.b},sphereVertexCache={cache:{},getVerticesForRadius:function(radius){if("undefined"!=typeof this.cache[radius])return this.cache[radius];var obj={vertices:[],verticesRows:[],normals:[]},widthSegments=16,heightSegments=10;1>radius&&(widthSegments=8,heightSegments=6);var x,y,phiStart=0,phiLength=2*Math.PI,thetaStart=0,thetaLength=Math.PI;for(y=0;heightSegments>=y;y++){var verticesRow=[];for(x=0;widthSegments>=x;x++){var u=x/widthSegments,v=y/heightSegments,vertex={};vertex.x=-radius*Math.cos(phiStart+u*phiLength)*Math.sin(thetaStart+v*thetaLength),vertex.y=radius*Math.cos(thetaStart+v*thetaLength),vertex.z=radius*Math.sin(phiStart+u*phiLength)*Math.sin(thetaStart+v*thetaLength);var n=new WebMol.Vector3(vertex.x,vertex.y,vertex.z);n.normalize(),obj.vertices.push(vertex),obj.normals.push(n),verticesRow.push(obj.vertices.length-1)}obj.verticesRows.push(verticesRow)}return this.cache[radius]=obj,obj}},drawSphere=function(shape,geoGroup,spec){var pos=spec.center,radius=spec.radius,center=new WebMol.Vector3(pos.x,pos.y,pos.z);shape.intersectionShape.sphere.push(new WebMol.Sphere(center,radius));for(var x,y,vobj=sphereVertexCache.getVerticesForRadius(radius),vertices=vobj.vertices,normals=vobj.normals,start=geoGroup.vertices,i=0,il=vertices.length;il>i;++i){var offset=3*(start+i),v=vertices[i];geoGroup.__vertexArray[offset]=v.x+pos.x,geoGroup.__vertexArray[offset+1]=v.y+pos.y,geoGroup.__vertexArray[offset+2]=v.z+pos.z}geoGroup.vertices+=vertices.length;var verticesRows=vobj.verticesRows,h=verticesRows.length-1;for(y=0;h>y;y++){var w=verticesRows[y].length-1;for(x=0;w>x;x++){var faceoffset=geoGroup.faceidx,lineoffset=geoGroup.lineidx,v1=verticesRows[y][x+1]+start,v1offset=3*v1,v2=verticesRows[y][x]+start,v2offset=3*v2,v3=verticesRows[y+1][x]+start,v3offset=3*v3,v4=verticesRows[y+1][x+1]+start,v4offset=3*v4,n1=normals[v1-start],n2=normals[v2-start],n3=normals[v3-start],n4=normals[v4-start];Math.abs(vertices[v1-start].y)===radius?(geoGroup.__normalArray[v1offset]=n1.x,geoGroup.__normalArray[v3offset]=n3.x,geoGroup.__normalArray[v4offset]=n4.x,geoGroup.__normalArray[v1offset+1]=n1.y,geoGroup.__normalArray[v3offset+1]=n3.y,geoGroup.__normalArray[v4offset+1]=n4.y,geoGroup.__normalArray[v1offset+2]=n1.z,geoGroup.__normalArray[v3offset+2]=n3.z,geoGroup.__normalArray[v4offset+2]=n4.z,geoGroup.__faceArray[faceoffset]=v1,geoGroup.__faceArray[faceoffset+1]=v3,geoGroup.__faceArray[faceoffset+2]=v4,geoGroup.__lineArray[lineoffset]=v1,geoGroup.__lineArray[lineoffset+1]=v3,geoGroup.__lineArray[lineoffset+2]=v1,geoGroup.__lineArray[lineoffset+3]=v4,geoGroup.__lineArray[lineoffset+4]=v3,geoGroup.__lineArray[lineoffset+5]=v4,geoGroup.faceidx+=3,geoGroup.lineidx+=6):Math.abs(vertices[v3-start].y)===radius?(geoGroup.__normalArray[v1offset]=n1.x,geoGroup.__normalArray[v2offset]=n2.x,geoGroup.__normalArray[v3offset]=n3.x,geoGroup.__normalArray[v1offset+1]=n1.y,geoGroup.__normalArray[v2offset+1]=n2.y,geoGroup.__normalArray[v3offset+1]=n3.y,geoGroup.__normalArray[v1offset+2]=n1.z,geoGroup.__normalArray[v2offset+2]=n2.z,geoGroup.__normalArray[v3offset+2]=n3.z,geoGroup.__faceArray[faceoffset]=v1,geoGroup.__faceArray[faceoffset+1]=v2,geoGroup.__faceArray[faceoffset+2]=v3,geoGroup.__lineArray[lineoffset]=v1,geoGroup.__lineArray[lineoffset+1]=v2,geoGroup.__lineArray[lineoffset+2]=v1,geoGroup.__lineArray[lineoffset+3]=v3,geoGroup.__lineArray[lineoffset+4]=v2,geoGroup.__lineArray[lineoffset+5]=v3,geoGroup.faceidx+=3,geoGroup.lineidx+=6):(geoGroup.__normalArray[v1offset]=n1.x,geoGroup.__normalArray[v2offset]=n2.x,geoGroup.__normalArray[v4offset]=n4.x,geoGroup.__normalArray[v1offset+1]=n1.y,geoGroup.__normalArray[v2offset+1]=n2.y,geoGroup.__normalArray[v4offset+1]=n4.y,geoGroup.__normalArray[v1offset+2]=n1.z,geoGroup.__normalArray[v2offset+2]=n2.z,geoGroup.__normalArray[v4offset+2]=n4.z,geoGroup.__normalArray[v2offset]=n2.x,geoGroup.__normalArray[v3offset]=n3.x,geoGroup.__normalArray[v4offset]=n4.x,geoGroup.__normalArray[v2offset+1]=n2.y,geoGroup.__normalArray[v3offset+1]=n3.y,geoGroup.__normalArray[v4offset+1]=n4.y,geoGroup.__normalArray[v2offset+2]=n2.z,geoGroup.__normalArray[v3offset+2]=n3.z,geoGroup.__normalArray[v4offset+2]=n4.z,geoGroup.__faceArray[faceoffset]=v1,geoGroup.__faceArray[faceoffset+1]=v2,geoGroup.__faceArray[faceoffset+2]=v4,geoGroup.__faceArray[faceoffset+3]=v2,geoGroup.__faceArray[faceoffset+4]=v3,geoGroup.__faceArray[faceoffset+5]=v4,geoGroup.__lineArray[lineoffset]=v1,geoGroup.__lineArray[lineoffset+1]=v2,geoGroup.__lineArray[lineoffset+2]=v1,geoGroup.__lineArray[lineoffset+3]=v4,geoGroup.__lineArray[lineoffset+4]=v2,geoGroup.__lineArray[lineoffset+5]=v3,geoGroup.__lineArray[lineoffset+6]=v3,geoGroup.__lineArray[lineoffset+7]=v4,geoGroup.faceidx+=6,geoGroup.lineidx+=8)}}},drawArrow=function(shape,geoGroup,spec){var from=spec.start,end=spec.end,radius=spec.radius,radiusRatio=spec.radiusRatio,mid=spec.mid;if(from&&end){var dir=end.clone();dir.sub(from).multiplyScalar(mid);var to=from.clone().add(dir),negDir=dir.clone().negate();shape.intersectionShape.cylinder.push(new WebMol.Cylinder(from.clone(),to.clone(),radius)),shape.intersectionShape.sphere.push(new WebMol.Sphere(from.clone(),radius));var nvecs=[];nvecs[0]=dir.clone(),Math.abs(nvecs[0].x)>1e-4?nvecs[0].y+=1:nvecs[0].x+=1,nvecs[0].cross(dir),nvecs[0].normalize(),nvecs[0]=nvecs[0],nvecs[4]=nvecs[0].clone(),nvecs[4].crossVectors(nvecs[0],dir),nvecs[4].normalize(),nvecs[8]=nvecs[0].clone().negate(),nvecs[12]=nvecs[4].clone().negate(),nvecs[2]=nvecs[0].clone().add(nvecs[4]).normalize(),nvecs[6]=nvecs[4].clone().add(nvecs[8]).normalize(),nvecs[10]=nvecs[8].clone().add(nvecs[12]).normalize(),nvecs[14]=nvecs[12].clone().add(nvecs[0]).normalize(),nvecs[1]=nvecs[0].clone().add(nvecs[2]).normalize(),nvecs[3]=nvecs[2].clone().add(nvecs[4]).normalize(),nvecs[5]=nvecs[4].clone().add(nvecs[6]).normalize(),nvecs[7]=nvecs[6].clone().add(nvecs[8]).normalize(),nvecs[9]=nvecs[8].clone().add(nvecs[10]).normalize(),nvecs[11]=nvecs[10].clone().add(nvecs[12]).normalize(),nvecs[13]=nvecs[12].clone().add(nvecs[14]).normalize(),nvecs[15]=nvecs[14].clone().add(nvecs[0]).normalize();for(var start=geoGroup.vertices,i=0,n=nvecs.length;n>i;++i){var offset=3*(start+3*i),bottom=nvecs[i].clone().multiplyScalar(radius).add(from),top=nvecs[i].clone().multiplyScalar(radius).add(to),conebase=nvecs[i].clone().multiplyScalar(radius*radiusRatio).add(to);if(geoGroup.__vertexArray[offset]=bottom.x,geoGroup.__vertexArray[offset+1]=bottom.y,geoGroup.__vertexArray[offset+2]=bottom.z,geoGroup.__vertexArray[offset+3]=top.x,geoGroup.__vertexArray[offset+4]=top.y,geoGroup.__vertexArray[offset+5]=top.z,geoGroup.__vertexArray[offset+6]=conebase.x,geoGroup.__vertexArray[offset+7]=conebase.y,geoGroup.__vertexArray[offset+8]=conebase.z,i>0){var prev_x=geoGroup.__vertexArray[offset-3],prev_y=geoGroup.__vertexArray[offset-2],prev_z=geoGroup.__vertexArray[offset-1],c=new WebMol.Vector3(prev_x,prev_y,prev_z),b=end.clone(),b2=to.clone(),a=new WebMol.Vector3(conebase.x,conebase.y,conebase.z);shape.intersectionShape.triangle.push(new WebMol.Triangle(a,b,c)),shape.intersectionShape.triangle.push(new WebMol.Triangle(c.clone(),b2,a.clone()))}}geoGroup.vertices+=48,offset=3*geoGroup.vertices,geoGroup.__vertexArray[offset]=from.x,geoGroup.__vertexArray[offset+1]=from.y,geoGroup.__vertexArray[offset+2]=from.z,geoGroup.__vertexArray[offset+3]=to.x,geoGroup.__vertexArray[offset+4]=to.y,geoGroup.__vertexArray[offset+5]=to.z,geoGroup.__vertexArray[offset+6]=end.x,geoGroup.__vertexArray[offset+7]=end.y,geoGroup.__vertexArray[offset+8]=end.z,geoGroup.vertices+=3;for(var face,norm,offset,faceoffset,lineoffset,fromi=geoGroup.vertices-3,toi=geoGroup.vertices-2,endi=geoGroup.vertices-1,fromoffset=3*fromi,tooffset=3*toi,endoffset=3*endi,i=0,n=nvecs.length-1;n>i;++i){var ti=start+3*i,offset=3*ti;faceoffset=geoGroup.faceidx,lineoffset=geoGroup.lineidx;var t1=ti,t1offset=3*t1,t2=ti+1,t2offset=3*t2,t2b=ti+2,t2boffset=3*t2b,t3=ti+4,t3offset=3*t3,t3b=ti+5,t3boffset=3*t3b,t4=ti+3,t4offset=3*t4;norm=[nvecs[i],nvecs[i],nvecs[i+1],nvecs[i+1]];var n1,n2,n3,n4;n1=n2=nvecs[i],n3=n4=nvecs[i+1],geoGroup.__normalArray[t1offset]=n1.x,geoGroup.__normalArray[t2offset]=n2.x,geoGroup.__normalArray[t4offset]=n4.x,geoGroup.__normalArray[t1offset+1]=n1.y,geoGroup.__normalArray[t2offset+1]=n2.y,geoGroup.__normalArray[t4offset+1]=n4.y,geoGroup.__normalArray[t1offset+2]=n1.z,geoGroup.__normalArray[t2offset+2]=n2.z,geoGroup.__normalArray[t4offset+2]=n4.z,geoGroup.__normalArray[t2offset]=n2.x,geoGroup.__normalArray[t3offset]=n3.x,geoGroup.__normalArray[t4offset]=n4.x,geoGroup.__normalArray[t2offset+1]=n2.y,geoGroup.__normalArray[t3offset+1]=n3.y,geoGroup.__normalArray[t4offset+1]=n4.y,geoGroup.__normalArray[t2offset+2]=n2.z,geoGroup.__normalArray[t3offset+2]=n3.z,geoGroup.__normalArray[t4offset+2]=n4.z,geoGroup.__normalArray[t2boffset]=n2.x,geoGroup.__normalArray[t3boffset]=n3.x,geoGroup.__normalArray[t2boffset+1]=n2.y,geoGroup.__normalArray[t3boffset+1]=n3.y,geoGroup.__normalArray[t2boffset+2]=n2.z,geoGroup.__normalArray[t3boffset+2]=n3.z,geoGroup.__faceArray[faceoffset]=t1,geoGroup.__faceArray[faceoffset+1]=t2,geoGroup.__faceArray[faceoffset+2]=t4,geoGroup.__faceArray[faceoffset+3]=t2,geoGroup.__faceArray[faceoffset+4]=t3,geoGroup.__faceArray[faceoffset+5]=t4,geoGroup.__faceArray[faceoffset+6]=t1,geoGroup.__faceArray[faceoffset+7]=t4,geoGroup.__faceArray[faceoffset+8]=fromi,geoGroup.__faceArray[faceoffset+9]=t2b,geoGroup.__faceArray[faceoffset+10]=toi,geoGroup.__faceArray[faceoffset+11]=t3b,geoGroup.__faceArray[faceoffset+12]=t2b,geoGroup.__faceArray[faceoffset+13]=endi,geoGroup.__faceArray[faceoffset+14]=t3b,geoGroup.__lineArray[lineoffset]=t1,geoGroup.__lineArray[lineoffset+1]=t2,geoGroup.__lineArray[lineoffset+2]=t1,geoGroup.__lineArray[lineoffset+3]=t4,geoGroup.__lineArray[lineoffset+4]=t3,geoGroup.__lineArray[lineoffset+5]=t4,geoGroup.__lineArray[lineoffset+6]=t1,geoGroup.__lineArray[lineoffset+7]=t4,geoGroup.__lineArray[lineoffset+8]=t2b,geoGroup.__lineArray[lineoffset+9]=t2,geoGroup.__lineArray[lineoffset+10]=t2b,geoGroup.__lineArray[lineoffset+11]=t3b,geoGroup.__lineArray[lineoffset+12]=t3,geoGroup.__lineArray[lineoffset+13]=t3b,geoGroup.__lineArray[lineoffset+14]=t2b,geoGroup.__lineArray[lineoffset+15]=endi,geoGroup.__lineArray[lineoffset+16]=t2b,geoGroup.__lineArray[lineoffset+17]=t3b,geoGroup.__lineArray[lineoffset+18]=endi,geoGroup.__lineArray[lineoffset+19]=t3b,geoGroup.faceidx+=15,geoGroup.lineidx+=20}face=[start+45,start+46,start+1,start,start+47,start+2],norm=[nvecs[15],nvecs[15],nvecs[0],nvecs[0]],faceoffset=geoGroup.faceidx,lineoffset=geoGroup.lineidx;var n1,n2,n3,n4,t1=face[0],t1offset=3*t1,t2=face[1],t2offset=3*t2,t2b=face[4],t2boffset=3*t2b,t3=face[2],t3offset=3*t3,t3b=face[5],t3boffset=3*t3b,t4=face[3],t4offset=3*t4;n1=n2=nvecs[15],n3=n4=nvecs[0],geoGroup.__normalArray[t1offset]=n1.x,geoGroup.__normalArray[t2offset]=n2.x,geoGroup.__normalArray[t4offset]=n4.x,geoGroup.__normalArray[t1offset+1]=n1.y,geoGroup.__normalArray[t2offset+1]=n2.y,geoGroup.__normalArray[t4offset+1]=n4.y,geoGroup.__normalArray[t1offset+2]=n1.z,geoGroup.__normalArray[t2offset+2]=n2.z,geoGroup.__normalArray[t4offset+2]=n4.z,geoGroup.__normalArray[t2offset]=n2.x,geoGroup.__normalArray[t3offset]=n3.x,geoGroup.__normalArray[t4offset]=n4.x,geoGroup.__normalArray[t2offset+1]=n2.y,geoGroup.__normalArray[t3offset+1]=n3.y,geoGroup.__normalArray[t4offset+1]=n4.y,geoGroup.__normalArray[t2offset+2]=n2.z,geoGroup.__normalArray[t3offset+2]=n3.z,geoGroup.__normalArray[t4offset+2]=n4.z,geoGroup.__normalArray[t2boffset]=n2.x,geoGroup.__normalArray[t3boffset]=n3.x,geoGroup.__normalArray[t2boffset+1]=n2.y,geoGroup.__normalArray[t3boffset+1]=n3.y,geoGroup.__normalArray[t2boffset+2]=n2.z,geoGroup.__normalArray[t3boffset+2]=n3.z,dir.normalize(),negDir.normalize(),geoGroup.__normalArray[fromoffset]=negDir.x,geoGroup.__normalArray[tooffset]=geoGroup.__normalArray[endoffset]=dir.x,geoGroup.__normalArray[fromoffset+1]=negDir.y,geoGroup.__normalArray[tooffset+1]=geoGroup.__normalArray[endoffset+1]=dir.y,geoGroup.__normalArray[fromoffset+2]=negDir.z,geoGroup.__normalArray[tooffset+2]=geoGroup.__normalArray[endoffset+2]=dir.z,geoGroup.__faceArray[faceoffset]=t1,geoGroup.__faceArray[faceoffset+1]=t2,geoGroup.__faceArray[faceoffset+2]=t4,geoGroup.__faceArray[faceoffset+3]=t2,geoGroup.__faceArray[faceoffset+4]=t3,geoGroup.__faceArray[faceoffset+5]=t4,geoGroup.__faceArray[faceoffset+6]=t1,geoGroup.__faceArray[faceoffset+7]=t4,geoGroup.__faceArray[faceoffset+8]=fromi,geoGroup.__faceArray[faceoffset+9]=t2b,geoGroup.__faceArray[faceoffset+10]=toi,geoGroup.__faceArray[faceoffset+11]=t3b,geoGroup.__faceArray[faceoffset+12]=t2b,geoGroup.__faceArray[faceoffset+13]=endi,geoGroup.__faceArray[faceoffset+14]=t3b,geoGroup.__lineArray[lineoffset]=t1,geoGroup.__lineArray[lineoffset+1]=t2,geoGroup.__lineArray[lineoffset+2]=t1,geoGroup.__lineArray[lineoffset+3]=t4,geoGroup.__lineArray[lineoffset+4]=t3,geoGroup.__lineArray[lineoffset+5]=t4,geoGroup.__lineArray[lineoffset+6]=t1,geoGroup.__lineArray[lineoffset+7]=t4,geoGroup.__lineArray[lineoffset+8]=t2b,geoGroup.__lineArray[lineoffset+9]=t2,geoGroup.__lineArray[lineoffset+10]=t2b,geoGroup.__lineArray[lineoffset+11]=t3b,geoGroup.__lineArray[lineoffset+12]=t3,geoGroup.__lineArray[lineoffset+13]=t3b,geoGroup.__lineArray[lineoffset+14]=t2b,geoGroup.__lineArray[lineoffset+15]=endi,geoGroup.__lineArray[lineoffset+16]=t2b,geoGroup.__lineArray[lineoffset+17]=t3b,geoGroup.__lineArray[lineoffset+18]=endi,geoGroup.__lineArray[lineoffset+19]=t3b,geoGroup.faceidx+=15,geoGroup.lineidx+=20}},drawCustom=function(shape,geoGroup,customSpec){var vertexArr=customSpec.vertexArr,normalArr=customSpec.normalArr,faceArr=customSpec.faceArr,lineArr=customSpec.lineArr;(0===vertexArr.length||0===faceArr.length)&&console.warn("Error adding custom shape component: No vertices and/or face indices supplied!"),geoGroup.vertices=vertexArr.length,geoGroup.faceidx=faceArr.length;for(var offset,v,a,b,c,i=0;i<geoGroup.vertices;++i)offset=3*i,v=vertexArr[i],geoGroup.__vertexArray[offset]=v.x,geoGroup.__vertexArray[offset+1]=v.y,geoGroup.__vertexArray[offset+2]=v.z;for(var i=0;i<geoGroup.faceidx/3;++i){offset=3*i,a=faceArr[offset],b=faceArr[offset+1],c=faceArr[offset+2];var vA=new WebMol.Vector3,vB=new WebMol.Vector3,vC=new WebMol.Vector3;shape.intersectionShape.triangle.push(new WebMol.Triangle(vA.copy(vertexArr[a]),vB.copy(vertexArr[b]),vC.copy(vertexArr[c])))}if(geoGroup.__faceArray=new Uint16Array(faceArr),geoGroup.truncateArrayBuffers(!0),normalArr.length<geoGroup.vertices)geoGroup.setNormals();else{geoGroup.__normalArray=new Float32Array(3*geoGroup.vertices);for(var n,i=0;i<geoGroup.vertices;++i)offset=3*i,n=normalArr[i],geoGroup.__normalArray[offset]=n.x,geoGroup.__normalArray[offset+1]=n.y,geoGroup.__normalArray[offset+2]=n.z}lineArr.length?geoGroup.__lineArray=new Uint16Array(lineArr):geoGroup.setLineIndices(),geoGroup.lineidx=geoGroup.__lineArray.length},parseCube=function(shape,geoGroup,str,isoval,voxel){var lines=str.replace(/^\s+/,"").split(/[\n\r]+/);if(!(lines.length<6)){var lineArr=lines[2].replace(/^\s+/,"").replace(/\s+/g," ").split(" "),natoms=Math.abs(parseFloat(lineArr[0])),origin=new WebMol.Vector3(parseFloat(lineArr[1]),parseFloat(lineArr[2]),parseFloat(lineArr[3]));lineArr=lines[3].replace(/^\s+/,"").replace(/\s+/g," ").split(" ");var convFactor=parseFloat(lineArr[0])>0?.529177:1;origin.multiplyScalar(convFactor);var nX=Math.abs(lineArr[0]),xVec=new WebMol.Vector3(parseFloat(lineArr[1]),parseFloat(lineArr[2]),parseFloat(lineArr[3])).multiplyScalar(convFactor);lineArr=lines[4].replace(/^\s+/,"").replace(/\s+/g," ").split(" ");{var nY=Math.abs(lineArr[0]);new WebMol.Vector3(parseFloat(lineArr[1]),parseFloat(lineArr[2]),parseFloat(lineArr[3])).multiplyScalar(convFactor)}lineArr=lines[5].replace(/^\s+/,"").replace(/\s+/g," ").split(" ");{var nZ=Math.abs(lineArr[0]);new WebMol.Vector3(parseFloat(lineArr[1]),parseFloat(lineArr[2]),parseFloat(lineArr[3])).multiplyScalar(convFactor)}lines=new Float32Array(lines.splice(natoms+7).join(" ").replace(/^\s+/,"").split(/[\s\r]+/));for(var vertnums=new Int16Array(nX*nY*nZ),i=0;i<vertnums.length;++i)vertnums[i]=-1;for(var bitdata=new Uint8Array(nX*nY*nZ),i=0;i<lines.length;++i){var val=isoval>=0?lines[i]-isoval:isoval-lines[i];val>0&&(bitdata[i]|=ISDONE)}var verts=[],faces=[];WebMol.MarchingCube.march(bitdata,verts,faces,{fulltable:!0,voxel:voxel,scale:xVec.length(),origin:origin,nX:nX,nY:nY,nZ:nZ}),voxel||WebMol.MarchingCube.laplacianSmooth(10,verts,faces),drawCustom(shape,geoGroup,{vertexArr:verts,faceArr:faces,normalArr:[],lineArr:[]})
}},updateBoundingFromPoints=function(sphere,components,points){if(sphere.center.set(0,0,0),components.length>0){for(var i=0,il=components.length;il>i;++i){var centroid=components[i].centroid;sphere.center.add(centroid)}sphere.center.divideScalar(components.length)}for(var maxRadiusSq=sphere.radius*sphere.radius,i=0,il=points.length/3;il>i;i++){var x=points[3*i],y=points[3*i+1],z=points[3*i+2],radiusSq=sphere.center.distanceToSquared({x:x,y:y,z:z});maxRadiusSq=Math.max(maxRadiusSq,radiusSq)}sphere.radius=Math.sqrt(maxRadiusSq)},updateFromStyle=function(shape,stylespec){shape.color=stylespec.color||new WebMol.Color,shape.wireframe=stylespec.wireframe?!0:!1,shape.alpha=stylespec.alpha?WebMol.Math.clamp(stylespec.alpha,0,1):1,shape.side=void 0!==stylespec.side?stylespec.side:WebMol.DoubleSide,shape.clickable=stylespec.clickable?!0:!1,shape.callback="function"==typeof stylespec.callback?stylespec.callback:null},GLShape=function(sid,stylespec){stylespec=stylespec||{},WebMol.ShapeIDCount++,this.id=sid,this.boundingSphere=new WebMol.Sphere,this.intersectionShape={sphere:[],cylinder:[],line:[],triangle:[]},updateFromStyle(this,stylespec);var components=[],shapeObj=null,renderedShapeObj=null,geo=new WebMol.Geometry(!0);this.updateStyle=function(newspec){for(var prop in newspec)stylespec[prop]=newspec[prop];updateFromStyle(this,stylespec)},this.addCustom=function(customSpec){customSpec.vertexArr=customSpec.vertexArr||[],customSpec.faceArr=customSpec.faceArr||[],customSpec.normalArr=customSpec.normalArr||[],customSpec.lineArr=customSpec.lineArr||[];var geoGroup=geo.addGeoGroup();drawCustom(this,geoGroup,customSpec),geoGroup.truncateArrayBuffers(!0);for(var i=0;i<geoGroup.__colorArray.length/3;++i)geoGroup.__colorArray[3*i]=this.color.r,geoGroup.__colorArray[3*i+1]=this.color.g,geoGroup.__colorArray[3*i+2]=this.color.b;components.push({id:geoGroup.id,geoGroup:geoGroup,centroid:geoGroup.getCentroid()}),updateBoundingFromPoints(this.boundingSphere,components,geoGroup.__vertexArray)},this.addSphere=function(sphereSpec){sphereSpec.center=sphereSpec.center||{x:0,y:0,z:0},sphereSpec.radius=sphereSpec.radius?WebMol.Math.clamp(sphereSpec.radius,0,1/0):1.5;var geoGroup=geo.addGeoGroup();drawSphere(this,geoGroup,sphereSpec),geoGroup.truncateArrayBuffers(!0),components.push({id:geoGroup.id,geoGroup:geoGroup,centroid:new WebMol.Vector3(sphereSpec.center.x,sphereSpec.center.y,sphereSpec.center.z)}),updateBoundingFromPoints(this.boundingSphere,components,geoGroup.__vertexArray)},this.addArrow=function(arrowSpec){arrowSpec.start=arrowSpec.start||{},arrowSpec.end=arrowSpec.end||{},arrowSpec.start=new WebMol.Vector3(arrowSpec.start.x||0,arrowSpec.start.y||0,arrowSpec.start.z||0),arrowSpec.end=new WebMol.Vector3(arrowSpec.end.x||3,arrowSpec.end.y||0,arrowSpec.end.z||0),arrowSpec.radius=arrowSpec.radius||.25,arrowSpec.radiusRatio=arrowSpec.radiusRatio||1.618034,arrowSpec.mid=0<arrowSpec.mid&&arrowSpec.mid<1?arrowSpec.mid:.618034;var geoGroup=geo.addGeoGroup();drawArrow(this,geoGroup,arrowSpec),geoGroup.truncateArrayBuffers(!0);var centroid=new WebMol.Vector3;components.push({id:geoGroup.id,geoGroup:geoGroup,centroid:centroid.addVectors(arrowSpec.start,arrowSpec.end).multiplyScalar(.5)}),updateBoundingFromPoints(this.boundingSphere,components,geoGroup.__vertexArray)},this.addVolumetricData=function(data,fmt,volSpec){var isoval=void 0!==volSpec.isoval&&"number"==typeof volSpec.isoval?volSpec.isoval:0,vxl=volSpec.voxel?!0:!1,geoGroup=geo.addGeoGroup();switch(fmt){case"cube":parseCube(this,geoGroup,data,isoval,vxl)}components.push({id:geoGroup.id,geoGroup:geoGroup,centroid:geoGroup.getCentroid()}),this.updateStyle(volSpec),updateBoundingFromPoints(this.boundingSphere,components,geoGroup.__vertexArray)},this.globj=function(group){geo.initTypedArrays(),updateColor(geo,this.color),shapeObj=new WebMol.Object3D;var material=new WebMol.MeshLambertMaterial({wireframe:this.wireframe,vertexColors:!0,ambient:0,reflectivity:0,side:this.side,transparent:this.alpha<1?!0:!1,opacity:this.alpha}),mesh=new WebMol.Mesh(geo,material);shapeObj.add(mesh),renderedShapeObj&&(group.remove(renderedShapeObj),renderedShapeObj=null),renderedShapeObj=shapeObj.clone(),group.add(renderedShapeObj)}};return Object.defineProperty(GLShape.prototype,"position",{get:function(){return this.boundingSphere.center}}),Object.defineProperty(GLShape.prototype,"x",{get:function(){return this.boundingSphere.center.x}}),Object.defineProperty(GLShape.prototype,"y",{get:function(){return this.boundingSphere.center.y}}),Object.defineProperty(GLShape.prototype,"z",{get:function(){return this.boundingSphere.center.z}}),GLShape}(),WebMol.ShapeIDCount=0;var WebMol=WebMol||{},roundRect=function(ctx,x,y,w,h,r){ctx.beginPath(),ctx.moveTo(x+r,y),ctx.lineTo(x+w-r,y),ctx.quadraticCurveTo(x+w,y,x+w,y+r),ctx.lineTo(x+w,y+h-r),ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h),ctx.lineTo(x+r,y+h),ctx.quadraticCurveTo(x,y+h,x,y+h-r),ctx.lineTo(x,y+r),ctx.quadraticCurveTo(x,y,x+r,y),ctx.closePath(),ctx.fill()};WebMol.LabelCount=0,WebMol.Label=function(text,parameters){this.id=WebMol.LabelCount++,this.stylespec=parameters||{},this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.sprite=new WebMol.Sprite,this.text=text},WebMol.Label.prototype={constructor:WebMol.Label,setContext:function(){this.font=this.stylespec.font=this.stylespec.font?this.stylespec.font:"Arial",this.fontSize=this.stylespec.fontSize=this.stylespec.fontSize?this.stylespec.fontSize:20,this.fontColor=this.stylespec.fontColor=this.stylespec.fontColor?this.stylespec.fontColor:{r:255,g:255,b:255,a:1},this.borderThickness=this.stylespec.borderThickness=this.stylespec.borderThickness?this.stylespec.borderThickness:4,this.borderColor=this.stylespec.borderColor=this.stylespec.borderColor?this.stylespec.borderColor:{r:0,g:0,b:0,a:1},this.backgroundColor=this.stylespec.backgroundColor=this.stylespec.backgroundColor?this.stylespec.backgroundColor:{r:0,g:0,b:0,a:1},this.position=this.stylespec.position=this.stylespec.position?this.stylespec.position:{x:-10,y:1,z:1},this.inFront=this.stylespec.inFront=void 0!==this.stylespec.inFront?this.stylespec.inFront:!0,this.context.clearRect(0,0,this.canvas.width,this.canvas.height);var spriteAlignment=WebMol.SpriteAlignment.topLeft;this.context.font=this.fontSize+"pt "+this.font;var metrics=this.context.measureText(this.text),textWidth=metrics.width;this.context.fillStyle="rgba("+this.backgroundColor.r+","+this.backgroundColor.g+","+this.backgroundColor.b+","+this.backgroundColor.a+")",this.context.strokeStyle="rgba("+this.borderColor.r+","+this.borderColor.g+","+this.borderColor.b+","+this.borderColor.a+")",this.context.lineWidth=this.borderThickness,roundRect(this.context,this.borderThickness/2,this.borderThickness/2,textWidth+this.borderThickness,1.4*this.fontSize+this.borderThickness,6),this.context.fillStyle="rgba("+this.fontColor.r+","+this.fontColor.g+","+this.fontColor.b+","+this.fontColor.a+")",this.context.fillText(this.text,this.borderThickness,this.fontSize+this.borderThickness,textWidth);var texture=new WebMol.Texture(this.canvas);texture.needsUpdate=!0,this.sprite.material=new WebMol.SpriteMaterial({map:texture,useScreenCoordinates:!1,alignment:spriteAlignment,depthTest:!this.inFront}),this.sprite.scale.set(2*this.fontSize,this.fontSize,1),this.sprite.position.set(this.position.x,this.position.y,this.position.z)},dispose:function(){void 0!==this.sprite.material.map&&this.sprite.material.map.dispose(),void 0!==this.sprite.material&&this.sprite.material.dispose()}},WebMol.GLViewer=function(){function GLViewer(element,callback,defaultcolors){function getAtomsFromSel(sel){var atoms=[];"undefined"==typeof sel&&(sel={});var ms=[];if("undefined"==typeof sel.model)for(var i=0;i<models.length;i++)models[i]&&ms.push(models[i]);else{var ms=sel.model;$.isArray(ms)||(ms=[ms])}for(var i=0;i<ms.length;i++)atoms=atoms.concat(ms[i].selectedAtoms(sel));return atoms}function atomIsSelected(atom,sel){"undefined"==typeof sel&&(sel={});var ms=[];if("undefined"==typeof sel.model)for(var i=0;i<models.length;i++)models[i]&&ms.push(models[i]);else{var ms=sel.model;$.isArray(ms)||(ms=[ms])}for(var i=0;i<ms.length;i++)if(ms[i].atomIsSelected(atom,sel))return!0;return!1}function applyToModels(func,sel,value1,value2){for(var i=0;i<models.length;i++)models[i]&&models[i][func](sel,value1,value2)}function getMatWithStyle(style){var mat=new WebMol.MeshLambertMaterial;mat.vertexColors=WebMol.VertexColors;for(var prop in style)"color"===prop?(mat[prop]=WebMol.CC.color(style.color),delete mat.vertexColors):"map"===prop||style.hasOwnProperty(prop)&&(mat[prop]=style[prop]);return void 0!==style.opacity&&(mat.transparent=1===style.opacity?!1:!0),mat}function getPropertyRange(atomlist,prop){for(var min=Number.POSITIVE_INFINITY,max=Number.NEGATIVE_INFINITY,i=0,n=atomlist.length;n>i;i++){var atom=atomlist[i];if(atom.properties&&"undefined"!=typeof atom.properties[prop]){var val=atom.properties[prop];min>val&&(min=val),val>max&&(max=val)}}return isFinite(min)||isFinite(max)?isFinite(min)?isFinite(max)||(max=min):min=max:min=max=0,[min,max]}var _viewer=this,container=element,id=container.id,models=[],surfaces=[],shapes=[],WIDTH=container.width(),HEIGHT=container.height(),spinner=$('<div class="glviewerSpinnerWrap" style = "position: absolute; width: 100%; height: 100%; display: table; z-index: 1;"><div class="glviewerSpinner" style="display: table-cell; text-align: center; vertical-align: middle; z-index:1"><img src="webmol/spinner.gif"></div></div>');$(element).append(spinner),spinner.hide();var ASPECT=WIDTH/HEIGHT,CAMERA_Z=150,renderer=new WebMol.Renderer({antialias:!0});renderer.domElement.style.width="100%",renderer.domElement.style.height="100%",renderer.domElement.style.position="absolute",renderer.domElement.style.top="0px",renderer.domElement.style.zIndex="0",container.append(renderer.domElement),renderer.setSize(WIDTH,HEIGHT);var camera=new WebMol.Camera(20,ASPECT,1,800);camera.position=new TV3(0,0,CAMERA_Z),camera.lookAt(new TV3(0,0,0));var raycaster=new WebMol.Raycaster(new TV3(0,0,0),new TV3(0,0,0)),projector=new WebMol.Projector,mouseVector=new WebMol.Vector3(0,0,0),scene=null,rotationGroup=null,modelGroup=null,bgColor=0,fov=20,fogStart=.4,slabNear=-50,slabFar=50,cq=new WebMol.Quaternion(0,0,0,1),dq=new WebMol.Quaternion(0,0,0,1),isDragging=!1,mouseStartX=0,mouseStartY=0,currentModelPos=0,cz=0,cslabNear=0,cslabFar=0,setSlabAndFog=function(){var center=camera.position.z-rotationGroup.position.z;1>center&&(center=1),camera.near=center+slabNear,camera.near<1&&(camera.near=1),camera.far=center+slabFar,camera.near+1>camera.far&&(camera.far=camera.near+1),camera instanceof WebMol.Camera?camera.fov=fov:(camera.right=center*Math.tan(Math.PI/180*fov),camera.left=-camera.right,camera.top=camera.right/ASPECT,camera.bottom=-camera.top),camera.updateProjectionMatrix(),scene.fog.near=camera.near+fogStart*(camera.far-camera.near),scene.fog.far=camera.far},show=function(){scene&&(setSlabAndFog(),renderer.render(scene,camera))},initializeScene=function(){scene=new WebMol.Scene,scene.fog=new WebMol.Fog(bgColor,100,200),modelGroup=new WebMol.Object3D,rotationGroup=new WebMol.Object3D,rotationGroup.useQuaternion=!0,rotationGroup.quaternion=new WebMol.Quaternion(0,0,0,1),rotationGroup.add(modelGroup),scene.add(rotationGroup);var directionalLight=new WebMol.Light(16777215);directionalLight.position=new TV3(.2,.2,1).normalize(),directionalLight.intensity=1,scene.add(directionalLight)};initializeScene(),renderer.setClearColorHex(bgColor,1),scene.fog.color=WebMol.CC.color(bgColor);var clickedAtom=null,glDOM=$(renderer.domElement),handleClickSelection=function(mouseX,mouseY){var mouse={x:mouseX,y:mouseY,z:-1};mouseVector.set(mouse.x,mouse.y,mouse.z),projector.unprojectVector(mouseVector,camera),mouseVector.sub(camera.position).normalize(),raycaster.set(camera.position,mouseVector);var clickables=[],intersects=[];for(var i in models){var model=models[i],atoms=model.selectedAtoms({clickable:!0});clickables=clickables.concat(atoms)}for(var i in shapes){var shape=shapes[i];shape.clickable&&clickables.push(shape)}if(intersects=raycaster.intersectObjects(modelGroup,clickables),intersects.length){var selected=intersects[0].clickable;void 0!==selected.callback&&"function"==typeof selected.callback&&selected.callback(selected,_viewer)}show()};glDOM.bind("mousedown touchstart",function(ev){if(ev.preventDefault(),scene){var x=ev.pageX,y=ev.pageY;if(ev.originalEvent.targetTouches&&ev.originalEvent.targetTouches[0]&&(x=ev.originalEvent.targetTouches[0].pageX,y=ev.originalEvent.targetTouches[0].pageY),void 0!==x){isDragging=!0,clickedAtom=null,mouseButton=ev.which,mouseStartX=x,mouseStartY=y,cq=rotationGroup.quaternion,cz=rotationGroup.position.z,currentModelPos=modelGroup.position.clone(),cslabNear=slabNear,cslabFar=slabFar;var mouseX=x/$(window).width()*2-1,mouseY=2*-(y/HEIGHT)+1;handleClickSelection(mouseX,mouseY,ev,container)}}}),glDOM.bind("DOMMouseScroll mousewheel",function(ev){if(ev.preventDefault(),scene){var scaleFactor=.85*(CAMERA_Z-rotationGroup.position.z);ev.originalEvent.detail?rotationGroup.position.z+=scaleFactor*ev.originalEvent.detail/10:ev.originalEvent.wheelDelta&&(rotationGroup.position.z-=scaleFactor*ev.originalEvent.wheelDelta/400),show()}}),glDOM.bind("contextmenu",function(ev){ev.preventDefault()}),$("body").bind("mouseup touchend",function(){isDragging=!1}),glDOM.bind("mousemove touchmove",function(ev){if(ev.preventDefault(),scene&&isDragging){var mode=0,modeRadio=$("input[name="+id+"_mouseMode]:checked");modeRadio.length>0&&(mode=parseInt(modeRadio.val()));var x=ev.pageX,y=ev.pageY;if(ev.originalEvent.targetTouches&&ev.originalEvent.targetTouches[0]&&(x=ev.originalEvent.targetTouches[0].pageX,y=ev.originalEvent.targetTouches[0].pageY),void 0!=x){var dx=(x-mouseStartX)/WIDTH,dy=(y-mouseStartY)/HEIGHT,r=Math.sqrt(dx*dx+dy*dy);if(3==mode||3==mouseButton&&ev.ctrlKey)slabNear=cslabNear+100*dx,slabFar=cslabFar+100*dy;else if(2==mode||3==mouseButton||ev.shiftKey){var scaleFactor=.85*(CAMERA_Z-rotationGroup.position.z);80>scaleFactor&&(scaleFactor=80),rotationGroup.position.z=cz-dy*scaleFactor}else if(1==mode||2==mouseButton||ev.ctrlKey){var scaleFactor=.85*(CAMERA_Z-rotationGroup.position.z);20>scaleFactor&&(scaleFactor=20);var translationByScreen=new TV3(dx*scaleFactor,-dy*scaleFactor,0),q=rotationGroup.quaternion,qinv=new WebMol.Quaternion(q.x,q.y,q.z,q.w).inverse().normalize(),translation=translationByScreen.applyQuaternion(qinv);modelGroup.position.x=currentModelPos.x+translation.x,modelGroup.position.y=currentModelPos.y+translation.y,modelGroup.position.z=currentModelPos.z+translation.z}else if((0==mode||1==mouseButton)&&0!=r){var rs=Math.sin(r*Math.PI)/r;dq.x=Math.cos(r*Math.PI),dq.y=0,dq.z=rs*dx,dq.w=-rs*dy,rotationGroup.quaternion=new WebMol.Quaternion(1,0,0,0),rotationGroup.quaternion.multiply(dq),rotationGroup.quaternion.multiply(cq)}show()}}}),this.setBackgroundColor=function(hex,a){a=1|a,bgColor=hex,renderer.setClearColorHex(hex,a),scene.fog.color=WebMol.CC.color(hex),show()},this.setWidth=function(w){WIDTH=w||WIDTH,renderer.setSize(WIDTH,HEIGHT)},this.setHeight=function(h){HEIGHT=h||HEIGHT,renderer.setSize(WIDTH,HEIGHT)},this.resize=function(){WIDTH=container.width(),HEIGHT=container.height(),ASPECT=WIDTH/HEIGHT,renderer.setSize(WIDTH,HEIGHT),camera.aspect=ASPECT,camera.updateProjectionMatrix(),show()},$(window).resize(this.resize),this.getModel=function(id){return id=id||models.length-1,models[id]},this.getView=function(){if(!modelGroup)return[0,0,0,0,0,0,0,1];var pos=modelGroup.position,q=rotationGroup.quaternion;return[pos.x,pos.y,pos.z,rotationGroup.position.z,q.x,q.y,q.z,q.w]},this.setView=function(arg){void 0!==arg&&(arg instanceof Array||8!==arg.length)&&modelGroup&&rotationGroup&&(modelGroup.position.x=arg[0],modelGroup.position.y=arg[1],modelGroup.position.z=arg[2],rotationGroup.position.z=arg[3],rotationGroup.quaternion.x=arg[4],rotationGroup.quaternion.y=arg[5],rotationGroup.quaternion.z=arg[6],rotationGroup.quaternion.w=arg[7],show())},this.render=function(){for(var time1=new Date,view=this.getView(),i=0;i<models.length;i++)models[i]&&models[i].globj(modelGroup);for(var i=0;i<shapes.length;i++)shapes[i]&&shapes[i].globj(modelGroup);for(var i in surfaces)if(surfaces.hasOwnProperty(i)){var geo=surfaces[i].geo;if(!surfaces[i].finished){geo.verticesNeedUpdate=!0,geo.elementsNeedUpdate=!0,geo.normalsNeedUpdate=!0,geo.colorsNeedUpdate=!0,geo.buffersNeedUpdate=!0,geo.boundingSphere=null,surfaces[i].done&&(surfaces[i].finished=!0),surfaces[i].lastGL&&modelGroup.remove(surfaces[i].lastGL);var smesh=new WebMol.Mesh(geo,surfaces[i].mat);surfaces[i].lastGL=smesh,modelGroup.add(smesh)}}this.setView(view);var time2=new Date;spinner.hide(),console.log("render time: "+(time2-time1))},this.pdbData=function(sel){for(var atoms=getAtomsFromSel(sel),ret="",i=0,n=atoms.length;n>i;++i)ret+=atoms[i].pdbline+"\n";return ret},this.zoomTo=function(sel){var atoms=getAtomsFromSel(sel).concat(shapes),allatoms=getAtomsFromSel({}).concat(shapes),tmp=getExtent(atoms),alltmp=getExtent(allatoms),center=new TV3(tmp[2][0],tmp[2][1],tmp[2][2]);modelGroup.position=center.multiplyScalar(-1);var x=alltmp[1][0]-alltmp[0][0],y=alltmp[1][1]-alltmp[0][1],z=alltmp[1][2]-alltmp[0][2],maxD=Math.sqrt(x*x+y*y+z*z);25>maxD&&(maxD=25),slabNear=-maxD/1.9,slabFar=maxD/3,x=tmp[1][0]-tmp[0][0],y=tmp[1][1]-tmp[0][1],z=tmp[1][2]-tmp[0][2],maxD=Math.sqrt(x*x+y*y+z*z),25>maxD&&(maxD=25),rotationGroup.position.z=-(.35*maxD/Math.tan(Math.PI/180*camera.fov/2)-150),show()},this.addLabel=function(text,data){var label=new WebMol.Label(text,data);return label.setContext(),modelGroup.add(label.sprite),label},this.removeLabel=function(label){label.dispose(),modelGroup.remove(label.sprite)},this.setLabelStyle=function(label,stylespec){return label.dispose(),label.stylespec=stylespec,label.setContext(),modelGroup.add(label.sprite),label},this.setLabelText=function(label,text){return label.dispose(),label.text=text,label.setContext(),modelGroup.add(label.sprite),label},this.addShape=function(shapeSpec){shapeSpec=shapeSpec||{};var shape=new WebMol.GLShape(shapes.length,shapeSpec);return shapes.push(shape),shape},this.addSphere=function(spec){var s=new WebMol.GLShape(shapes.length);return spec=spec||{},s.addSphere(spec),shapes.push(s),s},this.addArrow=function(spec){var s=new WebMol.GLShape(shapes.length);return spec=spec||{},s.addArrow(spec),shapes.push(s),s},this.addCustom=function(spec){var s=new WebMol.GLShape(shapes.length);return spec=spec||{},s.addCustom(spec),shapes.push(s),s},this.addVolumetricData=function(data,format,spec){var s=new WebMol.GLShape(shapes.length);return spec=spec||{},s.addVolumetricData(data,format,spec),shapes.push(s),s},this.addModel=function(data,format){var m=new WebMol.GLModel(models.length,defaultcolors);return m.addMolData(data,format),models.push(m),m},this.removeModel=function(model){if(model)for(model.removegl(modelGroup),delete models[model.getID()];models.length>0&&"undefined"==typeof models[models.length-1];)models.pop()},this.removeAllModels=function(){for(var i=0;i<models.length;i++){var model=models[i];model.removegl(modelGroup)}models=[]},this.createModelFrom=function(sel,extract){for(var m=new WebMol.GLModel(models.length,defaultcolors),i=0;i<models.length;i++)if(models[i]){var atoms=models[i].selectedAtoms(sel);m.addAtoms(atoms),extract&&models[i].removeAtoms(atoms)}return models.push(m),m},this.setStyle=function(sel,style){applyToModels("setStyle",sel,style,!1)},this.addStyle=function(sel,style){applyToModels("setStyle",sel,style,!0)},this.setColorByProperty=function(sel,prop,scheme){applyToModels("setColorByProperty",sel,prop,scheme)},this.setColorByElement=function(sel,colors){applyToModels("setColorByElement",sel,colors)};var getAtomsWithin=function(atomlist,extent){for(var ret=[],i=0;i<atomlist.length;i++){var atom=atomlist[i];"undefined"!=typeof atom&&(atom.x<extent[0][0]||atom.x>extent[1][0]||atom.y<extent[0][1]||atom.y>extent[1][1]||atom.z<extent[0][2]||atom.z>extent[1][2]||ret.push(i))}return ret},volume=function(extent){var w=extent[1][0]-extent[0][0],h=extent[1][1]-extent[0][1],d=extent[1][2]-extent[0][2];return w*h*d},carveUpExtent=function(extent,atomlist,atomstoshow){for(var ret=[],copyExtent=function(extent){var ret=[];return ret[0]=[extent[0][0],extent[0][1],extent[0][2]],ret[1]=[extent[1][0],extent[1][1],extent[1][2]],ret},splitExtentR=function(extent){if(volume(extent)<maxVolume)return[extent];var index,w=extent[1][0]-extent[0][0],h=extent[1][1]-extent[0][1],d=extent[1][2]-extent[0][2];index=w>h&&w>d?0:h>w&&h>d?1:2;var a=copyExtent(extent),b=copyExtent(extent),mid=(extent[1][index]-extent[0][index])/2+extent[0][index];a[1][index]=mid,b[0][index]=mid;var alist=splitExtentR(a),blist=splitExtentR(b);return alist.concat(blist)},splits=splitExtentR(extent),ret=[],off=6,i=0,n=splits.length;n>i;i++){var e=copyExtent(splits[i]);e[0][0]-=off,e[0][1]-=off,e[0][2]-=off,e[1][0]+=off,e[1][1]+=off,e[1][2]+=off;var atoms=getAtomsWithin(atomlist,e),toshow=getAtomsWithin(atomstoshow,splits[i]);ret.push({extent:splits[i],atoms:atoms,toshow:toshow})}return ret},generateSurfaceMesh=function(atoms,VandF,mat){for(var offset,geo=new WebMol.Geometry(!0),geoGroup=geo.updateGeoGroup(0),v=VandF.vertices,i=0;i<v.length;i++)offset=3*geoGroup.vertices,geoGroup.__vertexArray[offset]=v[i].x,geoGroup.__vertexArray[offset+1]=v[i].y,geoGroup.__vertexArray[offset+2]=v[i].z,geoGroup.vertices++;var faces=VandF.faces;geoGroup.faceidx=faces.length,geo.initTypedArrays();for(var colors=[],i=0;i<atoms.length;i++){var atom=atoms[i];atom&&("undefined"!=typeof atom.surfaceColor?colors[i]=WebMol.CC.color(atom.surfaceColor):atom.color&&(colors[i]=WebMol.CC.color(atom.color)))}for(var vA,vB,vC,norm,faceoffset,verts=geoGroup.__vertexArray,i=0;i<faces.length;i+=3){faceoffset=i;var a=faces[i],b=faces[i+1],c=faces[i+2],A=v[a].atomid,B=v[b].atomid,C=v[c].atomid,offsetA=3*a,offsetB=3*b,offsetC=3*c;geoGroup.__faceArray[faceoffset]=faces[i].a,geoGroup.__faceArray[faceoffset+1]=faces[i].b,geoGroup.__faceArray[faceoffset+2]=faces[i].c,geoGroup.__colorArray[offsetA]=colors[A].r,geoGroup.__colorArray[offsetA+1]=colors[A].g,geoGroup.__colorArray[offsetA+2]=colors[A].b,geoGroup.__colorArray[offsetB]=colors[B].r,geoGroup.__colorArray[offsetB+1]=colors[B].g,geoGroup.__colorArray[offsetB+2]=colors[B].b,geoGroup.__colorArray[offsetC]=colors[C].r,geoGroup.__colorArray[offsetC+1]=colors[C].g,geoGroup.__colorArray[offsetC+2]=colors[C].b,vA=new TV3(verts[offsetA],verts[offsetA+1],verts[offsetA+2]),vB=new TV3(verts[offsetB],verts[offsetB+1],verts[offsetB+2]),vC=new TV3(verts[offsetC],verts[offsetC+1],verts[offsetC+2]),vC.subVectors(vC,vB),vA.subVectors(vA,vB),vC.cross(vA),norm=vC,norm.normalize(),geoGroup.__normalArray[offsetA]+=norm.x,geoGroup.__normalArray[offsetB]+=norm.x,geoGroup.__normalArray[offsetC]+=norm.x,geoGroup.__normalArray[offsetA+1]+=norm.y,geoGroup.__normalArray[offsetB+1]+=norm.y,geoGroup.__normalArray[offsetC+1]+=norm.y,geoGroup.__normalArray[offsetA+2]+=norm.z,geoGroup.__normalArray[offsetB+2]+=norm.z,geoGroup.__normalArray[offsetC+2]+=norm.z}geoGroup.__faceArray=new Uint16Array(faces);var mesh=new WebMol.Mesh(geo,mat);return mesh.doubleSided=!0,mesh},generateMeshSyncHelper=function(type,expandedExtent,extendedAtoms,atomsToShow,atoms,vol){var time=new Date,ps=new ProteinSurface;ps.initparm(expandedExtent,1===type?!1:!0,vol);var time2=new Date;console.log("initialize "+(time2-time)+"ms"),ps.fillvoxels(atoms,extendedAtoms);var time3=new Date;console.log("fillvoxels "+(time3-time2)+"  "+(time3-time)+"ms"),ps.buildboundary(),type==WebMol.SurfaceType.SES&&(ps.fastdistancemap(),ps.boundingatom(!1),ps.fillvoxelswaals(atoms,extendedAtoms));var time4=new Date;console.log("buildboundaryetc "+(time4-time3)+"  "+(time4-time)+"ms"),ps.marchingcube(type);var time5=new Date;return console.log("marching cube "+(time5-time4)+"  "+(time5-time)+"ms"),ps.getFacesAndVertices(atomsToShow)};this.addSurface=function(type,style,atomsel,allsel,focus,sync){var atomsToShow=getAtomsFromSel(atomsel),atomlist=getAtomsFromSel(allsel),focusSele=getAtomsFromSel(focus),time=new Date,mat=getMatWithStyle(style),extent=getExtent(atomsToShow);if(style.map&&style.map.prop){var prop=style.map.prop,scheme=style.map.scheme||new WebMol.RWB,range=scheme.range();range||(range=getPropertyRange(atomsToShow,prop));for(var i=0,n=atomsToShow.length;n>i;i++){var atom=atomsToShow[i];atom.surfaceColor=scheme.valueToHex(atom.properties[prop],range)}}var totalVol=volume(extent),extents=carveUpExtent(extent,atomlist,atomsToShow);if(focusSele&&focusSele.length&&focusSele.length>0){var seleExtent=getExtent(focusSele),sortFunc=function(a,b){var distSq=function(ex,sele){var e=ex.extent,x=e[1][0]-e[0][0],y=e[1][1]-e[0][1],z=e[1][2]-e[0][2],dx=x-sele[2][0];dx*=dx;var dy=y-sele[2][1];dy*=dy;var dz=z-sele[2][2];return dz*=dz,dx+dy+dz},d1=distSq(a,seleExtent),d2=distSq(b,seleExtent);return d1-d2};extents.sort(sortFunc)}console.log("Extents "+extents.length+"  "+(+new Date-time)+"ms");var surfobj={geo:new WebMol.Geometry(!0),mat:mat,done:!1,finished:!1},surfid=surfaces.length;surfaces[surfid]=surfobj;for(var reducedAtoms=[],i=0,n=atomlist.length;n>i;i++){var atom=atomlist[i];reducedAtoms[i]={x:atom.x,y:atom.y,z:atom.z,serial:i,elem:atom.elem}}var sync=!!sync,view=this;if(sync)for(var i=0;i<extents.length;i++){var VandF=generateMeshSyncHelper(type,extents[i].extent,extents[i].atoms,extents[i].toshow,reducedAtoms,totalVol),mesh=generateSurfaceMesh(atomlist,VandF,mat);WebMol.mergeGeos(surfobj.geo,mesh),view.render()}else{var workers=[];0>type&&(type=0);for(var i=0;numWorkers>i;i++){var w=new Worker(WebMol.SurfaceWorker);workers.push(w),w.postMessage({type:-1,atoms:reducedAtoms,volume:totalVol})}for(var cnt=0,i=0;i<extents.length;i++){var worker=workers[i%workers.length];worker.onmessage=function(event){var VandF=event.data,mesh=generateSurfaceMesh(atomlist,VandF,mat);WebMol.mergeGeos(surfobj.geo,mesh),view.render(),console.log("async mesh generation "+(+new Date-time)+"ms"),cnt++,cnt==extents.length&&(surfobj.done=!0)},worker.onerror=function(event){console.log(event.message+" ("+event.filename+":"+event.lineno+")")},worker.postMessage({type:type,expandedExtent:extents[i].extent,extendedAtoms:extents[i].atoms,atomsToShow:extents[i].toshow})}}return console.log("full mesh generation "+(+new Date-time)+"ms"),surfid},this.setSurfaceMaterialStyle=function(surf,style){surfaces[surf]&&(surfaces[surf].mat=getMatWithStyle(style),surfaces[surf].mat.side=WebMol.FrontSide,surfaces[surf].finished=!1)},this.removeSurface=function(surf){surfaces[surf]&&surfaces[surf].lastGL&&(void 0!==surfaces[surf].geo&&surfaces[surf].geo.dispose(),void 0!==surfaces[surf].mat&&surfaces[surf].mat.dispose(),modelGroup.remove(surfaces[surf].lastGL)),delete surfaces[surf],show()},this.jmolMoveTo=function(){var pos=modelGroup.position,ret="center { "+-pos.x+" "+-pos.y+" "+-pos.z+" }; ",q=rotationGroup.quaternion;return ret+="moveto .5 quaternion { "+q.x+" "+q.y+" "+q.z+" "+q.w+" };"},this.clear=function(){surfaces=[],this.removeAllModels(),show()},this.mapAtomProperties=function(props){for(var atoms=getAtomsFromSel({}),a=0,numa=atoms.length;numa>a;a++)for(var atom=atoms[a],i=0,n=props.length;n>i;i++){var prop=props[i];if(prop.props)for(var p in prop.props)prop.props.hasOwnProperty(p)&&atomIsSelected(atom,prop)&&(atom.properties||(atom.properties={}),atom.properties[p]=prop.props[p])}},getModelGroup=function(){return modelGroup};try{"function"==typeof callback&&callback(this)}catch(e){console.log("error with glviewer callback: "+e)}}var numWorkers=4,maxVolume=64e3,getExtent=function(atomlist){var xmin,ymin,zmin,xmax,ymax,zmax,xsum,ysum,zsum,cnt;if(xmin=ymin=zmin=9999,xmax=ymax=zmax=-9999,xsum=ysum=zsum=cnt=0,0===atomlist.length)return[[0,0,0],[0,0,0],[0,0,0]];for(var i=0;i<atomlist.length;i++){var atom=atomlist[i];void 0!==atom&&(cnt++,xsum+=atom.x,ysum+=atom.y,zsum+=atom.z,xmin=xmin<atom.x?xmin:atom.x,ymin=ymin<atom.y?ymin:atom.y,zmin=zmin<atom.z?zmin:atom.z,xmax=xmax>atom.x?xmax:atom.x,ymax=ymax>atom.y?ymax:atom.y,zmax=zmax>atom.z?zmax:atom.z)}return[[xmin,ymin,zmin],[xmax,ymax,zmax],[xsum/cnt,ysum/cnt,zsum/cnt]]};return GLViewer}(),WebMol.glmolViewer=WebMol.GLViewer,WebMol=WebMol||{},WebMol.MarchingCube=function(){var ISDONE=2,my={};my.march=function(data,verts,faces,spec){for(var fulltable=!!spec.fulltable,origin=spec.hasOwnProperty("origin")&&spec.origin.hasOwnProperty("x")?spec.origin:{x:0,y:0,z:0},voxel=!!spec.voxel,nX=spec.nX||0,nY=spec.nY||0,nZ=spec.nZ||0,scale=spec.scale||1,unitCube=new WebMol.Vector3(1,1,1).multiplyScalar(scale),vertnums=new Int32Array(nX*nY*nZ),i=0;i<vertnums.length;++i)vertnums[i]=-1;for(var getVertex=function(i,j,k,code,p1,p2){var pt=new WebMol.Vector3;pt.copy(origin);var val1=!!(code&1<<p1),val2=!!(code&1<<p2),p=p1;!val1&&val2&&(p=p2),1&p&&k++,2&p&&j++,4&p&&i++,pt.x+=unitCube.x*i,pt.y+=unitCube.y*j,pt.z+=unitCube.z*k;var index=(nY*i+j)*nZ+k;return voxel?(verts.push(pt),verts.length-1):(vertnums[index]<0&&(vertnums[index]=verts.length,verts.push(pt)),vertnums[index])},intersects=new Int32Array(12),etable=fulltable?edgeTable2:edgeTable,tritable=fulltable?triTable2:triTable,i=0;nX-1>i;++i)for(var j=0;nY-1>j;++j)for(var k=0;nZ-1>k;++k){for(var code=0,p=0;8>p;++p){var index=(nY*(i+((4&p)>>2))+j+((2&p)>>1))*nZ+k+(1&p),val=!!(data[index]&ISDONE);code|=val<<p}if(0!==code&&255!==code){var ecode=etable[code];if(0!==ecode){var ttable=tritable[code];1&ecode&&(intersects[0]=getVertex(i,j,k,code,0,1)),2&ecode&&(intersects[1]=getVertex(i,j,k,code,1,3)),4&ecode&&(intersects[2]=getVertex(i,j,k,code,3,2)),8&ecode&&(intersects[3]=getVertex(i,j,k,code,2,0)),16&ecode&&(intersects[4]=getVertex(i,j,k,code,4,5)),32&ecode&&(intersects[5]=getVertex(i,j,k,code,5,7)),64&ecode&&(intersects[6]=getVertex(i,j,k,code,7,6)),128&ecode&&(intersects[7]=getVertex(i,j,k,code,6,4)),256&ecode&&(intersects[8]=getVertex(i,j,k,code,0,4)),512&ecode&&(intersects[9]=getVertex(i,j,k,code,1,5)),1024&ecode&&(intersects[10]=getVertex(i,j,k,code,3,7)),2048&ecode&&(intersects[11]=getVertex(i,j,k,code,2,6));for(var t=0;t<ttable.length;t+=3){var a=intersects[ttable[t]],b=intersects[ttable[t+1]],c=intersects[ttable[t+2]];voxel&&t>=3&&(verts.push(verts[a]),a=verts.length-1,verts.push(verts[b]),b=verts.length-1,verts.push(verts[c]),c=verts.length-1),faces.push(a),faces.push(b),faces.push(c)}}}}},my.laplacianSmooth=function(numiter,verts,faces){for(var tps=new Array(verts.length),i=0;i<verts.length;i++)tps[i]={x:0,y:0,z:0};for(var flagvert,vertdeg=new Array(20),i=0;20>i;i++)vertdeg[i]=new Array(verts.length);for(var i=0;i<verts.length;i++)vertdeg[0][i]=0;for(var i=0;i<faces.length/3;i++){var aoffset=3*i,boffset=3*i+1,coffset=3*i+2;flagvert=!0;for(var j=0;j<vertdeg[0][faces[aoffset]];j++)if(faces[boffset]==vertdeg[j+1][faces[aoffset]]){flagvert=!1;break}flagvert&&(vertdeg[0][faces[aoffset]]++,vertdeg[vertdeg[0][faces[aoffset]]][faces[aoffset]]=faces[boffset]),flagvert=!0;for(var j=0;j<vertdeg[0][faces[aoffset]];j++)if(faces[coffset]==vertdeg[j+1][faces[aoffset]]){flagvert=!1;break}for(flagvert&&(vertdeg[0][faces[aoffset]]++,vertdeg[vertdeg[0][faces[aoffset]]][faces[aoffset]]=faces[coffset]),flagvert=!0,j=0;j<vertdeg[0][faces[boffset]];j++)if(faces[aoffset]==vertdeg[j+1][faces[boffset]]){flagvert=!1;break}for(flagvert&&(vertdeg[0][faces[boffset]]++,vertdeg[vertdeg[0][faces[boffset]]][faces[boffset]]=faces[aoffset]),flagvert=!0,j=0;j<vertdeg[0][faces[boffset]];j++)if(faces[coffset]==vertdeg[j+1][faces[boffset]]){flagvert=!1;break}for(flagvert&&(vertdeg[0][faces[boffset]]++,vertdeg[vertdeg[0][faces[boffset]]][faces[boffset]]=faces[coffset]),flagvert=!0,j=0;j<vertdeg[0][faces[coffset]];j++)if(faces[aoffset]==vertdeg[j+1][faces[coffset]]){flagvert=!1;break}for(flagvert&&(vertdeg[0][faces[coffset]]++,vertdeg[vertdeg[0][faces[coffset]]][faces[coffset]]=faces[aoffset]),flagvert=!0,j=0;j<vertdeg[0][faces[coffset]];j++)if(faces[boffset]==vertdeg[j+1][faces[coffset]]){flagvert=!1;
break}flagvert&&(vertdeg[0][faces[coffset]]++,vertdeg[vertdeg[0][faces[coffset]]][faces[coffset]]=faces[boffset])}for(var wt=1,wt2=.5,k=0;numiter>k;k++){for(var i=0;i<verts.length;i++)if(vertdeg[0][i]<3)tps[i].x=verts[i].x,tps[i].y=verts[i].y,tps[i].z=verts[i].z;else if(3==vertdeg[0][i]||4==vertdeg[0][i]){for(tps[i].x=0,tps[i].y=0,tps[i].z=0,j=0;j<vertdeg[0][i];j++)tps[i].x+=verts[vertdeg[j+1][i]].x,tps[i].y+=verts[vertdeg[j+1][i]].y,tps[i].z+=verts[vertdeg[j+1][i]].z;tps[i].x+=wt2*verts[i].x,tps[i].y+=wt2*verts[i].y,tps[i].z+=wt2*verts[i].z,tps[i].x/=wt2+vertdeg[0][i],tps[i].y/=wt2+vertdeg[0][i],tps[i].z/=wt2+vertdeg[0][i]}else{tps[i].x=0,tps[i].y=0,tps[i].z=0;for(var j=0;j<vertdeg[0][i];j++)tps[i].x+=verts[vertdeg[j+1][i]].x,tps[i].y+=verts[vertdeg[j+1][i]].y,tps[i].z+=verts[vertdeg[j+1][i]].z;tps[i].x+=wt*verts[i].x,tps[i].y+=wt*verts[i].y,tps[i].z+=wt*verts[i].z,tps[i].x/=wt+vertdeg[0][i],tps[i].y/=wt+vertdeg[0][i],tps[i].z/=wt+vertdeg[0][i]}for(var i=0;i<verts.length;i++)verts[i].x=tps[i].x,verts[i].y=tps[i].y,verts[i].z=tps[i].z}};var edgeTable=new Uint32Array([0,0,0,0,0,0,0,2816,0,0,0,1792,0,3328,3584,3840,0,0,0,138,0,21,0,134,0,0,0,652,0,2067,3865,3600,0,0,0,42,0,0,0,294,0,0,21,28,0,3875,1049,3360,0,168,162,170,0,645,2475,2210,0,687,293,172,4010,3747,3497,3232,0,0,0,0,0,69,0,900,0,0,0,1792,138,131,1608,1920,0,81,0,2074,84,85,84,86,0,81,0,3676,330,1105,1881,1616,0,0,0,42,0,69,0,502,0,0,21,3580,138,2035,1273,1520,2816,104,2337,106,840,581,367,102,2816,3695,3429,3180,1898,1635,1385,1120,0,0,0,0,0,0,0,3910,0,0,69,588,42,2083,41,2880,0,0,0,1722,0,2293,4095,3830,0,255,757,764,2538,2291,3065,2800,0,0,81,338,0,3925,1119,3414,84,855,85,340,2130,2899,89,2384,1792,712,194,1162,4036,3781,3535,3270,708,719,197,204,3018,2755,2505,2240,0,0,0,0,168,420,168,1958,162,162,676,2988,170,163,680,928,3328,3096,3328,3642,52,53,1855,1590,2340,2111,2869,2620,298,51,825,560,3584,3584,3090,3482,1668,1941,1183,1430,146,2975,2069,2460,154,915,153,400,3840,3592,3329,3082,1796,1541,1295,1030,2818,2575,2309,2060,778,515,265,0]),triTable=[[],[],[],[],[],[],[],[11,9,8],[],[],[],[8,10,9],[],[10,8,11],[9,11,10],[8,10,9,8,11,10],[],[],[],[1,7,3],[],[4,2,0],[],[2,1,7],[],[],[],[2,7,3,2,9,7],[],[1,4,11,1,0,4],[3,8,0,11,9,4,11,10,9],[4,11,9,11,10,9],[],[],[],[5,3,1],[],[],[],[2,5,8,2,1,5],[],[],[2,4,0],[3,2,4],[],[0,9,1,8,10,5,8,11,10],[3,4,0,3,10,4],[5,8,10,8,11,10],[],[3,5,7],[7,1,5],[1,7,3,1,5,7],[],[9,2,0,9,7,2],[0,3,8,1,7,11,1,5,7],[11,1,7,1,5,7],[],[9,1,0,5,3,2,5,7,3],[8,2,5,8,0,2],[2,5,3,5,7,3],[3,9,1,3,8,9,7,11,10,7,10,5],[9,1,0,10,7,11,10,5,7],[3,8,0,7,10,5,7,11,10],[11,5,7,11,10,5],[],[],[],[],[],[0,6,2],[],[7,2,9,7,9,8],[],[],[],[8,10,9],[7,1,3],[7,1,0],[6,9,3,6,10,9],[7,10,8,10,9,8],[],[6,0,4],[],[11,1,4,11,3,1],[2,4,6],[2,0,4,2,4,6],[2,4,6],[1,4,2,4,6,2],[],[6,0,4],[],[2,11,3,6,9,4,6,10,9],[8,6,1,8,1,3],[10,0,6,0,4,6],[8,0,3,9,6,10,9,4,6],[10,4,6,10,9,4],[],[],[],[5,3,1],[],[0,6,2],[],[7,4,8,5,2,1,5,6,2],[],[],[2,4,0],[7,4,8,2,11,3,10,5,6],[7,1,3],[5,6,10,0,9,1,8,7,4],[5,6,10,7,0,3,7,4,0],[10,5,6,4,8,7],[9,11,8],[3,5,6],[0,5,11,0,11,8],[6,3,5,3,1,5],[3,9,6,3,8,9],[9,6,0,6,2,0],[0,3,8,2,5,6,2,1,5],[1,6,2,1,5,6],[9,11,8],[1,0,9,6,10,5,11,3,2],[6,10,5,2,8,0,2,11,8],[3,2,11,10,5,6],[10,5,6,9,3,8,9,1,3],[0,9,1,5,6,10],[8,0,3,10,5,6],[10,5,6],[],[],[],[],[],[],[],[1,10,2,9,11,6,9,8,11],[],[],[6,0,2],[3,6,9,3,2,6],[3,5,1],[0,5,1,0,11,5],[0,3,5],[6,9,11,9,8,11],[],[],[],[4,5,9,7,1,10,7,3,1],[],[11,6,7,2,4,5,2,0,4],[11,6,7,8,0,3,1,10,2,9,4,5],[6,7,11,1,10,2,9,4,5],[],[4,1,0,4,5,1,6,7,3,6,3,2],[9,4,5,0,6,7,0,2,6],[4,5,9,6,3,2,6,7,3],[6,7,11,5,3,8,5,1,3],[6,7,11,4,1,0,4,5,1],[4,5,9,3,8,0,11,6,7],[9,4,5,7,11,6],[],[],[0,6,4],[8,6,4,8,1,6],[],[0,10,2,0,9,10,4,8,11,4,11,6],[10,2,1,6,0,3,6,4,0],[10,2,1,11,4,8,11,6,4],[4,2,6],[1,0,9,2,4,8,2,6,4],[2,4,0,2,6,4],[8,2,4,2,6,4],[11,4,1,11,6,4],[0,9,1,4,11,6,4,8,11],[3,6,0,6,4,0],[8,6,4,8,11,6],[10,8,9],[6,3,9,6,7,3],[6,7,1],[10,7,1,7,3,1],[7,11,6,8,10,2,8,9,10],[11,6,7,10,0,9,10,2,0],[2,1,10,7,11,6,8,0,3],[1,10,2,6,7,11],[7,2,6,7,9,2],[1,0,9,3,6,7,3,2,6],[7,0,6,0,2,6],[2,7,3,2,6,7],[7,11,6,3,9,1,3,8,9],[9,1,0,11,6,7],[0,3,8,11,6,7],[11,6,7],[],[],[],[],[5,3,7],[8,5,2,8,7,5],[5,3,7],[1,10,2,5,8,7,5,9,8],[1,7,5],[1,7,5],[9,2,7,9,7,5],[11,3,2,8,5,9,8,7,5],[1,3,7,1,7,5],[0,7,1,7,5,1],[9,3,5,3,7,5],[9,7,5,9,8,7],[8,10,11],[3,4,10,3,10,11],[8,10,11],[5,9,4,1,11,3,1,10,11],[2,4,5],[5,2,4,2,0,4],[0,3,8,5,9,4,10,2,1],[2,1,10,9,4,5],[2,8,5,2,11,8],[3,2,11,1,4,5,1,0,4],[9,4,5,8,2,11,8,0,2],[11,3,2,9,4,5],[8,5,3,5,1,3],[5,0,4,5,1,0],[3,8,0,4,5,9],[9,4,5],[11,9,10],[11,9,10],[1,11,4,1,10,11],[8,7,4,11,1,10,11,3,1],[2,7,9,2,9,10],[4,8,7,0,10,2,0,9,10],[2,1,10,0,7,4,0,3,7],[10,2,1,8,7,4],[1,7,4],[3,2,11,4,8,7,9,1,0],[11,4,2,4,0,2],[2,11,3,7,4,8],[4,1,7,1,3,7],[1,0,9,8,7,4],[3,4,0,3,7,4],[8,7,4],[8,9,10,8,10,11],[3,9,11,9,10,11],[0,10,8,10,11,8],[10,3,1,10,11,3],[2,8,10,8,9,10],[9,2,0,9,10,2],[8,0,3,1,10,2],[10,2,1],[1,11,9,11,8,9],[11,3,2,0,9,1],[11,0,2,11,8,0],[11,3,2],[8,1,3,8,9,1],[9,1,0],[8,0,3],[]],edgeTable2=[0,265,515,778,2060,2309,2575,2822,1030,1295,1541,1804,3082,3331,3593,3840,400,153,915,666,2460,2197,2975,2710,1430,1183,1941,1692,3482,3219,3993,3728,560,825,51,314,2620,2869,2111,2358,1590,1855,1077,1340,3642,3891,3129,3376,928,681,419,170,2988,2725,2479,2214,1958,1711,1445,1196,4010,3747,3497,3232,2240,2505,2755,3018,204,453,719,966,3270,3535,3781,4044,1226,1475,1737,1984,2384,2137,2899,2650,348,85,863,598,3414,3167,3925,3676,1370,1107,1881,1616,2800,3065,2291,2554,764,1013,255,502,3830,4095,3317,3580,1786,2035,1273,1520,2912,2665,2403,2154,876,613,367,102,3942,3695,3429,3180,1898,1635,1385,1120,1120,1385,1635,1898,3180,3429,3695,3942,102,367,613,876,2154,2403,2665,2912,1520,1273,2035,1786,3580,3317,4095,3830,502,255,1013,764,2554,2291,3065,2800,1616,1881,1107,1370,3676,3925,3167,3414,598,863,85,348,2650,2899,2137,2384,1984,1737,1475,1226,4044,3781,3535,3270,966,719,453,204,3018,2755,2505,2240,3232,3497,3747,4010,1196,1445,1711,1958,2214,2479,2725,2988,170,419,681,928,3376,3129,3891,3642,1340,1077,1855,1590,2358,2111,2869,2620,314,51,825,560,3728,3993,3219,3482,1692,1941,1183,1430,2710,2975,2197,2460,666,915,153,400,3840,3593,3331,3082,1804,1541,1295,1030,2822,2575,2309,2060,778,515,265,0],triTable2=[[],[8,3,0],[9,0,1],[8,3,1,8,1,9],[11,2,3],[11,2,0,11,0,8],[11,2,3,0,1,9],[2,1,11,1,9,11,11,9,8],[10,1,2],[8,3,0,1,2,10],[9,0,2,9,2,10],[3,2,8,2,10,8,8,10,9],[10,1,3,10,3,11],[1,0,10,0,8,10,10,8,11],[0,3,9,3,11,9,9,11,10],[8,10,9,8,11,10],[8,4,7],[3,0,4,3,4,7],[1,9,0,8,4,7],[9,4,1,4,7,1,1,7,3],[2,3,11,7,8,4],[7,11,4,11,2,4,4,2,0],[3,11,2,4,7,8,9,0,1],[2,7,11,2,1,7,1,4,7,1,9,4],[10,1,2,8,4,7],[2,10,1,0,4,7,0,7,3],[4,7,8,0,2,10,0,10,9],[2,7,3,2,9,7,7,9,4,2,10,9],[8,4,7,11,10,1,11,1,3],[11,4,7,1,4,11,1,11,10,1,0,4],[3,8,0,7,11,4,11,9,4,11,10,9],[7,11,4,4,11,9,11,10,9],[9,5,4],[3,0,8,4,9,5],[5,4,0,5,0,1],[4,8,5,8,3,5,5,3,1],[11,2,3,9,5,4],[9,5,4,8,11,2,8,2,0],[3,11,2,1,5,4,1,4,0],[8,5,4,2,5,8,2,8,11,2,1,5],[2,10,1,9,5,4],[0,8,3,5,4,9,10,1,2],[10,5,2,5,4,2,2,4,0],[3,4,8,3,2,4,2,5,4,2,10,5],[5,4,9,1,3,11,1,11,10],[0,9,1,4,8,5,8,10,5,8,11,10],[3,4,0,3,10,4,4,10,5,3,11,10],[4,8,5,5,8,10,8,11,10],[9,5,7,9,7,8],[0,9,3,9,5,3,3,5,7],[8,0,7,0,1,7,7,1,5],[1,7,3,1,5,7],[11,2,3,8,9,5,8,5,7],[9,2,0,9,7,2,2,7,11,9,5,7],[0,3,8,2,1,11,1,7,11,1,5,7],[2,1,11,11,1,7,1,5,7],[1,2,10,5,7,8,5,8,9],[9,1,0,10,5,2,5,3,2,5,7,3],[5,2,10,8,2,5,8,5,7,8,0,2],[10,5,2,2,5,3,5,7,3],[3,9,1,3,8,9,7,11,10,7,10,5],[9,1,0,10,7,11,10,5,7],[3,8,0,7,10,5,7,11,10],[11,5,7,11,10,5],[11,7,6],[0,8,3,11,7,6],[9,0,1,11,7,6],[7,6,11,3,1,9,3,9,8],[2,3,7,2,7,6],[8,7,0,7,6,0,0,6,2],[1,9,0,3,7,6,3,6,2],[7,6,2,7,2,9,2,1,9,7,9,8],[1,2,10,6,11,7],[2,10,1,7,6,11,8,3,0],[11,7,6,10,9,0,10,0,2],[7,6,11,3,2,8,8,2,10,8,10,9],[6,10,7,10,1,7,7,1,3],[6,10,1,6,1,7,7,1,0,7,0,8],[9,0,3,6,9,3,6,10,9,6,3,7],[6,10,7,7,10,8,10,9,8],[8,4,6,8,6,11],[11,3,6,3,0,6,6,0,4],[0,1,9,4,6,11,4,11,8],[1,9,4,11,1,4,11,3,1,11,4,6],[3,8,2,8,4,2,2,4,6],[2,0,4,2,4,6],[1,9,0,3,8,2,2,8,4,2,4,6],[9,4,1,1,4,2,4,6,2],[10,1,2,11,8,4,11,4,6],[10,1,2,11,3,6,6,3,0,6,0,4],[0,2,10,0,10,9,4,11,8,4,6,11],[2,11,3,6,9,4,6,10,9],[8,4,6,8,6,1,6,10,1,8,1,3],[1,0,10,10,0,6,0,4,6],[8,0,3,9,6,10,9,4,6],[10,4,6,10,9,4],[9,5,4,7,6,11],[4,9,5,3,0,8,11,7,6],[6,11,7,4,0,1,4,1,5],[6,11,7,4,8,5,5,8,3,5,3,1],[4,9,5,6,2,3,6,3,7],[9,5,4,8,7,0,0,7,6,0,6,2],[4,0,1,4,1,5,6,3,7,6,2,3],[7,4,8,5,2,1,5,6,2],[6,11,7,1,2,10,9,5,4],[11,7,6,8,3,0,1,2,10,9,5,4],[11,7,6,10,5,2,2,5,4,2,4,0],[7,4,8,2,11,3,10,5,6],[4,9,5,6,10,7,7,10,1,7,1,3],[5,6,10,0,9,1,8,7,4],[5,6,10,7,0,3,7,4,0],[10,5,6,4,8,7],[5,6,9,6,11,9,9,11,8],[0,9,5,0,5,3,3,5,6,3,6,11],[0,1,5,0,5,11,5,6,11,0,11,8],[11,3,6,6,3,5,3,1,5],[9,5,6,3,9,6,3,8,9,3,6,2],[5,6,9,9,6,0,6,2,0],[0,3,8,2,5,6,2,1,5],[1,6,2,1,5,6],[1,2,10,5,6,9,9,6,11,9,11,8],[1,0,9,6,10,5,11,3,2],[6,10,5,2,8,0,2,11,8],[3,2,11,10,5,6],[10,5,6,9,3,8,9,1,3],[0,9,1,5,6,10],[8,0,3,10,5,6],[10,5,6],[10,6,5],[8,3,0,10,6,5],[0,1,9,5,10,6],[10,6,5,9,8,3,9,3,1],[3,11,2,10,6,5],[6,5,10,2,0,8,2,8,11],[1,9,0,6,5,10,11,2,3],[1,10,2,5,9,6,9,11,6,9,8,11],[1,2,6,1,6,5],[0,8,3,2,6,5,2,5,1],[5,9,6,9,0,6,6,0,2],[9,6,5,3,6,9,3,9,8,3,2,6],[11,6,3,6,5,3,3,5,1],[0,5,1,0,11,5,5,11,6,0,8,11],[0,5,9,0,3,5,3,6,5,3,11,6],[5,9,6,6,9,11,9,8,11],[10,6,5,4,7,8],[5,10,6,7,3,0,7,0,4],[5,10,6,0,1,9,8,4,7],[4,5,9,6,7,10,7,1,10,7,3,1],[7,8,4,2,3,11,10,6,5],[11,6,7,10,2,5,2,4,5,2,0,4],[11,6,7,8,0,3,1,10,2,9,4,5],[6,7,11,1,10,2,9,4,5],[7,8,4,5,1,2,5,2,6],[4,1,0,4,5,1,6,7,3,6,3,2],[9,4,5,8,0,7,0,6,7,0,2,6],[4,5,9,6,3,2,6,7,3],[6,7,11,4,5,8,5,3,8,5,1,3],[6,7,11,4,1,0,4,5,1],[4,5,9,3,8,0,11,6,7],[9,4,5,7,11,6],[10,6,4,10,4,9],[8,3,0,9,10,6,9,6,4],[1,10,0,10,6,0,0,6,4],[8,6,4,8,1,6,6,1,10,8,3,1],[2,3,11,6,4,9,6,9,10],[0,10,2,0,9,10,4,8,11,4,11,6],[10,2,1,11,6,3,6,0,3,6,4,0],[10,2,1,11,4,8,11,6,4],[9,1,4,1,2,4,4,2,6],[1,0,9,3,2,8,2,4,8,2,6,4],[2,4,0,2,6,4],[3,2,8,8,2,4,2,6,4],[1,4,9,11,4,1,11,1,3,11,6,4],[0,9,1,4,11,6,4,8,11],[11,6,3,3,6,0,6,4,0],[8,6,4,8,11,6],[6,7,10,7,8,10,10,8,9],[9,3,0,6,3,9,6,9,10,6,7,3],[6,1,10,6,7,1,7,0,1,7,8,0],[6,7,10,10,7,1,7,3,1],[7,11,6,3,8,2,8,10,2,8,9,10],[11,6,7,10,0,9,10,2,0],[2,1,10,7,11,6,8,0,3],[1,10,2,6,7,11],[7,2,6,7,9,2,2,9,1,7,8,9],[1,0,9,3,6,7,3,2,6],[8,0,7,7,0,6,0,2,6],[2,7,3,2,6,7],[7,11,6,3,9,1,3,8,9],[9,1,0,11,6,7],[0,3,8,11,6,7],[11,6,7],[11,7,5,11,5,10],[3,0,8,7,5,10,7,10,11],[9,0,1,10,11,7,10,7,5],[3,1,9,3,9,8,7,10,11,7,5,10],[10,2,5,2,3,5,5,3,7],[5,10,2,8,5,2,8,7,5,8,2,0],[9,0,1,10,2,5,5,2,3,5,3,7],[1,10,2,5,8,7,5,9,8],[2,11,1,11,7,1,1,7,5],[0,8,3,2,11,1,1,11,7,1,7,5],[9,0,2,9,2,7,2,11,7,9,7,5],[11,3,2,8,5,9,8,7,5],[1,3,7,1,7,5],[8,7,0,0,7,1,7,5,1],[0,3,9,9,3,5,3,7,5],[9,7,5,9,8,7],[4,5,8,5,10,8,8,10,11],[3,0,4,3,4,10,4,5,10,3,10,11],[0,1,9,4,5,8,8,5,10,8,10,11],[5,9,4,1,11,3,1,10,11],[3,8,4,3,4,2,2,4,5,2,5,10],[10,2,5,5,2,4,2,0,4],[0,3,8,5,9,4,10,2,1],[2,1,10,9,4,5],[8,4,5,2,8,5,2,11,8,2,5,1],[3,2,11,1,4,5,1,0,4],[9,4,5,8,2,11,8,0,2],[11,3,2,9,4,5],[4,5,8,8,5,3,5,1,3],[5,0,4,5,1,0],[3,8,0,4,5,9],[9,4,5],[7,4,11,4,9,11,11,9,10],[3,0,8,7,4,11,11,4,9,11,9,10],[11,7,4,1,11,4,1,10,11,1,4,0],[8,7,4,11,1,10,11,3,1],[2,3,7,2,7,9,7,4,9,2,9,10],[4,8,7,0,10,2,0,9,10],[2,1,10,0,7,4,0,3,7],[10,2,1,8,7,4],[2,11,7,2,7,1,1,7,4,1,4,9],[3,2,11,4,8,7,9,1,0],[7,4,11,11,4,2,4,0,2],[2,11,3,7,4,8],[9,1,4,4,1,7,1,3,7],[1,0,9,8,7,4],[3,4,0,3,7,4],[8,7,4],[8,9,10,8,10,11],[0,9,3,3,9,11,9,10,11],[1,10,0,0,10,8,10,11,8],[10,3,1,10,11,3],[3,8,2,2,8,10,8,9,10],[9,2,0,9,10,2],[8,0,3,1,10,2],[10,2,1],[2,11,1,1,11,9,11,8,9],[11,3,2,0,9,1],[11,0,2,11,8,0],[11,3,2],[8,1,3,8,9,1],[9,1,0],[8,0,3],[]];return my}();var WebMol=WebMol||{};WebMol.partialCharges=[{resn:"ALA",atom:"N",props:{partialCharge:-.15}},{resn:"ALA",atom:"CA",props:{partialCharge:.1}},{resn:"ALA",atom:"CB",props:{partialCharge:0}},{resn:"ALA",atom:"C",props:{partialCharge:.6}},{resn:"ALA",atom:"O",props:{partialCharge:-.55}},{resn:"ARG",atom:"N",props:{partialCharge:-.15}},{resn:"ARG",atom:"CA",props:{partialCharge:.1}},{resn:"ARG",atom:"CB",props:{partialCharge:0}},{resn:"ARG",atom:"CG",props:{partialCharge:0}},{resn:"ARG",atom:"CD",props:{partialCharge:.1}},{resn:"ARG",atom:"NE",props:{partialCharge:-.1}},{resn:"ARG",atom:"CZ",props:{partialCharge:.5}},{resn:"ARG",atom:"NH1",props:{partialCharge:.25}},{resn:"ARG",atom:"NH2",props:{partialCharge:.25}},{resn:"ARG",atom:"C",props:{partialCharge:.6}},{resn:"ARG",atom:"O",props:{partialCharge:-.55}},{resn:"ASN",atom:"N",props:{partialCharge:-.15}},{resn:"ASN",atom:"CA",props:{partialCharge:.1}},{resn:"ASN",atom:"CB",props:{partialCharge:0}},{resn:"ASN",atom:"CG",props:{partialCharge:.55}},{resn:"ASN",atom:"OD1",props:{partialCharge:-.55}},{resn:"ASN",atom:"ND2",props:{partialCharge:0}},{resn:"ASN",atom:"C",props:{partialCharge:.6}},{resn:"ASN",atom:"O",props:{partialCharge:-.55}},{resn:"ASP",atom:"N",props:{partialCharge:-.15}},{resn:"ASP",atom:"CA",props:{partialCharge:.1}},{resn:"ASP",atom:"CB",props:{partialCharge:0}},{resn:"ASP",atom:"CG",props:{partialCharge:.14}},{resn:"ASP",atom:"OD1",props:{partialCharge:-.57}},{resn:"ASP",atom:"OD2",props:{partialCharge:-.57}},{resn:"ASP",atom:"C",props:{partialCharge:.6}},{resn:"ASP",atom:"O",props:{partialCharge:-.55}},{resn:"CYS",atom:"N",props:{partialCharge:-.15}},{resn:"CYS",atom:"CA",props:{partialCharge:.1}},{resn:"CYS",atom:"CB",props:{partialCharge:.19}},{resn:"CYS",atom:"SG",props:{partialCharge:-.19}},{resn:"CYS",atom:"C",props:{partialCharge:.6}},{resn:"CYS",atom:"O",props:{partialCharge:-.55}},{resn:"GLN",atom:"N",props:{partialCharge:-.15}},{resn:"GLN",atom:"CA",props:{partialCharge:.1}},{resn:"GLN",atom:"CB",props:{partialCharge:0}},{resn:"GLN",atom:"CG",props:{partialCharge:0}},{resn:"GLN",atom:"CD",props:{partialCharge:.55}},{resn:"GLN",atom:"OE1",props:{partialCharge:-.55}},{resn:"GLN",atom:"NE2",props:{partialCharge:0}},{resn:"GLN",atom:"C",props:{partialCharge:.6}},{resn:"GLN",atom:"O",props:{partialCharge:-.55}},{resn:"GLU",atom:"N",props:{partialCharge:-.15}},{resn:"GLU",atom:"CA",props:{partialCharge:.1}},{resn:"GLU",atom:"CB",props:{partialCharge:0}},{resn:"GLU",atom:"CG",props:{partialCharge:0}},{resn:"GLU",atom:"CD",props:{partialCharge:.14}},{resn:"GLU",atom:"OE1",props:{partialCharge:-.57}},{resn:"GLU",atom:"OE2",props:{partialCharge:-.57}},{resn:"GLU",atom:"C",props:{partialCharge:.6}},{resn:"GLU",atom:"O",props:{partialCharge:-.55}},{resn:"GLY",atom:"N",props:{partialCharge:-.15}},{resn:"GLY",atom:"CA",props:{partialCharge:.1}},{resn:"GLY",atom:"C",props:{partialCharge:.6}},{resn:"GLY",atom:"O",props:{partialCharge:-.55}},{resn:"HIS",atom:"N",props:{partialCharge:-.15}},{resn:"HIS",atom:"CA",props:{partialCharge:.1}},{resn:"HIS",atom:"CB",props:{partialCharge:0}},{resn:"HIS",atom:"CG",props:{partialCharge:.1}},{resn:"HIS",atom:"ND1",props:{partialCharge:-.1}},{resn:"HIS",atom:"CD2",props:{partialCharge:.1}},{resn:"HIS",atom:"NE2",props:{partialCharge:-.4}},{resn:"HIS",atom:"CE1",props:{partialCharge:.3}},{resn:"HIS",atom:"C",props:{partialCharge:.6}},{resn:"HIS",atom:"O",props:{partialCharge:-.55}},{resn:"ILE",atom:"N",props:{partialCharge:-.15}},{resn:"ILE",atom:"CA",props:{partialCharge:.1}},{resn:"ILE",atom:"CB",props:{partialCharge:0}},{resn:"ILE",atom:"CG2",props:{partialCharge:0}},{resn:"ILE",atom:"CG1",props:{partialCharge:0}},{resn:"ILE",atom:"CD",props:{partialCharge:0}},{resn:"ILE",atom:"C",props:{partialCharge:.6}},{resn:"ILE",atom:"O",props:{partialCharge:-.55}},{resn:"LEU",atom:"N",props:{partialCharge:-.15}},{resn:"LEU",atom:"CA",props:{partialCharge:.1}},{resn:"LEU",atom:"CB",props:{partialCharge:0}},{resn:"LEU",atom:"CG",props:{partialCharge:0}},{resn:"LEU",atom:"CD1",props:{partialCharge:0}},{resn:"LEU",atom:"CD2",props:{partialCharge:0}},{resn:"LEU",atom:"C",props:{partialCharge:.6}},{resn:"LEU",atom:"O",props:{partialCharge:-.55}},{resn:"LYS",atom:"N",props:{partialCharge:-.15}},{resn:"LYS",atom:"CA",props:{partialCharge:.1}},{resn:"LYS",atom:"CB",props:{partialCharge:0}},{resn:"LYS",atom:"CG",props:{partialCharge:0}},{resn:"LYS",atom:"CD",props:{partialCharge:0}},{resn:"LYS",atom:"CE",props:{partialCharge:.25}},{resn:"LYS",atom:"NZ",props:{partialCharge:.75}},{resn:"LYS",atom:"C",props:{partialCharge:.6}},{resn:"LYS",atom:"O",props:{partialCharge:-.55}},{resn:"MET",atom:"N",props:{partialCharge:-.15}},{resn:"MET",atom:"CA",props:{partialCharge:.1}},{resn:"MET",atom:"CB",props:{partialCharge:0}},{resn:"MET",atom:"CG",props:{partialCharge:.06}},{resn:"MET",atom:"SD",props:{partialCharge:-.12}},{resn:"MET",atom:"CE",props:{partialCharge:.06}},{resn:"MET",atom:"C",props:{partialCharge:.6}},{resn:"MET",atom:"O",props:{partialCharge:-.55}},{resn:"PHE",atom:"N",props:{partialCharge:-.15}},{resn:"PHE",atom:"CA",props:{partialCharge:.1}},{resn:"PHE",atom:"CB",props:{partialCharge:0}},{resn:"PHE",atom:"CG",props:{partialCharge:0}},{resn:"PHE",atom:"CD1",props:{partialCharge:0}},{resn:"PHE",atom:"CD2",props:{partialCharge:0}},{resn:"PHE",atom:"CE1",props:{partialCharge:0}},{resn:"PHE",atom:"CE2",props:{partialCharge:0}},{resn:"PHE",atom:"CZ",props:{partialCharge:0}},{resn:"PHE",atom:"C",props:{partialCharge:.6}},{resn:"PHE",atom:"O",props:{partialCharge:-.55}},{resn:"PRO",atom:"N",props:{partialCharge:-.25}},{resn:"PRO",atom:"CD",props:{partialCharge:.1}},{resn:"PRO",atom:"CA",props:{partialCharge:.1}},{resn:"PRO",atom:"CB",props:{partialCharge:0}},{resn:"PRO",atom:"CG",props:{partialCharge:0}},{resn:"PRO",atom:"C",props:{partialCharge:.6}},{resn:"PRO",atom:"O",props:{partialCharge:-.55}},{resn:"SER",atom:"N",props:{partialCharge:-.15}},{resn:"SER",atom:"CA",props:{partialCharge:.1}},{resn:"SER",atom:"CB",props:{partialCharge:.25}},{resn:"SER",atom:"OG",props:{partialCharge:-.25}},{resn:"SER",atom:"C",props:{partialCharge:.6}},{resn:"SER",atom:"O",props:{partialCharge:-.55}},{resn:"THR",atom:"N",props:{partialCharge:-.15}},{resn:"THR",atom:"CA",props:{partialCharge:.1}},{resn:"THR",atom:"CB",props:{partialCharge:.25}},{resn:"THR",atom:"OG1",props:{partialCharge:-.25}},{resn:"THR",atom:"CG2",props:{partialCharge:0}},{resn:"THR",atom:"C",props:{partialCharge:.6}},{resn:"THR",atom:"O",props:{partialCharge:-.55}},{resn:"TRP",atom:"N",props:{partialCharge:-.15}},{resn:"TRP",atom:"CA",props:{partialCharge:.1}},{resn:"TRP",atom:"CB",props:{partialCharge:0}},{resn:"TRP",atom:"CG",props:{partialCharge:-.03}},{resn:"TRP",atom:"CD2",props:{partialCharge:.1}},{resn:"TRP",atom:"CE2",props:{partialCharge:-.04}},{resn:"TRP",atom:"CE3",props:{partialCharge:-.03}},{resn:"TRP",atom:"CD1",props:{partialCharge:.06}},{resn:"TRP",atom:"NE1",props:{partialCharge:-.06}},{resn:"TRP",atom:"CZ2",props:{partialCharge:0}},{resn:"TRP",atom:"CZ3",props:{partialCharge:0}},{resn:"TRP",atom:"CH2",props:{partialCharge:0}},{resn:"TRP",atom:"C",props:{partialCharge:.6}},{resn:"TRP",atom:"O",props:{partialCharge:-.55}},{resn:"TYR",atom:"N",props:{partialCharge:-.15}},{resn:"TYR",atom:"CA",props:{partialCharge:.1}},{resn:"TYR",atom:"CB",props:{partialCharge:0}},{resn:"TYR",atom:"CG",props:{partialCharge:0}},{resn:"TYR",atom:"CD1",props:{partialCharge:0}},{resn:"TYR",atom:"CE1",props:{partialCharge:0}},{resn:"TYR",atom:"CD2",props:{partialCharge:0}},{resn:"TYR",atom:"CE2",props:{partialCharge:0}},{resn:"TYR",atom:"CZ",props:{partialCharge:.25}},{resn:"TYR",atom:"OH",props:{partialCharge:-.25}},{resn:"TYR",atom:"C",props:{partialCharge:.6}},{resn:"TYR",atom:"O",props:{partialCharge:-.55}},{resn:"VAL",atom:"N",props:{partialCharge:-.15}},{resn:"VAL",atom:"CA",props:{partialCharge:.1}},{resn:"VAL",atom:"CB",props:{partialCharge:0}},{resn:"VAL",atom:"CG1",props:{partialCharge:0}},{resn:"VAL",atom:"CG2",props:{partialCharge:0}},{resn:"VAL",atom:"C",props:{partialCharge:.6}},{resn:"VAL",atom:"O",props:{partialCharge:-.55}}];